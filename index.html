<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash or Pass - Cesaris Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        /* Menu Laterale */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .sidebar-nav {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 10px;
        }
        
        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #2a5298;
            color: white;
        }
        
        .sidebar-nav i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a5298;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .cesaris {
            color: #FFD700;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }

        /* Stili per i passaggi di upload */
        .upload-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .step.active .step-number {
            background: #2a5298;
        }
        
        .step.completed .step-number {
            background: #4CAF50;
        }
        
        .step-content {
            display: none;
            text-align: center;
        }
        
        .step-content.active {
            display: block;
        }
        
        .gender-selection {
            margin: 20px 0;
        }
        
        .gender-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .gender-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .gender-btn.male.active {
            background: #1e3c72;
            border-color: #1e3c72;
        }
        
        .gender-btn.female.active {
            background: #FFD700;
            color: #333;
            border-color: #FFD700;
        }
        
        .upload-area {
            border: 2px dashed #2a5298;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #f8f9ff;
        }
        
        .upload-area i {
            font-size: 48px;
            color: #2a5298;
            margin-bottom: 15px;
        }
        
        .preview-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: #2a5298;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1e3c72;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ddd;
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        #fileInput {
            display: none;
        }
        
        /* Stili per la votazione */
        .voting-interface {
            text-align: center;
        }
        
        .gender-selection-vote {
            margin: 20px 0;
        }
        
        .photo-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .current-photo {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
        }
        
        .vote-buttons-single {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .smash-btn-single, .pass-btn-single {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .smash-btn-single {
            background: #4CAF50;
            color: white;
        }
        
        .smash-btn-single:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .pass-btn-single {
            background: #f44336;
            color: white;
        }
        
        .pass-btn-single:hover {
            background: #da190b;
            transform: scale(1.05);
        }
        
        .progress-container-single {
            margin: 20px auto;
            max-width: 400px;
        }
        
        .progress-bar-single {
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-fill.smash {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .progress-fill.pass {
            background: linear-gradient(90deg, #f44336, #ff9800);
        }
        
        .stats-single {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .smash-stat {
            color: #4CAF50;
        }
        
        .pass-stat {
            color: #f44336;
        }
        
        /* Stili per la cronologia */
        .vote-history {
            margin-top: 30px;
            text-align: left;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .history-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .history-info {
            flex-grow: 1;
        }
        
        .history-vote {
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
        }
        
        .history-vote.smash {
            background: #4CAF50;
            color: white;
        }
        
        .history-vote.pass {
            background: #f44336;
            color: white;
        }
        
        .change-vote-btn {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }
        
        .no-photos {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #2a5298;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .history-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .history-filter {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        /* Stili per la classifica */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
            color: #2a5298;
            min-width: 30px;
            text-align: center;
        }
        
        .leaderboard-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .leaderboard-info {
            flex-grow: 1;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #4CAF50;
            margin-right: 10px;
        }
        
        .info-btn {
            background: #2a5298;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Stili per i modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Stili per gli achievement */
        .achievement-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .achievement-info {
            flex-grow: 1;
        }
        
        .achievement-locked {
            opacity: 0.5;
        }
        
        /* Stili per le animazioni */
        .smash-effect {
            animation: smashPulse 0.6s ease;
        }
        
        .pass-effect {
            animation: passSlide 0.6s ease;
        }
        
        @keyframes smashPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes passSlide {
            0% { transform: translateX(0); }
            50% { transform: translateX(-20px); }
            100% { transform: translateX(0); }
        }
        
        /* Stili per il sistema di report */
        .report-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .report-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .report-approved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .report-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Stili per le notifiche in tempo reale */
        .live-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .live-stat {
            text-align: center;
        }
        
        .live-stat-number {
            font-size: 24px;
            font-weight: bold;
        }
        
        .live-stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* Stili per l'admin panel */
        .admin-panel {
            margin-top: 30px;
        }
        
        .reported-photo {
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fff9e6;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .admin-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .approve-btn {
            background: #4CAF50;
            color: white;
        }
        
        .reject-btn {
            background: #f44336;
            color: white;
        }
        
        .suspended-badge {
            background: #ff9800;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .report-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .gender-btn {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 130px;
                margin: 5px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .preview-image {
                max-width: 100%;
                max-height: 300px;
            }
            
            .photo-container {
                max-width: 100%;
            }
            
            .current-photo {
                height: 400px;
            }
            
            .vote-buttons-single {
                gap: 10px;
            }
            
            .smash-btn-single, .pass-btn-single {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
                margin: 5px 0;
            }
            
            .history-item {
                flex-direction: column;
                text-align: center;
            }
            
            .history-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .leaderboard-item {
                flex-direction: column;
                text-align: center;
            }
            
            .leaderboard-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .live-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .sidebar {
                width: 280px;
                left: -280px;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        .notification.info {
            background: #2196F3;
        }

        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .no-context-menu {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .debug-info {
            background: #f8f9fa;
            border-left: 4px solid #2a5298;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .settings-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .logout-btn {
            margin-top: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="no-select no-context-menu" oncontextmenu="return false;">
    <!-- Menu Laterale -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigazione</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
        </div>
        <ul class="sidebar-nav">
            <li><a href="#" onclick="switchTab('upload')" class="nav-link active" data-tab="upload">üì§ Carica Foto</a></li>
            <li><a href="#" onclick="switchTab('vote')" class="nav-link" data-tab="vote">üó≥Ô∏è Vota Foto</a></li>
            <li><a href="#" onclick="switchTab('history')" class="nav-link" data-tab="history">üìä Cronologia</a></li>
            <li><a href="#" onclick="switchTab('leaderboard')" class="nav-link" data-tab="leaderboard">üèÜ Classifica</a></li>
            <li><a href="#" onclick="switchTab('achievements')" class="nav-link" data-tab="achievements">üéØ Achievement</a></li>
            <li><a href="#" onclick="switchTab('moderation')" class="nav-link" data-tab="moderation">üõ°Ô∏è Moderazione</a></li>
            <li><a href="#" onclick="switchTab('settings')" class="nav-link" data-tab="settings">‚öôÔ∏è Impostazioni</a></li>
        </ul>
    </div>
    
    <!-- Overlay per chiudere il menu -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Bottone per aprire il menu -->
    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    
    <div class="container">
        <header>
            <h1>Smash or Pass <span class="cesaris">Cesaris Edition</span></h1>
            <p>Carica la tua foto anonimamente e vota le foto degli altri!</p>
        </header>
        
        <!-- Contenuto delle tabs -->
        <div class="tab-content active" id="upload-tab">
            <!-- Indicatore dei passaggi -->
            <div class="upload-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div>Scegli Genere</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div>Carica Foto</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div>Conferma</div>
                </div>
            </div>
            
            <!-- Passaggio 1: Scelta genere -->
            <div class="step-content active" id="step1-content">
                <h3>Step 1: Seleziona il genere</h3>
                <p>Scegli se stai caricando una foto di un ragazzo o una ragazza</p>
                
                <div class="gender-selection">
                    <button class="gender-btn male" data-gender="male" id="maleBtn">
                        üë¶ Ragazzo
                    </button>
                    <button class="gender-btn female" data-gender="female" id="femaleBtn">
                        üëß Ragazza
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="goToStep(2)" id="nextToStep2" disabled>
                        Avanti
                    </button>
                </div>
            </div>
            
            <!-- Passaggio 2: Caricamento foto -->
            <div class="step-content" id="step2-content">
                <h3>Step 2: Carica la tua foto</h3>
                <p id="selected-gender-text">Stai caricando una foto di: <strong id="current-gender"></strong></p>
                
                <div class="upload-area" id="uploadArea">
                    <i>üì∑</i>
                    <h3>Clicca qui per selezionare una foto</h3>
                    <p>Oppure trascina il file qui</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">Dimensione massima: 5MB</p>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <div class="preview-container">
                    <img id="previewImage" class="preview-image" alt="Anteprima" style="display: none;">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        Indietro
                    </button>
                    <button class="btn btn-primary" onclick="goToStep(3)" id="nextToStep3" disabled>
                        Avanti
                    </button>
                </div>
            </div>
            
            <!-- Passaggio 3: Conferma -->
            <div class="step-content" id="step3-content">
                <h3>Step 3: Conferma il caricamento</h3>
                
                <div class="preview-container">
                    <img id="confirmPreviewImage" class="preview-image" alt="Anteprima conferma">
                </div>
                
                <p><strong>Genere:</strong> <span id="confirm-gender"></span></p>
                <p style="color: #666; margin: 15px 0;">Controlla che tutto sia corretto prima di procedere</p>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">
                        Modifica
                    </button>
                    <button class="btn btn-primary" onclick="uploadPhoto()" id="uploadBtn">
                        üöÄ Carica Foto
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="vote-tab">
            <div class="voting-interface">
                <div class="gender-selection-vote">
                    <h3>Su chi vuoi votare?</h3>
                    <button class="gender-btn male active" data-gender="male" id="voteMaleBtn">
                        üë¶ Ragazzi
                    </button>
                    <button class="gender-btn female" data-gender="female" id="voteFemaleBtn">
                        üëß Ragazze
                    </button>
                </div>
                
                <!-- Statistiche in tempo reale -->
                <div class="live-stats" id="liveStats" style="display: none;">
                    <div class="live-stat">
                        <div class="live-stat-number" id="liveSmash">0</div>
                        <div class="live-stat-label">SMASH</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-number" id="livePass">0</div>
                        <div class="live-stat-label">PASS</div>
                    </div>
                    <div class="live-stat">
                        <div class="live-stat-number" id="liveTotal">0</div>
                        <div class="live-stat-label">TOTALE</div>
                    </div>
                </div>
                
                <div id="singlePhotoView">
                    <div class="loading" id="loadingIndicator">
                        Caricamento foto in corso...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="history-tab">
            <div class="vote-history">
                <div class="history-controls">
                    <h3>La tua cronologia voti</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" onclick="filterHistory('all')">Tutti</button>
                        <button class="filter-btn" onclick="filterHistory('smash')">Smash</button>
                        <button class="filter-btn" onclick="filterHistory('pass')">Pass</button>
                    </div>
                </div>
                
                <div id="historyList">
                    <div class="loading">Caricamento cronologia...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="leaderboard-tab">
            <div class="vote-history">
                <div class="history-controls">
                    <h3>Classifica Foto pi√π Popolari</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" onclick="filterLeaderboard('all')">Tutti</button>
                        <button class="filter-btn" onclick="filterLeaderboard('male')">Ragazzi</button>
                        <button class="filter-btn" onclick="filterLeaderboard('female')">Ragazze</button>
                    </div>
                </div>
                
                <div id="leaderboardList">
                    <div class="loading">Caricamento classifica...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="achievements-tab">
            <div class="vote-history">
                <h3>I Tuoi Achievement</h3>
                <p>Sblocca achievement completando diverse azioni nell'app!</p>
                
                <div id="achievementsList">
                    <div class="loading">Caricamento achievement...</div>
                </div>
            </div>
        </div>
        
        <!-- Tab per moderazione -->
        <div class="tab-content" id="moderation-tab">
            <div class="admin-panel">
                <h2>üõ°Ô∏è Pannello di Moderazione</h2>
                <p>Qui puoi gestire le foto segnalate dagli utenti.</p>
                
                <div class="settings-section">
                    <h3>Foto Segnalate</h3>
                    <div id="reportedPhotosList">
                        <div class="loading">Caricamento foto segnalate...</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Foto Sospese</h3>
                    <p>Foto temporaneamente sospese in attesa di revisione</p>
                    <div id="suspendedPhotosList">
                        <div class="loading">Caricamento foto sospese...</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Statistiche Moderazione</h3>
                    <div id="moderationStats">
                        <div class="loading">Caricamento statistiche...</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary logout-btn" onclick="logoutModeration()">
                        üö™ Esci dalla Moderazione
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="settings-section">
                <h3>Importa/Esporta Dati</h3>
                <p>Salva i tuoi dati locali o importa dati precedenti</p>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="exportData()">
                        üì• Esporta Dati
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        üì§ Importa Dati
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Scorciatoie da Tastiera</h3>
                <p>Usa queste scorciatoie durante la votazione:</p>
                <ul>
                    <li><strong>Freccia Sinistra / A:</strong> Vota PASS</li>
                    <li><strong>Freccia Destra / D:</strong> Vota SMASH</li>
                    <li><strong>Spazio:</strong> Salta foto</li>
                </ul>
            </div>
            
            <div class="settings-section">
                <h3>Informazioni</h3>
                <p>Versione: 2.0</p>
                <p>Foto totali caricate: <span id="totalPhotos">0</span></p>
                <p>Voti totali: <span id="totalVotes">0</span></p>
            </div>
        </div>
    </div>

    <!-- Modal per password moderazione -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Accesso Moderazione</h3>
                <button class="close-modal" onclick="closeModal('passwordModal')">√ó</button>
            </div>
            <div>
                <p>Inserisci la password di moderazione:</p>
                <input type="password" id="moderationPasswordInput" class="password-input" placeholder="Password">
                <p id="attemptsInfo" style="color: #666; font-size: 14px; margin: 10px 0;">
                    Tentativi rimanenti: 3
                </p>
                <button class="btn btn-primary" onclick="handlePasswordSubmit()" style="width: 100%;">
                    Accedi
                </button>
            </div>
        </div>
    </div>

    <!-- Modal per cambio password -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÑ Cambia Password Moderazione</h3>
                <button class="close-modal" onclick="closeModal('changePasswordModal')">√ó</button>
            </div>
            <div>
                <p>Vecchia Password:</p>
                <input type="password" id="oldPasswordInput" class="password-input" placeholder="Vecchia password">
                
                <p>Nuova Password:</p>
                <input type="password" id="newPasswordInput" class="password-input" placeholder="Nuova password">
                
                <p>Conferma Nuova Password:</p>
                <input type="password" id="confirmPasswordInput" class="password-input" placeholder="Conferma password">
                
                <button class="btn btn-primary" onclick="handlePasswordChange()" style="width: 100%; margin-top: 15px;">
                    üîÑ Cambia Password
                </button>
            </div>
        </div>
    </div>

    <!-- Modal per informazioni foto -->
    <div class="modal" id="photoInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Informazioni Foto</h3>
                <button class="close-modal" onclick="closeModal('photoInfoModal')">√ó</button>
            </div>
            <div id="photoInfoContent">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>
    
    <!-- Modal per segnalazione -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Segnala Foto</h3>
                <button class="close-modal" onclick="closeModal('reportModal')">√ó</button>
            </div>
            <div id="reportContent">
                <p>Seleziona il motivo della segnalazione:</p>
                <select id="reportReason" class="password-input" style="width: 100%; margin-bottom: 15px;">
                    <option value="inappropriate">Contenuto inappropriato</option>
                    <option value="sexual">Contenuto sessuale</option>
                    <option value="fake">Foto non reale/falsa</option>
                    <option value="other">Altro</option>
                </select>
                <textarea id="reportDetails" class="password-input" placeholder="Dettagli aggiuntivi (opzionale)" style="width: 100%; height: 100px; margin-bottom: 15px;"></textarea>
                <button class="btn btn-primary" onclick="submitReport()" style="width: 100%;">Invia Segnalazione</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // üî• CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://rreyuxxnyhhahwkjxfiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZXl1eHhueWhoYWh3a2p4Zml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjIyNDgsImV4cCI6MjA3ODU5ODI0OH0.F_ZnqK10o8h-IY23_g9RzkPHqQVbpAvjQmw0awlApBE';
        
        // Inizializza Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variabili globali
        let selectedGender = null;
        let selectedFile = null;
        let currentVoteGender = 'male';
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let voteHistory = JSON.parse(localStorage.getItem('voteHistory') || '{}');
        let currentHistoryFilter = 'all';
        let currentLeaderboardFilter = 'all';
        let achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
        let currentPhotoForReport = null;
        
        // üîê SISTEMA PASSWORD MODERAZIONE
        let moderationAttempts = 3;
        let isModerationAuthenticated = false;
        let lastAttemptTime = 0;
        const ATTEMPT_COOLDOWN = 30000; // 30 secondi

        // Soglia per sospensione automatica
        const REPORT_THRESHOLD = 3;
        
        // Inizializza l'applicazione
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            loadPhotosForVoting();
            loadAchievements();
            loadStats();
        });
        
        // Gestione Menu Laterale
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        function switchTab(tabName) {
            // Chiudi il menu laterale su mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
            
            // Nascondi tutti i tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // üîê GESTIONE ACCESSO MODERAZIONE
            if (tabName === 'moderation') {
                if (!isModerationAuthenticated) {
                    if (moderationAttempts > 0) {
                        showPasswordModal();
                        return;
                    } else {
                        showNotification('Hai esaurito i tentativi di accesso alla moderazione!', true);
                        return;
                    }
                }
            }
            
            // Mostra il tab selezionato
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Aggiorna i link nel menu laterale
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-tab') === tabName) {
                    link.classList.add('active');
                }
            });
            
            // Carica contenuti specifici
            if (tabName === 'vote') {
                loadPhotosForVoting();
            } else if (tabName === 'history') {
                loadVoteHistory();
            } else if (tabName === 'leaderboard') {
                loadLeaderboard();
            } else if (tabName === 'achievements') {
                loadAchievementsDisplay();
            } else if (tabName === 'moderation' && isModerationAuthenticated) {
                loadReportedPhotos();
                loadSuspendedPhotos();
                loadModerationStats();
            } else if (tabName === 'settings') {
                loadStats();
            }
        }
        
        // Inizializza tutti gli event listener
        function initEventListeners() {
            // Gestione selezione genere per upload
            document.getElementById('maleBtn').addEventListener('click', function() {
                selectGender('male');
            });
            
            document.getElementById('femaleBtn').addEventListener('click', function() {
                selectGender('female');
            });
            
            // Gestione selezione genere per votazione
            document.getElementById('voteMaleBtn').addEventListener('click', function() {
                selectVoteGender('male');
            });
            
            document.getElementById('voteFemaleBtn').addEventListener('click', function() {
                selectVoteGender('female');
            });
            
            // Gestione selezione file
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleFileSelection(e.target.files[0]);
                }
            });
            
            // Gestione import file
            document.getElementById('importFile').addEventListener('change', function(e) {
                if (e.target.files.length) {
                    importData(e.target.files[0]);
                }
            });
            
            // Gestione drag and drop
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f4ff';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            
            // Scorciatoie da tastiera
            document.addEventListener('keydown', function(e) {
                // Solo se siamo nella tab di votazione
                if (document.getElementById('vote-tab').classList.contains('active')) {
                    switch(e.key) {
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            voteCurrentPhoto('pass');
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            voteCurrentPhoto('smash');
                            break;
                        case ' ':
                            e.preventDefault();
                            // Salta la foto corrente
                            currentPhotoIndex++;
                            showCurrentPhoto();
                            break;
                    }
                }
            });
        }
        
        // üîê FUNZIONI DI VERIFICA PASSWORD CON SUPABASE
        async function verifyPasswordWithSupabase(password) {
            try {
                console.log('Verifica password in corso...');
                
                // Chiama la funzione PostgreSQL
                const { data, error } = await supabase
                    .rpc('verify_moderation_access', { input_key: password });
                
                if (error) {
                    console.error('Errore Supabase:', error);
                    return false;
                }
                
                console.log('Risposta Supabase:', data);
                return data.valid;
                
            } catch (error) {
                console.error('Errore nella verifica password:', error);
                return false;
            }
        }

        async function checkModerationPassword(inputPassword) {
            const now = Date.now();
            
            // Controlla cooldown
            if (moderationAttempts <= 0 && (now - lastAttemptTime) < ATTEMPT_COOLDOWN) {
                const remainingTime = Math.ceil((ATTEMPT_COOLDOWN - (now - lastAttemptTime)) / 1000);
                showNotification(`Attendi ${remainingTime} secondi prima di riprovare`, true);
                return false;
            }
            
            // Verifica la password con Supabase
            const isValid = await verifyPasswordWithSupabase(inputPassword);
            
            if (!isValid) {
                moderationAttempts--;
                lastAttemptTime = now;
                
                if (moderationAttempts <= 0) {
                    showNotification('Accesso bloccato. Attendi 30 secondi.', true);
                    setTimeout(() => {
                        moderationAttempts = 3;
                        showNotification('Puoi riprovare ora', false, 'info');
                    }, ATTEMPT_COOLDOWN);
                } else {
                    showNotification(`Password errata! Tentativi rimanenti: ${moderationAttempts}`, true);
                }
            } else {
                moderationAttempts = 3; // Reset tentativi
                isModerationAuthenticated = true;
                showNotification('Accesso moderazione consentito!', false, 'success');
            }
            
            return isValid;
        }

        // üîß FUNZIONE PER CAMBIARE PASSWORD (SOLO SE AUTENTICATO)
        async function changeModerationPassword(oldPassword, newPassword) {
            if (!isModerationAuthenticated) {
                showNotification('Devi prima accedere alla moderazione!', true);
                return false;
            }
            
            try {
                // Verifica la vecchia password
                const isOldValid = await verifyPasswordWithSupabase(oldPassword);
                if (!isOldValid) {
                    showNotification('Vecchia password errata!', true);
                    return false;
                }
                
                // Aggiorna con la nuova password
                const { error } = await supabase
                    .from('moderation_access')
                    .update({ 
                        access_key: newPassword,
                        last_used: new Date().toISOString()
                    })
                    .eq('access_key', oldPassword);
                
                if (error) throw error;
                
                showNotification('Password cambiata con successo!', false, 'success');
                return true;
                
            } catch (error) {
                console.error('Errore nel cambio password:', error);
                showNotification('Errore nel cambio password', true);
                return false;
            }
        }

        // üéØ GESTIONE ACCESSO MODERAZIONE
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('attemptsInfo').textContent = `Tentativi rimanenti: ${moderationAttempts}`;
            document.getElementById('moderationPasswordInput').value = '';
            document.getElementById('moderationPasswordInput').focus();
        }

        async function handlePasswordSubmit() {
            const passwordInput = document.getElementById('moderationPasswordInput');
            const password = passwordInput.value;
            
            if (!password) {
                showNotification('Inserisci una password!', true);
                return;
            }
            
            const isValid = await checkModerationPassword(password);
            
            if (isValid) {
                // Chiudi il modal
                closeModal('passwordModal');
                
                // Mostra il tab moderazione
                switchTab('moderation');
            } else {
                // Aggiorna il contatore nel modal
                const attemptsInfo = document.getElementById('attemptsInfo');
                if (attemptsInfo) {
                    attemptsInfo.textContent = `Tentativi rimanenti: ${moderationAttempts}`;
                }
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('oldPasswordInput').value = '';
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('confirmPasswordInput').value = '';
        }

        async function handlePasswordChange() {
            const oldPassword = document.getElementById('oldPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;
            
            if (!oldPassword || !newPassword || !confirmPassword) {
                showNotification('Compila tutti i campi!', true);
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('Le nuove password non coincidono!', true);
                return;
            }
            
            if (newPassword.length < 4) {
                showNotification('La password deve essere di almeno 4 caratteri!', true);
                return;
            }
            
            const success = await changeModerationPassword(oldPassword, newPassword);
            
            if (success) {
                closeModal('changePasswordModal');
            }
        }

        // üö™ FUNZIONE PER LOGOUT MODERAZIONE
        function logoutModeration() {
            isModerationAuthenticated = false;
            showNotification('Disconnesso dalla moderazione', false, 'info');
            
            if (document.getElementById('moderation-tab').classList.contains('active')) {
                switchTab('upload');
            }
        }

        // Gestione passaggi
        function goToStep(step) {
            // Nascondi tutti i contenuti dei passaggi
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Aggiorna indicatori dei passaggi
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            // Mostra il contenuto del passaggio corrente
            document.getElementById(`step${step}-content`).classList.add('active');
            
            // Aggiorna i dati nel passaggio 3
            if (step === 3) {
                document.getElementById('confirmPreviewImage').src = document.getElementById('previewImage').src;
                document.getElementById('confirm-gender').textContent = 
                    selectedGender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza';
            }
        }
        
        // Selezione genere per upload
        function selectGender(gender) {
            selectedGender = gender;
            
            // Aggiorna pulsanti
            document.querySelectorAll('#step1-content .gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (gender === 'male') {
                document.getElementById('maleBtn').classList.add('active');
            } else {
                document.getElementById('femaleBtn').classList.add('active');
            }
            
            // Abilita pulsante Avanti
            document.getElementById('nextToStep2').disabled = false;
            
            // Aggiorna testo nel passaggio 2
            document.getElementById('current-gender').textContent = 
                gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza';
        }
        
        // Selezione genere per votazione
        function selectVoteGender(gender) {
            currentVoteGender = gender;
            
            // Aggiorna pulsanti
            document.querySelectorAll('.gender-selection-vote .gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (gender === 'male') {
                document.getElementById('voteMaleBtn').classList.add('active');
            } else {
                document.getElementById('voteFemaleBtn').classList.add('active');
            }
            
            // Ricarica le foto per il genere selezionato
            loadPhotosForVoting();
        }
        
        // Gestione selezione file
        function handleFileSelection(file) {
            if (!file || !file.type.match('image.*')) {
                showNotification('Seleziona solo file immagine!', true);
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('L\'immagine √® troppo grande! Massimo 5MB.', true);
                return;
            }
            
            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                
                // Abilita pulsante Avanti
                document.getElementById('nextToStep3').disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        // Carica foto per la votazione
        async function loadPhotosForVoting() {
            const singlePhotoView = document.getElementById('singlePhotoView');
            
            // Mostra il caricamento
            singlePhotoView.innerHTML = '<div class="loading">Caricamento foto in corso...</div>';

            try {
                console.log('Caricamento foto per genere:', currentVoteGender);
                
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('gender', currentVoteGender)
                    .eq('status', 'active')
                    .limit(10);

                if (error) {
                    console.error('Errore Supabase:', error);
                    throw error;
                }

                console.log('Foto caricate:', photos);

                if (!photos || photos.length === 0) {
                    singlePhotoView.innerHTML = `
                        <div class="empty-state">
                            <p>Nessuna foto disponibile per i ${currentVoteGender === 'male' ? 'ragazzi' : 'ragazze'}.</p>
                            <p>Perch√© non carichi tu la prima foto?</p>
                        </div>
                    `;
                    return;
                }

                // Filtra le foto gi√† votate
                const unvotedPhotos = photos.filter(photo => !voteHistory[photo.id]);
                
                if (unvotedPhotos.length === 0) {
                    singlePhotoView.innerHTML = `
                        <div class="empty-state">
                            <p>Hai gi√† votato tutte le foto disponibili per i ${currentVoteGender === 'male' ? 'ragazzi' : 'ragazze'}!</p>
                            <p>Cambia genere o torna pi√π tardi per nuove foto.</p>
                        </div>
                    `;
                    return;
                }

                currentPhotos = unvotedPhotos;
                currentPhotoIndex = 0;
                showCurrentPhoto();

            } catch (error) {
                console.error('Errore nel caricamento delle foto:', error);
                singlePhotoView.innerHTML = `
                    <div class="empty-state">
                        <p>Errore nel caricamento delle foto.</p>
                        <p>Controlla la connessione e riprova.</p>
                    </div>
                `;
            }
        }
        
        // Mostra la foto corrente per la votazione
        function showCurrentPhoto() {
            const singlePhotoView = document.getElementById('singlePhotoView');
            
            if (currentPhotoIndex >= currentPhotos.length) {
                singlePhotoView.innerHTML = `
                    <div class="empty-state">
                        <p>Hai visto tutte le foto disponibili!</p>
                        <p>Torna pi√π tardi per nuove foto o cambia genere.</p>
                    </div>
                `;
                return;
            }
            
            const photo = currentPhotos[currentPhotoIndex];
            
            // Controlla se l'utente ha gi√† votato questa foto (doppio controllo)
            const userVote = voteHistory[photo.id];
            
            singlePhotoView.innerHTML = `
                <div class="photo-container">
                    <img src="${photo.image_url}" class="current-photo" alt="Foto da votare" onerror="this.src='https://via.placeholder.com/400x500/2a5298/ffffff?text=Errore+Caricamento'">
                </div>
                
                <div class="progress-container-single">
                    <div class="progress-bar-single">
                        <div class="progress-fill smash" style="width: ${photo.smash_count + photo.pass_count > 0 ? (photo.smash_count / (photo.smash_count + photo.pass_count)) * 100 : 0}%"></div>
                    </div>
                    <div class="stats-single">
                        <span class="smash-stat">${photo.smash_count} SMASH</span>
                        <span class="pass-stat">${photo.pass_count} PASS</span>
                    </div>
                </div>
                
                ${userVote ? `
                    <div style="text-align: center; margin: 20px 0;">
                        <p><strong>Hai gi√† votato: ${userVote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</strong></p>
                        <button class="btn btn-secondary" onclick="currentPhotoIndex++; showCurrentPhoto();">
                            Vota Prossima Foto
                        </button>
                        <button class="report-btn" onclick="openReportModal('${photo.id}')">
                            ‚ö†Ô∏è Segnala
                        </button>
                    </div>
                ` : `
                    <div class="vote-buttons-single">
                        <button class="pass-btn-single" onclick="voteCurrentPhoto('pass')">
                            üòê PASS
                        </button>
                        <button class="smash-btn-single" onclick="voteCurrentPhoto('smash')">
                            üòç SMASH
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="report-btn" onclick="openReportModal('${photo.id}')">
                            ‚ö†Ô∏è Segnala questa foto
                        </button>
                    </div>
                `}
            `;
            
            // Aggiorna statistiche in tempo reale
            updateLiveStats();
        }
        
        // Vota la foto corrente
        async function voteCurrentPhoto(vote) {
            if (currentPhotoIndex >= currentPhotos.length) return;
            
            const photo = currentPhotos[currentPhotoIndex];
            
            // Applica effetto visivo
            const photoContainer = document.querySelector('.photo-container');
            if (vote === 'smash') {
                photoContainer.classList.add('smash-effect');
            } else {
                photoContainer.classList.add('pass-effect');
            }
            
            // Salva il voto nella cronologia locale
            voteHistory[photo.id] = vote;
            localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
            
            try {
                // Aggiorna il conteggio nel database
                const updateField = vote === 'smash' ? 'smash_count' : 'pass_count';
                const { error } = await supabase
                    .from('photos')
                    .update({ 
                        [updateField]: photo[updateField] + 1 
                    })
                    .eq('id', photo.id);
                
                if (error) throw error;
                
                // Aggiorna le statistiche
                updateLiveStats();
                
                // Mostra notifica
                showNotification(`Hai votato: ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}`, false, 'info');
                
                // Passa alla prossima foto dopo un breve delay
                setTimeout(() => {
                    currentPhotoIndex++;
                    showCurrentPhoto();
                }, 800);
                
            } catch (error) {
                console.error('Errore durante il voto:', error);
                showNotification('Errore durante il voto. Riprova.', true);
            }
        }
        
        // Aggiorna statistiche in tempo reale
        function updateLiveStats() {
            let totalSmash = 0;
            let totalPass = 0;
            
            currentPhotos.forEach(photo => {
                totalSmash += photo.smash_count;
                totalPass += photo.pass_count;
            });
            
            const liveStats = document.getElementById('liveStats');
            liveStats.style.display = 'flex';
            
            document.getElementById('liveSmash').textContent = totalSmash;
            document.getElementById('livePass').textContent = totalPass;
            document.getElementById('liveTotal').textContent = totalSmash + totalPass;
        }
        
        // Carica la cronologia voti
        async function loadVoteHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="loading">Caricamento cronologia...</div>';

            try {
                const historyEntries = Object.entries(voteHistory);
                
                if (historyEntries.length === 0) {
                    historyList.innerHTML = '<div class="empty-state"><p>Non hai ancora votato nessuna foto.</p></div>';
                    return;
                }

                // Carica i dettagli delle foto votate
                const photoIds = historyEntries.map(([photoId]) => photoId);
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .in('id', photoIds);

                if (error) throw error;

                // Crea una mappa per accesso rapido
                const photosMap = {};
                if (photos) {
                    photos.forEach(photo => {
                        photosMap[photo.id] = photo;
                    });
                }

                // Filtra in base al filtro corrente
                const filteredEntries = historyEntries.filter(([photoId, vote]) => {
                    if (currentHistoryFilter === 'all') return true;
                    return vote === currentHistoryFilter;
                });

                if (filteredEntries.length === 0) {
                    historyList.innerHTML = '<div class="empty-state"><p>Nessun voto corrisponde al filtro selezionato.</p></div>';
                    return;
                }

                historyList.innerHTML = filteredEntries.map(([photoId, vote]) => {
                    const photo = photosMap[photoId];
                    
                    if (!photo) {
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <p><strong>Foto ID:</strong> ${photoId.substring(0, 8)}...</p>
                                    <p><strong>Voto:</strong> ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</p>
                                    <p><em>Foto non pi√π disponibile</em></p>
                                </div>
                                <div class="history-vote ${vote}">
                                    ${vote === 'smash' ? 'SMASH' : 'PASS'}
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="history-item">
                            <img src="${photo.image_url}" class="history-photo" alt="Foto votata" onerror="this.style.display='none'">
                            <div class="history-info">
                                <p><strong>Genere:</strong> ${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</p>
                                <p><strong>Statistiche:</strong> ${photo.smash_count} üòç | ${photo.pass_count} üòê</p>
                                <p><strong>Il tuo voto:</strong> ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</p>
                            </div>
                            <div class="history-vote ${vote}">
                                ${vote === 'smash' ? 'SMASH' : 'PASS'}
                            </div>
                            <button class="change-vote-btn" onclick="changeVote('${photoId}')">
                                Cambia
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Errore nel caricamento della cronologia:', error);
                historyList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento della cronologia.</p></div>';
            }
        }
        
        // Cambia voto nella cronologia
        async function changeVote(photoId) {
            if (!confirm('Vuoi cambiare il tuo voto per questa foto?')) {
                return;
            }

            try {
                const currentVote = voteHistory[photoId];
                const { data: photo, error: fetchError } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('id', photoId)
                    .single();

                if (fetchError) throw fetchError;

                // Calcola il nuovo voto (inverti)
                const newVote = currentVote === 'smash' ? 'pass' : 'smash';
                
                // Aggiorna il database
                const updateField = newVote === 'smash' ? 'smash_count' : 'pass_count';
                const decrementField = newVote === 'smash' ? 'pass_count' : 'smash_count';

                const { error: updateError } = await supabase
                    .from('photos')
                    .update({ 
                        [updateField]: photo[updateField] + 1,
                        [decrementField]: Math.max(0, photo[decrementField] - 1)
                    })
                    .eq('id', photoId);

                if (updateError) throw updateError;

                // Aggiorna la cronologia locale
                voteHistory[photoId] = newVote;
                localStorage.setItem('voteHistory', JSON.stringify(voteHistory));

                showNotification(`Voto cambiato in: ${newVote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}`, false, 'info');
                
                // Ricarica la cronologia
                loadVoteHistory();

            } catch (error) {
                console.error('Errore nel cambiare il voto:', error);
                showNotification('Errore nel cambiare il voto. Riprova.', true);
            }
        }
        
        // Filtra la cronologia
        function filterHistory(filter) {
            currentHistoryFilter = filter;
            
            // Aggiorna pulsanti filtro
            document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadVoteHistory();
        }
        
        // Carica la classifica
        async function loadLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '<div class="loading">Caricamento classifica...</div>';
            
            try {
                let query = supabase
                    .from('photos')
                    .select('*')
                    .eq('status', 'active')
                    .order('smash_count', { ascending: false })
                    .limit(20);
                
                if (currentLeaderboardFilter !== 'all') {
                    query = query.eq('gender', currentLeaderboardFilter);
                }
                
                const { data: photos, error } = await query;
                
                if (error) throw error;
                
                if (!photos || photos.length === 0) {
                    leaderboardList.innerHTML = '<div class="empty-state"><p>Nessuna foto in classifica.</p></div>';
                    return;
                }
                
                leaderboardList.innerHTML = photos.map((photo, index) => {
                    const totalVotes = photo.smash_count + photo.pass_count;
                    const smashPercentage = totalVotes > 0 ? 
                        Math.round((photo.smash_count / totalVotes) * 100) : 0;
                    
                    return `
                        <div class="leaderboard-item">
                            <div class="leaderboard-rank">${index + 1}</div>
                            <img src="${photo.image_url}" class="leaderboard-photo" alt="Foto" onerror="this.style.display='none'">
                            <div class="leaderboard-info">
                                <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</h4>
                                <p><strong>Smash Rate:</strong> ${smashPercentage}%</p>
                                <p><strong>Voti Totali:</strong> ${totalVotes}</p>
                            </div>
                            <div class="leaderboard-score">
                                ${photo.smash_count} üòç
                            </div>
                            <button class="report-btn" onclick="openReportModal('${photo.id}')">
                                ‚ö†Ô∏è
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Errore nel caricamento della classifica:', error);
                leaderboardList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento della classifica.</p></div>';
            }
        }
        
        // Filtra la classifica
        function filterLeaderboard(filter) {
            currentLeaderboardFilter = filter;
            
            // Aggiorna pulsanti filtro
            document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadLeaderboard();
        }
        
        // Carica achievement
        function loadAchievements() {
            // Achievement di base
            const defaultAchievements = {
                first_vote: { name: 'Primo Voto', description: 'Effettua il tuo primo voto', unlocked: false, icon: 'üéØ' },
                five_votes: { name: 'Votante Attivo', description: 'Effettua 5 voti', unlocked: false, icon: 'üèÜ' },
                ten_votes: { name: 'Esperto di Bellezza', description: 'Effettua 10 voti', unlocked: false, icon: 'üëë' },
                first_upload: { name: 'Modello Emergente', description: 'Carica la tua prima foto', unlocked: false, icon: 'üì∏' }
            };
            
            // Unisci con achievement esistenti
            achievements = { ...defaultAchievements, ...achievements };
            localStorage.setItem('achievements', JSON.stringify(achievements));
        }
        
        // Mostra achievement
        function loadAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            
            achievementsList.innerHTML = Object.entries(achievements).map(([key, achievement]) => `
                <div class="achievement-item ${achievement.unlocked ? '' : 'achievement-locked'}">
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <h4>${achievement.name}</h4>
                        <p>${achievement.description}</p>
                    </div>
                    <div class="history-vote ${achievement.unlocked ? 'smash' : 'pass'}">
                        ${achievement.unlocked ? 'Sbloccato' : 'Bloccato'}
                    </div>
                </div>
            `).join('');
        }
        
        // Carica statistiche
        async function loadStats() {
            try {
                // Conta foto totali
                const { data: photos, error: photosError } = await supabase
                    .from('photos')
                    .select('id', { count: 'exact' });
                
                // Conta voti totali
                const { data: allPhotos, error: votesError } = await supabase
                    .from('photos')
                    .select('smash_count, pass_count');
                
                if (photosError || votesError) throw new Error('Errore nel caricamento delle statistiche');
                
                let totalVotes = 0;
                if (allPhotos) {
                    allPhotos.forEach(photo => {
                        totalVotes += photo.smash_count + photo.pass_count;
                    });
                }
                
                document.getElementById('totalPhotos').textContent = photos ? photos.length : 0;
                document.getElementById('totalVotes').textContent = totalVotes;
                
            } catch (error) {
                console.error('Errore nel caricamento delle statistiche:', error);
            }
        }
        
        // Carica foto segnalate
        async function loadReportedPhotos() {
            const reportedPhotosList = document.getElementById('reportedPhotosList');
            reportedPhotosList.innerHTML = '<div class="loading">Caricamento foto segnalate...</div>';
            
            try {
                // Ottieni le foto con report_count > 0 e status active
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .gt('report_count', 0)
                    .eq('status', 'active')
                    .order('report_count', { ascending: false });
                
                if (error) throw error;
                
                if (!photos || photos.length === 0) {
                    reportedPhotosList.innerHTML = '<div class="empty-state"><p>Nessuna foto segnalata</p></div>';
                    return;
                }
                
                reportedPhotosList.innerHTML = photos.map(photo => {
                    const totalVotes = photo.smash_count + photo.pass_count;
                    const smashPercentage = totalVotes > 0 ? 
                        Math.round((photo.smash_count / totalVotes) * 100) : 0;
                    
                    return `
                        <div class="reported-photo">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <img src="${photo.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; margin-right: 15px;" onerror="this.style.display='none'">
                                <div style="flex-grow: 1;">
                                    <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</h4>
                                    <p><strong>Segnalazioni:</strong> ${photo.report_count || 0}</p>
                                    <p><strong>Smash:</strong> ${photo.smash_count} | <strong>Pass:</strong> ${photo.pass_count}</p>
                                    <p><strong>Caricata il:</strong> ${new Date(photo.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            
                            <div class="admin-actions">
                                <button class="admin-btn approve-btn" onclick="approvePhoto('${photo.id}')">‚úÖ Approva</button>
                                <button class="admin-btn reject-btn" onclick="rejectPhoto('${photo.id}')">‚ùå Rimuovi</button>
                                <button class="btn btn-secondary" onclick="suspendPhoto('${photo.id}')">‚è∏Ô∏è Sospendi</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Errore nel caricamento delle foto segnalate:', error);
                reportedPhotosList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento delle foto segnalate</p></div>';
            }
        }
        
        // Carica foto sospese
        async function loadSuspendedPhotos() {
            const suspendedPhotosList = document.getElementById('suspendedPhotosList');
            suspendedPhotosList.innerHTML = '<div class="loading">Caricamento foto sospese...</div>';
            
            try {
                // Ottieni le foto con status = 'suspended'
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('status', 'suspended')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!photos || photos.length === 0) {
                    suspendedPhotosList.innerHTML = '<div class="empty-state"><p>Nessuna foto sospesa</p></div>';
                    return;
                }
                
                suspendedPhotosList.innerHTML = photos.map(photo => {
                    const totalVotes = photo.smash_count + photo.pass_count;
                    const smashPercentage = totalVotes > 0 ? 
                        Math.round((photo.smash_count / totalVotes) * 100) : 0;
                    
                    return `
                        <div class="reported-photo">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <img src="${photo.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; margin-right: 15px;" onerror="this.style.display='none'">
                                <div>
                                    <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'} <span class="suspended-badge">SOSPESA</span></h4>
                                    <p><strong>Segnalazioni:</strong> ${photo.report_count || 0}</p>
                                    <p><strong>Smash:</strong> ${photo.smash_count} | <strong>Pass:</strong> ${photo.pass_count}</p>
                                    <p><strong>Caricata il:</strong> ${new Date(photo.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button class="admin-btn approve-btn" onclick="approvePhoto('${photo.id}')">‚úÖ Riattiva</button>
                                <button class="admin-btn reject-btn" onclick="rejectPhoto('${photo.id}')">‚ùå Elimina</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Errore nel caricamento delle foto sospese:', error);
                suspendedPhotosList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento delle foto sospese</p></div>';
            }
        }
        
        // Carica statistiche moderazione
        async function loadModerationStats() {
            const moderationStats = document.getElementById('moderationStats');
            
            try {
                // Conta foto attive
                const { data: activePhotos, error: activeError } = await supabase
                    .from('photos')
                    .select('id', { count: 'exact' })
                    .eq('status', 'active');
                
                // Conta foto sospese
                const { data: suspendedPhotos, error: suspendedError } = await supabase
                    .from('photos')
                    .select('id', { count: 'exact' })
                    .eq('status', 'suspended');
                
                // Conta foto segnalate
                const { data: reportedPhotos, error: reportedError } = await supabase
                    .from('photos')
                    .select('id', { count: 'exact' })
                    .gt('report_count', 0);
                
                if (activeError || suspendedError || reportedError) {
                    throw new Error('Errore nel caricamento delle statistiche');
                }
                
                moderationStats.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #155724;">${activePhotos.length || 0}</div>
                            <div style="color: #155724;">Foto Attive</div>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #856404;">${suspendedPhotos.length || 0}</div>
                            <div style="color: #856404;">Foto Sospese</div>
                        </div>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #721c24;">${reportedPhotos.length || 0}</div>
                            <div style="color: #721c24;">Foto Segnalate</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Errore nel caricamento delle statistiche:', error);
                moderationStats.innerHTML = '<div class="empty-state"><p>Errore nel caricamento delle statistiche</p></div>';
            }
        }
        
        // Approva una foto (rimuove le segnalazioni)
        async function approvePhoto(photoId) {
            try {
                const { error } = await supabase
                    .from('photos')
                    .update({ 
                        report_count: 0,
                        status: 'active'
                    })
                    .eq('id', photoId);
                
                if (error) throw error;
                
                showNotification('Foto approvata con successo!');
                
                // Ricarica le liste
                loadReportedPhotos();
                loadSuspendedPhotos();
                loadModerationStats();
                
            } catch (error) {
                console.error('Errore durante l\'approvazione:', error);
                showNotification('Errore durante l\'approvazione. Riprova.', true);
            }
        }
        
        // Sospendi una foto manualmente
        async function suspendPhoto(photoId) {
            try {
                const { error } = await supabase
                    .from('photos')
                    .update({ 
                        status: 'suspended'
                    })
                    .eq('id', photoId);
                
                if (error) throw error;
                
                showNotification('Foto sospesa con successo!');
                
                // Ricarica le liste
                loadReportedPhotos();
                loadSuspendedPhotos();
                loadModerationStats();
                
            } catch (error) {
                console.error('Errore durante la sospensione:', error);
                showNotification('Errore durante la sospensione. Riprova.', true);
            }
        }
        
        // Rifiuta/rimuovi una foto
        async function rejectPhoto(photoId) {
            if (!confirm('Sei sicuro di voler rimuovere questa foto? Questa azione non pu√≤ essere annullata.')) {
                return;
            }
            
            try {
                // Prima ottieni l'URL dell'immagine per eliminarla dallo storage
                const { data: photo, error: fetchError } = await supabase
                    .from('photos')
                    .select('image_url')
                    .eq('id', photoId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // Estrai il nome del file dall'URL
                const imagePath = photo.image_url.split('/').pop();
                
                // Elimina l'immagine dallo storage
                const { error: storageError } = await supabase.storage
                    .from('photo-uploads')
                    .remove([imagePath]);
                
                if (storageError) {
                    console.error('Errore nell\'eliminazione dell\'immagine:', storageError);
                    // Continua comunque con l'eliminazione del record
                }
                
                // Elimina il record della foto
                const { error } = await supabase
                    .from('photos')
                    .delete()
                    .eq('id', photoId);
                
                if (error) throw error;
                
                showNotification('Foto rimossa con successo!');
                
                // Ricarica le liste
                loadReportedPhotos();
                loadSuspendedPhotos();
                loadModerationStats();
                
            } catch (error) {
                console.error('Errore durante la rimozione:', error);
                showNotification('Errore durante la rimozione. Riprova.', true);
            }
        }
        
        // Upload foto
        async function uploadPhoto() {
            if (!selectedFile || !selectedGender) {
                showNotification('Seleziona prima una foto e un genere!', true);
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Caricamento...';
            
            try {
                // Genera un nome file unico
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                
                // Upload dell'immagine a Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('photo-uploads')
                    .upload(fileName, selectedFile);
                
                if (uploadError) throw uploadError;
                
                // Ottieni l'URL pubblico dell'immagine
                const { data: urlData } = supabase.storage
                    .from('photo-uploads')
                    .getPublicUrl(fileName);
                
                // Salva i metadati della foto nel database
                const { error: dbError } = await supabase
                    .from('photos')
                    .insert([
                        {
                            image_url: urlData.publicUrl,
                            gender: selectedGender,
                            smash_count: 0,
                            pass_count: 0,
                            report_count: 0,
                            status: 'active'
                        }
                    ]);
                
                if (dbError) throw dbError;
                
                showNotification('Foto caricata con successo!');
                
                // Resetta il form
                setTimeout(() => {
                    selectedFile = null;
                    selectedGender = null;
                    document.getElementById('previewImage').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    goToStep(1);
                    
                    // Resetta pulsanti genere
                    document.querySelectorAll('#step1-content .gender-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.getElementById('nextToStep2').disabled = true;
                    
                }, 1000);
                
            } catch (error) {
                console.error('Errore durante il caricamento:', error);
                showNotification('Errore durante il caricamento. Riprova.', true);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Carica Foto';
            }
        }
        
        // Apri modal di segnalazione
        function openReportModal(photoId) {
            currentPhotoForReport = photoId;
            document.getElementById('reportModal').style.display = 'flex';
        }
        
        // Invia segnalazione
        async function submitReport() {
            if (!currentPhotoForReport) return;
            
            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value;
            
            try {
                // Prima ottieni il conteggio attuale dei report
                const { data: photo, error: fetchError } = await supabase
                    .from('photos')
                    .select('report_count')
                    .eq('id', currentPhotoForReport)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // Incrementa il conteggio dei report
                const { error: updateError } = await supabase
                    .from('photos')
                    .update({ 
                        report_count: (photo.report_count || 0) + 1 
                    })
                    .eq('id', currentPhotoForReport);
                
                if (updateError) throw updateError;
                
                // Salva i dettagli del report in una tabella separata (se esiste)
                try {
                    const { error: reportError } = await supabase
                        .from('reports')
                        .insert([
                            {
                                photo_id: currentPhotoForReport,
                                reason: reason,
                                details: details,
                                reported_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (reportError) console.warn('Errore nel salvare i dettagli del report:', reportError);
                } catch (e) {
                    console.warn('Tabella reports non disponibile:', e);
                }
                
                showNotification('Segnalazione inviata con successo!');
                closeModal('reportModal');
                
                // Sospendi automaticamente se supera la soglia
                if ((photo.report_count || 0) + 1 >= REPORT_THRESHOLD) {
                    await suspendPhoto(currentPhotoForReport);
                    showNotification('Foto sospesa automaticamente per troppe segnalazioni', false, 'warning');
                }
                
            } catch (error) {
                console.error('Errore durante la segnalazione:', error);
                showNotification('Errore durante la segnalazione. Riprova.', true);
            }
        }
        
        // Funzioni per i modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Resetta i campi
            if (modalId === 'reportModal') {
                document.getElementById('reportReason').value = 'inappropriate';
                document.getElementById('reportDetails').value = '';
            }
        }
        
        function showNotification(message, isError = false, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
            } else if (type === 'info') {
                notification.classList.add('info');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            } else if (type === 'success') {
                notification.classList.add('success');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Esporta dati
        function exportData() {
            const data = {
                voteHistory: voteHistory,
                achievements: achievements,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `smash-or-pass-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Dati esportati con successo!');
        }
        
        // Importa dati
        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.voteHistory) {
                        voteHistory = { ...voteHistory, ...data.voteHistory };
                        localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
                    }
                    
                    if (data.achievements) {
                        achievements = { ...achievements, ...data.achievements };
                        localStorage.setItem('achievements', JSON.stringify(achievements));
                    }
                    
                    showNotification('Dati importati con successo!');
                    
                    // Ricarica le view interessate
                    if (document.getElementById('history-tab').classList.contains('active')) {
                        loadVoteHistory();
                    }
                    if (document.getElementById('achievements-tab').classList.contains('active')) {
                        loadAchievementsDisplay();
                    }
                    
                } catch (error) {
                    console.error('Errore nell\'importazione:', error);
                    showNotification('Errore nell\'importazione. File non valido.', true);
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
