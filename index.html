<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash or Pass - Cesaris Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        /* DARK MODE STYLES */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .tab-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .sidebar {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .sidebar-nav a {
            color: #e0e0e0;
        }

        body.dark-mode .sidebar-nav a:hover,
        body.dark-mode .sidebar-nav a.active {
            background: #2a5298;
            color: white;
        }

        body.dark-mode .btn-secondary {
            background: #404040;
            color: #e0e0e0;
        }

        body.dark-mode .btn-secondary:hover {
            background: #505050;
        }

        body.dark-mode .history-item,
        body.dark-mode .leaderboard-item,
        body.dark-mode .achievement-item {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .settings-section {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .password-input {
            background: #404040;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        body.dark-mode .file-restrictions {
            background: #2a3d5c;
            color: #e0e0e0;
        }

        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .reported-photo {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .empty-state {
            color: #aaa;
        }

        /* Toggle Switch per Dark Mode */
        .theme-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2a5298;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .sidebar-nav {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 10px;
        }
        
        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #2a5298;
            color: white;
        }
        
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a5298;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .cesaris {
            color: #FFD700;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }

        .upload-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .step.active .step-number {
            background: #2a5298;
        }
        
        .step.completed .step-number {
            background: #4CAF50;
        }
        
        .step-content {
            display: none;
            text-align: center;
        }
        
        .step-content.active {
            display: block;
        }
        
        .gender-selection {
            margin: 20px 0;
        }
        
        .gender-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .gender-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .gender-btn.male.active {
            background: #1e3c72;
            border-color: #1e3c72;
        }
        
        .gender-btn.female.active {
            background: #FFD700;
            color: #333;
            border-color: #FFD700;
        }
        
        .upload-area {
            border: 2px dashed #2a5298;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #f8f9ff;
        }
        
        .preview-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: #2a5298;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1e3c72;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ddd;
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        #fileInput {
            display: none;
        }
        
        .voting-interface {
            text-align: center;
        }
        
        .gender-selection-vote {
            margin: 20px 0;
        }
        
        .photo-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .current-photo {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
        }
        
        .vote-buttons-single {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .smash-btn-single, .pass-btn-single {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .smash-btn-single {
            background: #4CAF50;
            color: white;
        }
        
        .smash-btn-single:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .pass-btn-single {
            background: #f44336;
            color: white;
        }
        
        .pass-btn-single:hover {
            background: #da190b;
            transform: scale(1.05);
        }
        
        .progress-container-single {
            margin: 20px auto;
            max-width: 400px;
        }
        
        .progress-bar-single {
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.5s ease;
        }
        
        .progress-fill.smash {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            z-index: 2;
        }
        
        .progress-fill.pass {
            background: linear-gradient(90deg, #f44336, #ff9800);
            z-index: 1;
        }
        
        .stats-single {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .smash-stat {
            color: #4CAF50;
        }
        
        .pass-stat {
            color: #f44336;
        }
        
        .vote-history {
            margin-top: 30px;
            text-align: left;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .history-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .history-info {
            flex-grow: 1;
        }
        
        .history-vote {
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
        }
        
        .history-vote.smash {
            background: #4CAF50;
            color: white;
        }
        
        .history-vote.pass {
            background: #f44336;
            color: white;
        }
        
        .change-vote-btn {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .change-vote-btn:hover {
            background: #FFC400;
            transform: scale(1.05);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #2a5298;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        
        .history-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .history-filter {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
            color: #2a5298;
            min-width: 30px;
            text-align: center;
        }
        
        .leaderboard-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .leaderboard-info {
            flex-grow: 1;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #4CAF50;
            margin-right: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .achievement-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .achievement-info {
            flex-grow: 1;
        }
        
        .achievement-locked {
            opacity: 0.7;
        }
        
        .achievement-locked .achievement-info h4,
        .achievement-locked .achievement-info p {
            color: #999;
        }
        
        .achievement-progress {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .achievement-item small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .admin-panel {
            margin-top: 30px;
        }
        
        .reported-photo {
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fff9e6;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .admin-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .approve-btn {
            background: #4CAF50;
            color: white;
        }
        
        .reject-btn {
            background: #f44336;
            color: white;
        }
        
        .suspended-badge {
            background: #ff9800;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .approved-badge {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .report-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .report-details {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            border-left: 4px solid #ff9800;
        }
        
        .report-item {
            background: white;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #e9ecef;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .gender-btn {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 130px;
                margin: 5px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .preview-image {
                max-width: 100%;
                max-height: 300px;
            }
            
            .photo-container {
                max-width: 100%;
            }
            
            .current-photo {
                height: 400px;
            }
            
            .vote-buttons-single {
                gap: 10px;
            }
            
            .smash-btn-single, .pass-btn-single {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
                margin: 5px 0;
            }
            
            .history-item {
                flex-direction: column;
                text-align: center;
            }
            
            .history-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .change-vote-btn {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                max-width: 200px;
            }
            
            .leaderboard-item {
                flex-direction: column;
                text-align: center;
            }
            
            .leaderboard-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .sidebar {
                width: 280px;
                left: -280px;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        .notification.info {
            background: #2196F3;
        }

        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .no-context-menu {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .settings-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .logout-btn {
            margin-top: 20px;
        }
        
        .file-restrictions {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #2a5298;
        }
        
        .file-restrictions ul {
            text-align: left;
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .file-restrictions li {
            margin-bottom: 5px;
        }
		/* ============================================ */
/* STILI BATTAGLIE E TERMINI - AGGIUNGI QUI */
/* ============================================ */

/* Badge NEW */
.new-badge {
    background: linear-gradient(135deg, #FF6B6B, #FFD93D);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 8px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Stili Battaglia */
.battle-container {
    max-width: 1000px;
    margin: 0 auto;
}

.battle-arena {
    display: flex;
    gap: 30px;
    align-items: center;
    justify-content: center;
    margin: 30px 0;
}

.battle-slot {
    flex: 1;
    max-width: 350px;
    background: #f9f9f9;
    border: 3px dashed #ddd;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    min-height: 450px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.battle-slot.filled {
    border: 3px solid #2a5298;
    background: white;
}

.battle-slot.winning {
    border-color: #4CAF50;
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
}

.battle-slot-empty {
    cursor: pointer;
    padding: 40px;
}

.battle-slot-empty:hover {
    background: #f0f4ff;
    border-color: #2a5298;
}

.battle-slot-empty h3 {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 15px;
}

.battle-photo {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 15px;
}

.battle-vs {
    font-size: 48px;
    font-weight: bold;
    color: #2a5298;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    animation: pulse-vs 2s infinite;
}

@keyframes pulse-vs {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.battle-timer {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin: 20px 0;
}

.battle-timer h3 {
    margin: 0;
    font-size: 24px;
}

.battle-timer .time {
    font-size: 36px;
    font-weight: bold;
    margin: 10px 0;
}

.battle-progress {
    margin: 20px 0;
}

.battle-progress-bar {
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    display: flex;
}

.battle-progress-fill {
    height: 100%;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.battle-progress-fill.left {
    background: linear-gradient(90deg, #FF6B6B, #FF8E53);
}

.battle-progress-fill.right {
    background: linear-gradient(90deg, #4FACFE, #00F2FE);
}

.battle-vote-btn {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
}

.battle-vote-btn.left {
    background: linear-gradient(135deg, #FF6B6B, #FF8E53);
    color: white;
}

.battle-vote-btn.right {
    background: linear-gradient(135deg, #4FACFE, #00F2FE);
    color: white;
}

.battle-vote-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.battle-vote-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.battle-stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 10px;
}

.battle-stat-item {
    text-align: center;
}

.battle-stat-item .value {
    font-size: 32px;
    font-weight: bold;
    color: #2a5298;
}

.battle-stat-item .label {
    font-size: 14px;
    color: #666;
}

.battle-history-item {
    background: #f9f9f9;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
}

.battle-history-photos {
    display: flex;
    gap: 15px;
    margin: 15px 0;
}

.battle-history-photo-container {
    flex: 1;
    text-align: center;
}

.battle-history-photo-container img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 10px;
}

.battle-history-photo-container.winner {
    position: relative;
}

.battle-history-photo-container.winner::after {
    content: 'üëë VINCITORE';
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #FFD700;
    color: #333;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 12px;
}

.photo-selector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.photo-selector-item {
    position: relative;
    cursor: pointer;
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.photo-selector-item:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.photo-selector-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.photo-selector-item.in-battle {
    opacity: 0.5;
    cursor: not-allowed;
}

.photo-selector-item.in-battle::after {
    content: '‚öîÔ∏è IN BATTAGLIA';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: bold;
}

/* Stili Termini e Condizioni */
.terms-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 99999;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
}

.terms-container {
    background: white;
    max-width: 800px;
    width: 90%;
    max-height: 85vh;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.5s ease;
    display: flex;
    flex-direction: column;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.terms-header {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: white;
    padding: 30px;
    text-align: center;
}

.terms-header h1 {
    font-size: 2rem;
    margin-bottom: 10px;
}

.terms-header p {
    opacity: 0.9;
    font-size: 0.95rem;
}

.terms-content {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    line-height: 1.8;
}

.terms-content h2 {
    color: #2a5298;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.3rem;
    border-bottom: 2px solid #2a5298;
    padding-bottom: 8px;
}

.terms-content h3 {
    color: #1e3c72;
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.terms-content p {
    margin-bottom: 12px;
    color: #333;
}

.terms-content ul {
    margin-left: 25px;
    margin-bottom: 15px;
}

.terms-content li {
    margin-bottom: 8px;
    color: #555;
}

.terms-highlight {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin: 20px 0;
    border-radius: 5px;
}

.terms-highlight strong {
    color: #856404;
}

.terms-footer {
    padding: 20px 30px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    flex-shrink: 0;
}

.terms-checkbox-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 10px;
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
}

.terms-checkbox-container:hover {
    border-color: #2a5298;
}

.terms-checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.terms-checkbox-container label {
    cursor: pointer;
    user-select: none;
    font-size: 0.95rem;
    color: #333;
}

.terms-buttons {
    display: flex;
    gap: 15px;
}

.terms-accept-btn {
    flex: 1;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.terms-accept-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.terms-accept-btn:disabled {
    background: #cccccc !important;
    cursor: not-allowed !important;
    opacity: 0.6;
}
.terms-decline-btn {
    flex: 1;
    padding: 15px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.terms-decline-btn:hover {
    background: #da190b;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}

/* Dark mode per battaglie e termini */
body.dark-mode .battle-slot,
body.dark-mode .battle-history-item {
    background: #3d3d3d;
    color: #e0e0e0;
    border-color: #555;
}

body.dark-mode .terms-container {
    background: #2d2d2d;
    color: #e0e0e0;
}

body.dark-mode .terms-content h2,
body.dark-mode .terms-content h3,
body.dark-mode .terms-content p,
body.dark-mode .terms-content li {
    color: #e0e0e0;
}

body.dark-mode .terms-footer {
    background: #1a1a1a;
}

body.dark-mode .terms-checkbox-container {
    background: #3d3d3d;
    border-color: #555;
}

body.dark-mode .terms-checkbox-container label {
    color: #e0e0e0;
}

/* Responsive per battaglie */
@media (max-width: 768px) {
    .battle-arena {
        flex-direction: column;
        gap: 20px;
    }
    
    .battle-slot {
        max-width: 100%;
    }
    
    .battle-vs {
        font-size: 32px;
    }
    
    .battle-history-photos {
        flex-direction: column;
    }
    
    .photo-selector-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    .terms-container {
        width: 95%;
    }
    
    .terms-content {
        padding: 20px;
    }
    
    .terms-buttons {
        flex-direction: column;
    }
	@media (max-width: 768px) {
    /* ... codice esistente ... */
    
    .terms-container {
        width: 95%;
        max-height: 90vh;
    }
    
    .terms-content {
        padding: 20px;
        max-height: none;
    }
    
    .terms-footer {
        padding: 15px 20px;
    }
    
    .terms-buttons {
        flex-direction: column;
    }
}
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="no-select no-context-menu" oncontextmenu="return false;">
<!-- TERMINI E CONDIZIONI OVERLAY -->
    <div class="terms-overlay" id="termsOverlay" style="display: none;">
        <div class="terms-container">
            <div class="terms-header">
                <h1>üìã Termini e Condizioni d'Uso</h1>
                <p>Smash or Pass - Cesaris Edition</p>
            </div>
            
            <div class="terms-content">
                <div class="terms-highlight">
                    <strong>‚ö†Ô∏è IMPORTANTE:</strong> Si prega di leggere attentamente i seguenti termini prima di utilizzare il servizio.
                </div>

                <h2>1. Accettazione dei Termini</h2>
                <p>Accedendo e utilizzando questa piattaforma, l'utente accetta integralmente i presenti Termini e Condizioni d'Uso.</p>

                <h2>2. Descrizione del Servizio</h2>
                <p>La piattaforma permette agli utenti di:</p>
                <ul>
                    <li>Caricare foto in modo anonimo</li>
                    <li>Votare foto caricate da altri utenti</li>
                    <li>Partecipare a battaglie fotografiche</li>
                    <li>Visualizzare classifiche e statistiche</li>
                </ul>

                <h2>3. Responsabilit√† dell'Utente</h2>
                <h3>3.1 Contenuti Caricati</h3>
                <p><strong>L'utente √® l'unico e solo responsabile per tutti i contenuti che carica sulla piattaforma.</strong> Caricando una foto, l'utente dichiara e garantisce che:</p>
                <ul>
                    <li>Possiede tutti i diritti necessari sulla foto caricata</li>
                    <li>Ha ottenuto il consenso esplicito di tutte le persone ritratte nella foto</li>
                    <li>La foto non viola alcun diritto di terzi</li>
                    <li>La foto non contiene contenuti illegali, diffamatori o inappropriati</li>
                </ul>

                <h3>3.2 Comportamento dell'Utente</h3>
                <p>L'utente si impegna a:</p>
                <ul>
                    <li>Utilizzare la piattaforma in modo rispettoso</li>
                    <li>Non caricare contenuti sessualmente espliciti, violenti o illegali</li>
                    <li>Rispettare la privacy e la dignit√† di tutte le persone</li>
                    <li>Segnalare immediatamente contenuti inappropriati</li>
                </ul>

                <h2>4. Limitazione di Responsabilit√†</h2>
                <div class="terms-highlight">
                    <strong>DICHIARAZIONE IMPORTANTE:</strong>
                    <p style="margin-top: 10px;">Il gestore della piattaforma <strong>NON √® responsabile</strong> per:</p>
                </div>
                <ul>
                    <li><strong>Contenuti caricati dagli utenti:</strong> Ogni utente √® personalmente responsabile</li>
                    <li><strong>Violazioni della privacy:</strong> La responsabilit√† √® esclusivamente dell'utente</li>
                    <li><strong>Violazioni del copyright:</strong> L'utente ne √® l'unico responsabile</li>
                    <li><strong>Conseguenze legali:</strong> A carico esclusivo dell'utente</li>
                    <li><strong>Danni diretti o indiretti</strong></li>
                </ul>

                <h2>5. Contenuti Proibiti</h2>
                <p>√à severamente vietato caricare:</p>
                <ul>
                    <li>Contenuti sessualmente espliciti o pornografici</li>
                    <li>Contenuti violenti o disturbanti</li>
                    <li>Contenuti che incitano all'odio o alla violenza</li>
                    <li>Contenuti illegali</li>
                    <li>Foto di persone senza consenso</li>
                </ul>

                <div class="terms-highlight">
                    <strong>üìå RIEPILOGO:</strong>
                    <p style="margin-top: 10px;">Utilizzando questa piattaforma, l'utente riconosce di essere l'unico responsabile per tutti i contenuti che carica. Il gestore agisce esclusivamente come fornitore di infrastruttura tecnica.</p>
                </div>

                <p style="margin-top: 30px; text-align: center; color: #666; font-size: 0.9rem;">
                    <strong>Data ultimo aggiornamento:</strong> Novembre 2024<br>
                    <strong>Versione:</strong> 2.0
                </p>
            </div>
            
            <div class="terms-footer">
                <div class="terms-checkbox-container">
                    <input type="checkbox" id="termsCheckbox">
                    <label for="termsCheckbox">
                        <strong>Ho letto e accetto i Termini e Condizioni d'Uso</strong>. Riconosco di essere l'unico responsabile per i contenuti che carico.
                    </label>
                </div>
                <div class="terms-buttons">
                    <button class="terms-decline-btn" onclick="declineTerms()">‚ùå Rifiuta</button>
                    <button class="terms-accept-btn" id="termsAcceptBtn" disabled onclick="acceptTerms()">‚úÖ Accetta e Continua</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Menu Laterale -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigazione</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
        </div>
        <ul class="sidebar-nav">
            <li><a href="#" onclick="switchTab('upload')" class="nav-link active" data-tab="upload">üì§ Carica Foto</a></li>
            <li><a href="#" onclick="switchTab('vote')" class="nav-link" data-tab="vote">üó≥Ô∏è Vota Foto</a></li>
            <li><a href="#" onclick="switchTab('history')" class="nav-link" data-tab="history">üìä Cronologia</a></li>
            <li><a href="#" onclick="switchTab('leaderboard')" class="nav-link" data-tab="leaderboard">üèÜ Classifica</a></li>
			<li><a href="#" onclick="switchTab('achievements')" class="nav-link" data-tab="achievements">üéØ Achievement</a></li>
            <li><a href="#" onclick="switchTab('battle')" class="nav-link" data-tab="battle">‚öîÔ∏è Battaglia Smash <span class="new-badge">NEW</span></a></li>
            <li><a href="#" onclick="switchTab('moderation')" class="nav-link" data-tab="moderation">üõ°Ô∏è Moderazione</a></li>
            <li><a href="#" onclick="switchTab('settings')" class="nav-link" data-tab="settings">‚öôÔ∏è Impostazioni</a></li>
        </ul>
    </div>
    
    <!-- Overlay per chiudere il menu -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Bottone per aprire il menu -->
    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    
    <div class="container">
        <header>
            <h1>Smash or Pass <span class="cesaris">Cesaris Edition</span></h1>
            <p>Carica la tua foto anonimamente e vota le foto degli altri!</p>
        </header>
        
        <!-- Contenuto delle tabs -->
        <div class="tab-content active" id="upload-tab">
            <!-- Indicatore dei passaggi -->
            <div class="upload-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div>Scegli Genere</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div>Carica Foto</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div>Conferma</div>
                </div>
            </div>
            
            <!-- Passaggio 1: Scelta genere -->
            <div class="step-content active" id="step1-content">
                <h3>Step 1: Seleziona il genere</h3>
                <p>Scegli se stai caricando una foto di un ragazzo o una ragazza</p>
                
                <div class="gender-selection">
                    <button class="gender-btn male" data-gender="male" id="maleBtn">
                        üë¶ Ragazzo
                    </button>
                    <button class="gender-btn female" data-gender="female" id="femaleBtn">
                        üëß Ragazza
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="goToStep(2)" id="nextToStep2" disabled>
                        Avanti
                    </button>
                </div>
            </div>
            
            <!-- Passaggio 2: Caricamento foto -->
            <div class="step-content" id="step2-content">
                <h3>Step 2: Carica la tua foto</h3>
                <p id="selected-gender-text">Stai caricando una foto di: <strong id="current-gender"></strong></p>
                
                <div class="file-restrictions">
                    <h4>‚ö†Ô∏è Restrizioni File</h4>
                    <ul>
                        <li>‚úÖ <strong>Accettati:</strong> JPEG, PNG, WebP (immagini statiche)</li>
                        <li>‚ùå <strong>Non accettati:</strong> GIF animate, video, file eseguibili</li>
                        <li>üìè <strong>Dimensione massima:</strong> 5MB</li>
                    </ul>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i>üì∑</i>
                    <h3>Clicca qui per selezionare una foto</h3>
                    <p>Oppure trascina il file qui</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">Solo immagini statiche (JPEG, PNG, WebP)</p>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp">
                </div>
                
                <div class="preview-container">
                    <img id="previewImage" class="preview-image" alt="Anteprima" style="display: none;">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        Indietro
                    </button>
                    <button class="btn btn-primary" onclick="goToStep(3)" id="nextToStep3" disabled>
                        Avanti
                    </button>
                </div>
            </div>
            
            <!-- Passaggio 3: Conferma -->
            <div class="step-content" id="step3-content">
                <h3>Step 3: Conferma il caricamento</h3>
                
                <div class="preview-container">
                    <img id="confirmPreviewImage" class="preview-image" alt="Anteprima conferma">
                </div>
                
                <p><strong>Genere:</strong> <span id="confirm-gender"></span></p>
                <p style="color: #666; margin: 15px 0;">Controlla che tutto sia corretto prima di procedere</p>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">
                        Modifica
                    </button>
                    <button class="btn btn-primary" onclick="uploadPhoto()" id="uploadBtn">
                        üöÄ Carica Foto
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="vote-tab">
            <div class="voting-interface">
                <div class="gender-selection-vote">
                    <h3>Su chi vuoi votare?</h3>
                    <button class="gender-btn male active" data-gender="male" id="voteMaleBtn">
                        üë¶ Ragazzi
                    </button>
                    <button class="gender-btn female" data-gender="female" id="voteFemaleBtn">
                        üëß Ragazze
                    </button>
                </div>
                
                <div id="singlePhotoView">
                    <div class="loading" id="loadingIndicator">
                        Caricamento foto in corso...
                    </div>
                </div>
            </div>
        </div>
		<!-- TAB BATTAGLIA -->
        <div class="tab-content" id="battle-tab">
            <div class="battle-container">
                <h2 style="text-align: center; margin-bottom: 20px;">‚öîÔ∏è Battaglia Smash</h2>
                <p style="text-align: center; color: #666; margin-bottom: 30px;">Carica la tua foto e sfida gli altri! La battaglia dura 1 ora.</p>
                
                <div id="battleView">
                    <div class="loading">Caricamento battaglia...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="history-tab">
            <div class="vote-history">
                <div class="history-controls">
                    <h3>La tua cronologia voti</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" onclick="filterHistory('all')">Tutti</button>
                        <button class="filter-btn" onclick="filterHistory('smash')">Smash</button>
                        <button class="filter-btn" onclick="filterHistory('pass')">Pass</button>
                    </div>
                </div>
                
                <div id="historyList">
                    <div class="loading">Caricamento cronologia...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="leaderboard-tab">
            <div class="vote-history">
                <div class="history-controls">
                    <h3>Classifica Foto pi√π Popolari</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" onclick="filterLeaderboard('all')">Tutti</button>
                        <button class="filter-btn" onclick="filterLeaderboard('male')">Ragazzi</button>
                        <button class="filter-btn" onclick="filterLeaderboard('female')">Ragazze</button>
                    </div>
                </div>
                
                <div id="leaderboardList">
                    <div class="loading">Caricamento classifica...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="achievements-tab">
            <div class="vote-history">
                <h3>I Tuoi Achievement</h3>
                <p>Sblocca achievement completando diverse azioni nell'app!</p>
                
                <div id="achievementsList">
                    <div class="loading">Caricamento achievement...</div>
                </div>
            </div>
        </div>
        
        <!-- Tab per moderazione -->
        <div class="tab-content" id="moderation-tab">
            <div class="admin-panel">
                <h2>üõ°Ô∏è Pannello di Moderazione</h2>
                <p>Qui puoi gestire le foto segnalate dagli utenti.</p>
                
                <div class="settings-section">
                    <h3>Foto Segnalate</h3>
                    <div id="reportedPhotosList">
                        <div class="loading">Caricamento foto segnalate...</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary logout-btn" onclick="logoutModeration()">
                        üö™ Esci dalla Moderazione
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="settings-section">
                <h3>üí° Tema</h3>
                <p>Passa dalla modalit√† chiara a scura e viceversa</p>
                <div class="theme-switch">
                    <span>üåô Modalit√† Scura</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Importa/Esporta Dati</h3>
                <p>Salva i tuoi dati locali o importa dati precedenti</p>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="exportData()">
                        üì• Esporta Dati
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        üì§ Importa Dati
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Informazioni</h3>
                <p>Versione: 2.0</p>
                <p>Foto totali caricate: <span id="totalPhotos">0</span></p>
                <p>Voti totali: <span id="totalVotes">0</span></p>
            </div>
        </div>
    </div>

    <!-- Modal per password moderazione -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Accesso Moderazione</h3>
                <button class="close-modal" onclick="closeModal('passwordModal')">√ó</button>
            </div>
            <div>
                <p>Inserisci la password di moderazione:</p>
                <input type="password" id="moderationPasswordInput" class="password-input" placeholder="Password">
                <p id="attemptsInfo" style="color: #666; font-size: 14px; margin: 10px 0;">
                    Tentativi rimanenti: 3
                </p>
                <button class="btn btn-primary" onclick="handlePasswordSubmit()" style="width: 100%;">
                    Accedi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal per segnalazione -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Segnala Foto</h3>
                <button class="close-modal" onclick="closeModal('reportModal')">√ó</button>
            </div>
            <div id="reportContent">
                <p>Seleziona il motivo della segnalazione:</p>
                <select id="reportReason" class="password-input" style="width: 100%; margin-bottom: 15px;">
                    <option value="inappropriate">Contenuto inappropriato</option>
                    <option value="sexual">Contenuto sessuale</option>
                    <option value="fake">Foto non reale/falsa</option>
                    <option value="other">Altro</option>
                </select>
                <textarea id="reportDetails" class="password-input" placeholder="Dettagli aggiuntivi (opzionale)" style="width: 100%; height: 100px; margin-bottom: 15px;"></textarea>
                <button class="btn btn-primary" onclick="submitReport()" style="width: 100%;">Invia Segnalazione</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
<!-- Modal per selezione foto battaglia -->
    <div class="modal" id="battlePhotoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Seleziona Foto per la Battaglia</h3>
                <button class="close-modal" onclick="closeModal('battlePhotoModal')">√ó</button>
            </div>
            <div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="showUserPhotosForBattle()">
                        ‚úÖ Le Mie Foto
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="showUploadForBattle()">
                        üì∏ Carica Nuova
                    </button>
                </div>
                
                <div id="battlePhotoSelector">
                    <div class="loading">Caricamento...</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://rreyuxxnyhhahwkjxfiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZXl1eHhueWhoYWh3a2p4Zml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjIyNDgsImV4cCI6MjA3ODU5ODI0OH0.F_ZnqK10o8h-IY23_g9RzkPHqQVbpAvjQmw0awlApBE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variabili globali
        let selectedGender = null;
        let selectedFile = null;
        let currentVoteGender = 'male';
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let voteHistory = JSON.parse(localStorage.getItem('voteHistory') || '{}');
        let currentHistoryFilter = 'all';
        let currentLeaderboardFilter = 'all';
        let achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
        let currentPhotoForReport = null;
        // SISTEMA BATTAGLIA
        let currentBattle = null;
        let battleTimer = null;
        let currentBattleSlot = null;
        // SISTEMA MODERAZIONE
        let moderationAttempts = 3;
        let isModerationAuthenticated = false;
        const REPORT_THRESHOLD = 3;
        
        // Variabile globale per le statistiche utente
        let userStats = JSON.parse(localStorage.getItem('userStats') || '{}');
        
        // Inizializza le statistiche utente
        function initUserStats() {
            if (!userStats.votes) {
                userStats = {
                    votes: {
                        total: 0,
                        male: 0,
                        female: 0,
                        smash: 0,
                        pass: 0,
                        currentStreak: 0,
                        maxStreak: 0,
                        lastVoteDate: null
                    },
                    views: 0,
                    reports: 0,
                    uploads: 0,
                    achievementsUnlocked: 0,
                    sessions: 0,
                    lastLogin: null,
                    photos: {
                        uploaded: [],
                        totalSmashReceived: 0,
                        totalPassReceived: 0
                    }
                };
                localStorage.setItem('userStats', JSON.stringify(userStats));
            }
            
            userStats.sessions++;
            userStats.lastLogin = new Date().toISOString();
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }
        
        function updateVoteStats(vote, gender) {
            userStats.votes.total++;
            userStats.votes[vote]++;
            userStats.votes[gender]++;
            userStats.views++;
            
            const today = new Date().toDateString();
            if (userStats.votes.lastVoteDate === today) {
            } else if (userStats.votes.lastVoteDate === new Date(Date.now() - 86400000).toDateString()) {
                userStats.votes.currentStreak++;
            } else {
                userStats.votes.currentStreak = 1;
            }
            
            userStats.votes.lastVoteDate = today;
            userStats.votes.maxStreak = Math.max(userStats.votes.maxStreak, userStats.votes.currentStreak);
            
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }
        
        function updateUploadStats() {
            userStats.uploads++;
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }
        
        function updateReportStats() {
            userStats.reports++;
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }
        
        function updateAchievements() {
            const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            let updated = false;

            const voteCount = userStats.votes.total;
            const smashCount = userStats.votes.smash;
            const passCount = userStats.votes.pass;
            const maleVotes = userStats.votes.male;
            const femaleVotes = userStats.votes.female;

            if (voteCount >= 1 && !achievements.first_vote?.unlocked) {
                achievements.first_vote = { name: 'Primo Voto', description: 'Effettua il tuo primo voto', unlocked: true, icon: 'üéØ' };
                updated = true; showNotification('üéØ Achievement sbloccato: Primo Voto!');
            }
            if (voteCount >= 5 && !achievements.five_votes?.unlocked) {
                achievements.five_votes = { name: 'Votante Attivo', description: 'Effettua 5 voti', unlocked: true, icon: 'üèÜ' };
                updated = true; showNotification('üèÜ Achievement sbloccato: Votante Attivo!');
            }
            if (voteCount >= 10 && !achievements.ten_votes?.unlocked) {
                achievements.ten_votes = { name: 'Esperto di Bellezza', description: 'Effettua 10 voti', unlocked: true, icon: 'üëë' };
                updated = true; showNotification('üëë Achievement sbloccato: Esperto di Bellezza!');
            }
            if (voteCount >= 25 && !achievements.twenty_five_votes?.unlocked) {
                achievements.twenty_five_votes = { name: 'Giudice Instancabile', description: 'Effettua 25 voti', unlocked: true, icon: '‚ö°' };
                updated = true; showNotification('‚ö° Achievement sbloccato: Giudice Instancabile!');
            }
            if (voteCount >= 50 && !achievements.fifty_votes?.unlocked) {
                achievements.fifty_votes = { name: 'Maestro del Voto', description: 'Effettua 50 voti', unlocked: true, icon: 'üéñÔ∏è' };
                updated = true; showNotification('üéñÔ∏è Achievement sbloccato: Maestro del Voto!');
            }

            if (smashCount >= 10 && !achievements.ten_smash?.unlocked) {
                achievements.ten_smash = { name: 'Cuore Caldo', description: 'Dai 10 Smash', unlocked: true, icon: 'üòç' };
                updated = true; showNotification('üòç Achievement sbloccato: Cuore Caldo!');
            }
            if (smashCount >= 25 && !achievements.twenty_five_smash?.unlocked) {
                achievements.twenty_five_smash = { name: 'Romantico Incallito', description: 'Dai 25 Smash', unlocked: true, icon: 'üíñ' };
                updated = true; showNotification('üíñ Achievement sbloccato: Romantico Incallito!');
            }

            if (passCount >= 10 && !achievements.ten_pass?.unlocked) {
                achievements.ten_pass = { name: 'Severo ma Giusto', description: 'Dai 10 Pass', unlocked: true, icon: 'üòê' };
                updated = true; showNotification('üòê Achievement sbloccato: Severo ma Giusto!');
            }
            if (passCount >= 25 && !achievements.twenty_five_pass?.unlocked) {
                achievements.twenty_five_pass = { name: 'Critico Esperto', description: 'Dai 25 Pass', unlocked: true, icon: 'üéØ' };
                updated = true; showNotification('üéØ Achievement sbloccato: Critico Esperto!');
            }

            if (smashCount >= 10 && passCount >= 10 && !achievements.balanced_voter?.unlocked) {
                achievements.balanced_voter = { name: 'Equilibrato', description: '10 Smash e 10 Pass', unlocked: true, icon: '‚öñÔ∏è' };
                updated = true; showNotification('‚öñÔ∏è Achievement sbloccato: Equilibrato!');
            }

            if (maleVotes >= 10 && !achievements.male_lover?.unlocked) {
                achievements.male_lover = { name: 'Amante dei Ragazzi', description: 'Vota 10 foto di ragazzi', unlocked: true, icon: 'üë¶' };
                updated = true; showNotification('üë¶ Achievement sbloccato: Amante dei Ragazzi!');
            }
            if (femaleVotes >= 10 && !achievements.female_lover?.unlocked) {
                achievements.female_lover = { name: 'Amante delle Ragazze', description: 'Vota 10 foto di ragazze', unlocked: true, icon: 'üëß' };
                updated = true; showNotification('üëß Achievement sbloccato: Amante delle Ragazze!');
            }

            if (userStats.votes.currentStreak >= 3 && !achievements.three_day_streak?.unlocked) {
                achievements.three_day_streak = { name: 'Abitudinario', description: 'Vota per 3 giorni consecutivi', unlocked: true, icon: 'üî•' };
                updated = true; showNotification('üî• Achievement sbloccato: Abitudinario!');
            }
            if (userStats.votes.currentStreak >= 7 && !achievements.week_streak?.unlocked) {
                achievements.week_streak = { name: 'Fedele', description: 'Vota per 7 giorni consecutivi', unlocked: true, icon: 'üí´' };
                updated = true; showNotification('üí´ Achievement sbloccato: Fedele!');
            }

            if (userStats.uploads >= 1 && !achievements.first_upload?.unlocked) {
                achievements.first_upload = { name: 'Modello Emergente', description: 'Carica la tua prima foto', unlocked: true, icon: 'üì∏' };
                updated = true; showNotification('üì∏ Achievement sbloccato: Modello Emergente!');
            }
            if (userStats.uploads >= 3 && !achievements.three_uploads?.unlocked) {
                achievements.three_uploads = { name: 'Fotografo Amatoriale', description: 'Carica 3 foto', unlocked: true, icon: 'üåü' };
                updated = true; showNotification('üåü Achievement sbloccato: Fotografo Amatoriale!');
            }
            if (userStats.uploads >= 10 && !achievements.ten_uploads?.unlocked) {
                achievements.ten_uploads = { name: 'Content Creator', description: 'Carica 10 foto', unlocked: true, icon: 'üé≠' };
                updated = true; showNotification('üé≠ Achievement sbloccato: Content Creator!');
            }

            if (userStats.reports >= 5 && !achievements.vigilant?.unlocked) {
                achievements.vigilant = { name: 'Vigilante', description: 'Segnala 5 foto', unlocked: true, icon: 'üõ°Ô∏è' };
                updated = true; showNotification('üõ°Ô∏è Achievement sbloccato: Vigilante!');
            }

            if (updated) {
                const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
                userStats.achievementsUnlocked = unlockedCount;
                localStorage.setItem('userStats', JSON.stringify(userStats));
                
                if (unlockedCount >= 5 && !achievements.achievement_hunter?.unlocked) {
                    achievements.achievement_hunter = { name: 'Cacciatore di Achievement', description: 'Sblocca 5 achievements', unlocked: true, icon: 'üéñÔ∏è' };
                    showNotification('üéñÔ∏è Achievement sbloccato: Cacciatore di Achievement!');
                }
                if (unlockedCount >= 10 && !achievements.achievement_master?.unlocked) {
                    achievements.achievement_master = { name: 'Maestro degli Achievement', description: 'Sblocca 10 achievements', unlocked: true, icon: 'üèÖ' };
                    showNotification('üèÖ Achievement sbloccato: Maestro degli Achievement!');
                }
                
                localStorage.setItem('achievements', JSON.stringify(achievements));
            }
            
            return achievements;
        }
        
        function loadAchievements() {
            const defaultAchievements = {
                first_vote: { name: 'Primo Voto', description: 'Effettua il tuo primo voto', unlocked: false, icon: 'üéØ' },
                five_votes: { name: 'Votante Attivo', description: 'Effettua 5 voti', unlocked: false, icon: 'üèÜ' },
                ten_votes: { name: 'Esperto di Bellezza', description: 'Effettua 10 voti', unlocked: false, icon: 'üëë' },
                twenty_five_votes: { name: 'Giudice Instancabile', description: 'Effettua 25 voti', unlocked: false, icon: '‚ö°' },
                fifty_votes: { name: 'Maestro del Voto', description: 'Effettua 50 voti', unlocked: false, icon: 'üéñÔ∏è' },
                ten_smash: { name: 'Cuore Caldo', description: 'Dai 10 Smash', unlocked: false, icon: 'üòç' },
                twenty_five_smash: { name: 'Romantico Incallito', description: 'Dai 25 Smash', unlocked: false, icon: 'üíñ' },
                ten_pass: { name: 'Severo ma Giusto', description: 'Dai 10 Pass', unlocked: false, icon: 'üòê' },
                twenty_five_pass: { name: 'Critico Esperto', description: 'Dai 25 Pass', unlocked: false, icon: 'üéØ' },
                balanced_voter: { name: 'Equilibrato', description: '10 Smash e 10 Pass', unlocked: false, icon: '‚öñÔ∏è' },
                male_lover: { name: 'Amante dei Ragazzi', description: 'Vota 10 foto di ragazzi', unlocked: false, icon: 'üë¶' },
                female_lover: { name: 'Amante delle Ragazze', description: 'Vota 10 foto di ragazze', unlocked: false, icon: 'üëß' },
                three_day_streak: { name: 'Abitudinario', description: 'Vota per 3 giorni consecutivi', unlocked: false, icon: 'üî•' },
                week_streak: { name: 'Fedele', description: 'Vota per 7 giorni consecutivi', unlocked: false, icon: 'üí´' },
                first_upload: { name: 'Modello Emergente', description: 'Carica la tua prima foto', unlocked: false, icon: 'üì∏' },
                three_uploads: { name: 'Fotografo Amatoriale', description: 'Carica 3 foto', unlocked: false, icon: 'üåü' },
                ten_uploads: { name: 'Content Creator', description: 'Carica 10 foto', unlocked: false, icon: 'üé≠' },
                vigilant: { name: 'Vigilante', description: 'Segnala 5 foto', unlocked: false, icon: 'üõ°Ô∏è' },
                achievement_hunter: { name: 'Cacciatore di Achievement', description: 'Sblocca 5 achievements', unlocked: false, icon: 'üéñÔ∏è' },
                achievement_master: { name: 'Maestro degli Achievement', description: 'Sblocca 10 achievements', unlocked: false, icon: 'üèÖ' }
            };

            let currentAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            achievements = { ...defaultAchievements, ...currentAchievements };
            localStorage.setItem('achievements', JSON.stringify(achievements));
            
            return achievements;
        }
        
        function loadAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            
            updateAchievements();
            
            const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            const userStats = JSON.parse(localStorage.getItem('userStats') || '{}');
            
            if (Object.keys(achievements).length === 0) {
                achievementsList.innerHTML = `
                    <div class="empty-state">
                        <p>Non hai ancora sbloccato nessun achievement.</p>
                        <p>Vota alcune foto o carica la tua prima foto per sbloccarli!</p>
                    </div>
                `;
                return;
            }

            const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
            const totalCount = Object.keys(achievements).length;
            const progress = Math.round((unlockedCount / totalCount) * 100);

            achievementsList.innerHTML = `
                <div class="achievement-progress">
                    <h3>Progresso Achievements</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                        <span>${unlockedCount}/${totalCount} Sbloccati</span>
                        <span>${progress}%</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #FFD700; height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                
                <div class="achievements-grid">
                    ${Object.entries(achievements).map(([key, achievement]) => `
                        <div class="achievement-item ${achievement.unlocked ? '' : 'achievement-locked'}" 
                             style="padding: 15px; border-radius: 10px; background: ${achievement.unlocked ? '#f8fff8' : '#f5f5f5'}; border: 2px solid ${achievement.unlocked ? '#4CAF50' : '#ddd'};">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 2em; filter: ${achievement.unlocked ? 'none' : 'grayscale(100%)'};">${achievement.icon}</div>
                                <div style="flex-grow: 1;">
                                    <h4 style="margin: 0 0 5px 0; color: ${achievement.unlocked ? '#333' : '#999'};">${achievement.name}</h4>
                                    <p style="margin: 0; font-size: 0.9em; color: ${achievement.unlocked ? '#666' : '#999'};">${achievement.description}</p>
                                    <small style="color: ${achievement.unlocked ? '#4CAF50' : '#999'};">${achievement.unlocked ? '‚úÖ Sbloccato' : 'üîí Bloccato'}</small>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function initDarkMode() {
            const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeToggle').checked = darkModeEnabled;
            updateDarkMode(darkModeEnabled);
        }

        function updateDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('darkMode', enabled);
        }

        function resetModerationAttempts() {
            moderationAttempts = 3;
            const attemptsInfo = document.getElementById('attemptsInfo');
            if (attemptsInfo) {
                attemptsInfo.textContent = `Tentativi rimanenti: ${moderationAttempts}`;
            }
        }

document.addEventListener('DOMContentLoaded', function() {
 // Controlla accettazione termini
    if (!checkTermsAcceptance()) {
        // Se i termini non sono accettati, setup degli event listeners per i termini
        setupTermsEventListeners();
        return;
    }
    
    // Se i termini sono gi√† accettati, procedi con il normale setup
    setupMainApp();
});

function setupTermsEventListeners() {
    const termsCheckbox = document.getElementById('termsCheckbox');
    const termsAcceptBtn = document.getElementById('termsAcceptBtn');
    
    if (termsCheckbox && termsAcceptBtn) {
        // Rimuovi qualsiasi event listener esistente e aggiungine uno nuovo
        termsCheckbox.addEventListener('change', function() {
            termsAcceptBtn.disabled = !this.checked;
            console.log('Checkbox cambiato:', this.checked);
        });
        
        // Forza un controllo iniziale
        termsAcceptBtn.disabled = !termsCheckbox.checked;
    } else {
        console.error('Elementi termini non trovati!');
    }
}

function setupMainApp()
    {
    // Event listener per dark mode
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('change', function() {
            updateDarkMode(this.checked);
        });
    }
    
    initUserStats();
    initEventListeners();
    loadPhotosForVoting();
    loadAchievements();
    loadStats();
    initDarkMode();
};
        
        function handleFileSelection(file) {
            if (!file) {
                showNotification('Nessun file selezionato!', true);
                return;
            }
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const fileExtension = file.name.toLowerCase().split('.').pop();
            const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp'];
            
            if (file.type === 'image/gif') {
                showNotification('Le GIF animate non sono permesse!', true);
                return;
            }
            
            if (!allowedTypes.includes(file.type) || !allowedExtensions.includes(fileExtension)) {
                showNotification('Tipo di file non supportato! Usa solo JPEG, PNG o WebP.', true);
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('L\'immagine √® troppo grande! Massimo 5MB.', true);
                return;
            }
            
            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const previewImage = document.getElementById('previewImage');
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    document.getElementById('nextToStep3').disabled = false;
                };
                img.onerror = function() {
                    showNotification('Il file selezionato non √® un\'immagine valida!', true);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showCurrentPhoto() {
            const singlePhotoView = document.getElementById('singlePhotoView');
            
            if (currentPhotoIndex >= currentPhotos.length) {
                singlePhotoView.innerHTML = `
                    <div class="empty-state">
                        <p>Hai visto tutte le foto disponibili!</p>
                        <p>Torna pi√π tardi per nuove foto o cambia genere.</p>
                    </div>
                `;
                return;
            }
            
            const photo = currentPhotos[currentPhotoIndex];
            const totalVotes = photo.smash_count + photo.pass_count;
            const smashPercentage = totalVotes > 0 ? (photo.smash_count / totalVotes) * 100 : 0;
            const passPercentage = totalVotes > 0 ? (photo.pass_count / totalVotes) * 100 : 0;
            
            const userVote = voteHistory[photo.id];
            
            singlePhotoView.innerHTML = `
                <div class="photo-container">
                    <img src="${photo.image_url}" class="current-photo" alt="Foto da votare" onerror="this.src='https://via.placeholder.com/400x500/2a5298/ffffff?text=Errore+Caricamento'">
                </div>
                
                <div class="progress-container-single">
                    <div class="progress-bar-single">
                        <div class="progress-fill smash" style="width: ${smashPercentage}%"></div>
                        <div class="progress-fill pass" style="width: ${passPercentage}%"></div>
                    </div>
                    <div class="stats-single">
                        <span class="smash-stat">${photo.smash_count} SMASH</span>
                        <span class="pass-stat">${photo.pass_count} PASS</span>
                    </div>
                </div>
                
                ${userVote ? `
                    <div style="text-align: center; margin: 20px 0;">
                        <p><strong>Hai gi√† votato: ${userVote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</strong></p>
                        <button class="btn btn-secondary" onclick="currentPhotoIndex++; showCurrentPhoto();">
                            Vota Prossima Foto
                        </button>
                        <button class="report-btn" onclick="openReportModal('${photo.id}')">
                            ‚ö†Ô∏è Segnala
                        </button>
                    </div>
                ` : `
                    <div class="vote-buttons-single">
                        <button class="pass-btn-single" onclick="voteCurrentPhoto('pass')">
                            üòê PASS
                        </button>
                        <button class="smash-btn-single" onclick="voteCurrentPhoto('smash')">
                            üòç SMASH
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="report-btn" onclick="openReportModal('${photo.id}')">
                            ‚ö†Ô∏è Segnala questa foto
                        </button>
                    </div>
                `}
            `;
        }

        // SISTEMA DI SEGNALAZIONE CON PROTEZIONE PER FOTO APPROVATE
        async function submitReport() {
            if (!currentPhotoForReport) return;

            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value;
            
            try {
                console.log('Iniziando segnalazione per foto:', currentPhotoForReport);
                
                // VERIFICA SE LA FOTO √à STATA APPROVATA DALLA MODERAZIONE
                const { data: photoCheck, error: checkError } = await supabase
                    .from('photos')
                    .select('moderation_approved')
                    .eq('id', currentPhotoForReport)
                    .single();
                
                if (checkError) {
                    console.error('Errore nella verifica della foto:', checkError);
                }
                
                // Se la foto √® stata approvata, informiamo l'utente ma registriamo comunque il report
                if (photoCheck && photoCheck.moderation_approved === true) {
                    showNotification('Questa foto √® stata verificata dai moderatori. La segnalazione verr√† comunque registrata per revisione.', false, 'info');
                }
                
                const reportData = {
                    photo_id: currentPhotoForReport,
                    reason: reason,
                    details: details || null,
                    reported_at: new Date().toISOString()
                };
                
                console.log('Inserendo report:', reportData);
                
                const { data: reportResult, error: reportError } = await supabase
                    .from('reports')
                    .insert([reportData]);
                
                if (reportError) {
                    console.error('Errore nell\'inserimento del report:', reportError);
                }
                
                // AGGIORNA IL CONTEGGIO SOLO SE NON √à APPROVATA
                try {
                    const { data: currentPhoto, error: fetchError } = await supabase
                        .from('photos')
                        .select('report_count, status, moderation_approved')
                        .eq('id', currentPhotoForReport)
                        .single();
                    
                    if (fetchError) {
                        console.warn('Impossibile ottenere dati foto:', fetchError);
                    } else {
                        const newReportCount = (currentPhoto.report_count || 0) + 1;
                        
                        const { error: updateError } = await supabase
                            .from('photos')
                            .update({ 
                                report_count: newReportCount
                            })
                            .eq('id', currentPhotoForReport);
                        
                        if (updateError) {
                            console.error('Errore aggiornamento conteggio:', updateError);
                        } else {
                            console.log('Conteggio aggiornato a:', newReportCount);
                            
                            // SOSPENSIONE AUTOMATICA SOLO SE NON √à STATA APPROVATA
                            if (currentPhoto.moderation_approved !== true && newReportCount >= REPORT_THRESHOLD && currentPhoto.status === 'active') {
                                await suspendPhoto(currentPhotoForReport);
                            } else if (currentPhoto.moderation_approved === true) {
                                console.log('Foto approvata dalla moderazione - sospensione automatica disattivata');
                            }
                        }
                    }
                } catch (updateError) {
                    console.error('Errore nell\'aggiornamento:', updateError);
                }
                
                updateReportStats();
                updateAchievements();
                
                showNotification('Segnalazione inviata con successo!', false, 'success');
                closeModal('reportModal');
                
            } catch (error) {
                console.error('Errore durante la segnalazione:', error);
                showNotification('Errore durante la segnalazione. Riprova.', true);
            }
        }

        async function suspendPhoto(photoId) {
            try {
                console.log(`Sospendendo automaticamente la foto ${photoId} per troppe segnalazioni`);
                
                const { error } = await supabase
                    .from('photos')
                    .update({ 
                        status: 'suspended',
                        suspended_at: new Date().toISOString()
                    })
                    .eq('id', photoId);
                
                if (error) {
                    console.error('Errore sospensione automatica:', error);
                    await supabase
                        .from('photos')
                        .update({ status: 'suspended' })
                        .eq('id', photoId);
                }
                
                showNotification('Foto sospesa automaticamente per troppe segnalazioni!', false, 'warning');
                
                if (document.getElementById('moderation-tab').classList.contains('active')) {
                    loadReportedPhotos();
                }
                
            } catch (error) {
                console.error('Errore durante la sospensione automatica:', error);
            }
        }

        async function changeVote(photoId, newVote) {
            try {
                const { data: photo, error: fetchError } = await supabase
                    .from('photos')
                    .select('smash_count, pass_count')
                    .eq('id', photoId)
                    .single();
                
                if (fetchError) throw new Error('Foto non trovata');
                
                const oldVote = voteHistory[photoId];
                
                let updateData = {};
                
                if (oldVote === 'smash' && newVote === 'pass') {
                    updateData = {
                        smash_count: photo.smash_count - 1,
                        pass_count: photo.pass_count + 1
                    };
                } else if (oldVote === 'pass' && newVote === 'smash') {
                    updateData = {
                        smash_count: photo.smash_count + 1,
                        pass_count: photo.pass_count - 1
                    };
                }
                
                const { error: updateError } = await supabase
                    .from('photos')
                    .update(updateData)
                    .eq('id', photoId);
                
                if (updateError) throw new Error('Errore nell\'aggiornamento del voto');
                
                voteHistory[photoId] = newVote;
                localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
                
                showNotification(`Voto cambiato in ${newVote === 'smash' ? 'SMASH' : 'PASS'}!`, false, 'success');
                
                loadVoteHistory();
                
            } catch (error) {
                console.error('Errore durante il cambio di voto:', error);
                showNotification('Errore durante il cambio di voto. Riprova.', true);
            }
        }

        async function loadReportedPhotos() {
            if (!isModerationAuthenticated) return;
            
            const reportedPhotosList = document.getElementById('reportedPhotosList');
            reportedPhotosList.innerHTML = '<div class="loading">Caricamento foto segnalate...</div>';
            
            try {
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .gt('report_count', 0)
                    .order('report_count', { ascending: false });
                
                if (error) throw error;
                
                if (!photos || photos.length === 0) {
                    reportedPhotosList.innerHTML = '<div class="empty-state"><p>Nessuna foto segnalata</p></div>';
                    return;
                }

                const photosWithReports = await Promise.all(
                    photos.map(async (photo) => {
                        const { data: reports, error: reportsError } = await supabase
                            .from('reports')
                            .select('*')
                            .eq('photo_id', photo.id)
                            .order('reported_at', { ascending: false });
                        
                        return {
                            ...photo,
                            reports: reports || []
                        };
                    })
                );
                // Carica battaglie attive
const { data: activeBattles } = await supabase
    .from('battles')
    .select('*')
    .eq('status', 'active')
    .order('created_at', { ascending: false });

let battlesHTML = '';
if (activeBattles && activeBattles.length > 0) {
    battlesHTML = `
        <div class="settings-section" style="margin-bottom: 30px;">
            <h3>‚öîÔ∏è Battaglie Attive</h3>
            ${activeBattles.map(battle => `
                <div class="reported-photo">
                    <h4>Battaglia ID: ${battle.id.substring(0, 8)}...</h4>
                    <p><strong>Voti Foto 1:</strong> ${battle.votes1} | <strong>Voti Foto 2:</strong> ${battle.votes2}</p>
                    <p><strong>Inizio:</strong> ${new Date(battle.start_time).toLocaleString('it-IT')}</p>
                    <p><strong>Fine prevista:</strong> ${new Date(battle.end_time).toLocaleString('it-IT')}</p>
                    <div class="admin-actions">
                        <button class="admin-btn reject-btn" onclick="forceEndBattleFromMod('${battle.id}')">
                            ‚ö†Ô∏è Termina Battaglia
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

reportedPhotosList.innerHTML = battlesHTML + photosWithReports.map(photo => {
                
                    return `
                        <div class="reported-photo">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <img src="${photo.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; margin-right: 15px;" onerror="this.style.display='none'">
                                <div style="flex-grow: 1;">
                                    <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}
                                    ${photo.moderation_approved ? '<span class="approved-badge">‚úÖ Approvata</span>' : ''}
                                    ${photo.status === 'suspended' ? '<span class="suspended-badge">‚è∏Ô∏è Sospesa</span>' : ''}
                                    </h4>
                                    <p><strong>Segnalazioni:</strong> ${photo.report_count || 0}</p>
                                    <p><strong>Smash:</strong> ${photo.smash_count} | <strong>Pass:</strong> ${photo.pass_count}</p>
                                    <p><strong>Stato:</strong> ${photo.status || 'active'}</p>
                                    ${photo.moderation_approved ? '<p style="color: #4CAF50; font-weight: bold;">‚ö†Ô∏è Sospensione automatica disattivata</p>' : ''}
                                </div>
                            </div>
                            
                            ${photo.reports.length > 0 ? `
                                <div class="report-details">
                                    <h4>Dettagli Segnalazioni (${photo.reports.length}):</h4>
                                    ${photo.reports.map((report, index) => `
                                        <div class="report-item">
                                            <p><strong>Segnalazione #${index + 1}:</strong></p>
                                            <p><strong>Motivo:</strong> ${report.reason}</p>
                                            <p><strong>Dettagli:</strong> ${report.details || 'Nessun dettaglio aggiuntivo'}</p>
                                            <p><strong>Data:</strong> ${new Date(report.reported_at).toLocaleString('it-IT')}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>Nessun dettaglio disponibile per le segnalazioni</p>'}
                            
                            <div class="admin-actions">
                                <button class="admin-btn approve-btn" onclick="approvePhoto('${photo.id}')">‚úÖ Approva e Proteggi</button>
                                <button class="admin-btn reject-btn" onclick="rejectPhoto('${photo.id}')">‚ùå Rimuovi</button>
                                ${photo.status !== 'suspended' ? `<button class="btn btn-secondary" onclick="suspendPhotoManually('${photo.id}')">‚è∏Ô∏è Sospendi</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Errore nel caricamento delle foto segnalate:', error);
                reportedPhotosList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento</p></div>';
            }
        }

        async function approvePhoto(photoId) {
            try {
                // IMPOSTA moderation_approved A true PER DISATTIVARE LA SOSPENSIONE AUTOMATICA
                const { error } = await supabase
                    .from('photos')
                    .update({ 
                        report_count: 0, 
                        status: 'active',
                        moderation_approved: true  // CHIAVE: Questo disattiva la sospensione automatica
                    })
                    .eq('id', photoId);
                
                if (error) throw error;
                
                showNotification('Foto approvata! La sospensione automatica √® stata disattivata per questa foto.', false, 'success');
                loadReportedPhotos();
                
            } catch (error) {
                console.error('Errore durante l\'approvazione:', error);
                showNotification('Errore durante l\'approvazione. Riprova.', true);
            }
        }

        async function suspendPhotoManually(photoId) {
            if (!confirm('Sei sicuro di voler sospendere manualmente questa foto?')) return;
            
            try {
                const { error } = await supabase
                    .from('photos')
                    .update({ 
                        status: 'suspended',
                        suspended_at: new Date().toISOString()
                    })
                    .eq('id', photoId);
                
                if (error) throw error;
                
                showNotification('Foto sospesa manualmente!', false, 'warning');
                loadReportedPhotos();
                
            } catch (error) {
                console.error('Errore durante la sospensione:', error);
                showNotification('Errore durante la sospensione. Riprova.', true);
            }
        }

        async function rejectPhoto(photoId) {
            if (!confirm('Sei sicuro di voler eliminare questa foto?')) return;
            
            try {
                const { data: photo, error: fetchError } = await supabase
                    .from('photos')
                    .select('image_url')
                    .eq('id', photoId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                const imagePath = photo.image_url.split('/').pop();
                
                if (imagePath && imagePath !== 'undefined') {
                    await supabase.storage.from('photo-uploads').remove([imagePath]);
                }
                
                await supabase.from('reports').delete().eq('photo_id', photoId);
                await supabase.from('photos').delete().eq('id', photoId);
                
                showNotification('Foto eliminata definitivamente!');
                loadReportedPhotos();
                
            } catch (error) {
                console.error('Errore durante l\'eliminazione:', error);
                showNotification('Errore durante l\'eliminazione. Riprova.', true);
            }
        }

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) stepEl.classList.add('completed');
                else if (index + 1 === step) stepEl.classList.add('active');
            });
            
            document.getElementById(`step${step}-content`).classList.add('active');
            
            if (step === 3) {
                document.getElementById('confirmPreviewImage').src = document.getElementById('previewImage').src;
                document.getElementById('confirm-gender').textContent = selectedGender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza';
            }
        }
        
        function selectGender(gender) {
            selectedGender = gender;
            document.querySelectorAll('#step1-content .gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (gender === 'male') {
                document.getElementById('maleBtn').classList.add('active');
            } else {
                document.getElementById('femaleBtn').classList.add('active');
            }
            
            document.getElementById('nextToStep2').disabled = false;
            document.getElementById('current-gender').textContent = gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza';
        }
        
        function selectVoteGender(gender) {
            currentVoteGender = gender;
            document.querySelectorAll('.gender-selection-vote .gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (gender === 'male') {
                document.getElementById('voteMaleBtn').classList.add('active');
            } else {
                document.getElementById('voteFemaleBtn').classList.add('active');
            }
            
            loadPhotosForVoting();
        }
        
        async function loadPhotosForVoting() {
            const singlePhotoView = document.getElementById('singlePhotoView');
            singlePhotoView.innerHTML = '<div class="loading">Caricamento foto in corso...</div>';

            try {
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('gender', currentVoteGender)
                    .eq('status', 'active')
                    .limit(10);

                if (error) throw error;

                if (!photos || photos.length === 0) {
                    singlePhotoView.innerHTML = `
                        <div class="empty-state">
                            <p>Nessuna foto disponibile per i ${currentVoteGender === 'male' ? 'ragazzi' : 'ragazze'}.</p>
                        </div>
                    `;
                    return;
                }

                const unvotedPhotos = photos.filter(photo => !voteHistory[photo.id]);
                
                if (unvotedPhotos.length === 0) {
                    singlePhotoView.innerHTML = `
                        <div class="empty-state">
                            <p>Hai gi√† votato tutte le foto disponibili!</p>
                        </div>
                    `;
                    return;
                }

                currentPhotos = unvotedPhotos;
                currentPhotoIndex = 0;
                showCurrentPhoto();

            } catch (error) {
                console.error('Errore nel caricamento delle foto:', error);
                singlePhotoView.innerHTML = `
                    <div class="empty-state">
                        <p>Errore nel caricamento delle foto.</p>
                    </div>
                `;
            }
        }
        
        async function voteCurrentPhoto(vote) {
            if (currentPhotoIndex >= currentPhotos.length) return;
            
            const photo = currentPhotos[currentPhotoIndex];
            const photoContainer = document.querySelector('.photo-container');
            
            if (vote === 'smash') {
                photoContainer.classList.add('smash-effect');
            } else {
                photoContainer.classList.add('pass-effect');
            }
            
            voteHistory[photo.id] = vote;
            localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
            
            updateVoteStats(vote, photo.gender);
            updateAchievements();
            
            try {
                const updateField = vote === 'smash' ? 'smash_count' : 'pass_count';
                const { error } = await supabase
                    .from('photos')
                    .update({ [updateField]: photo[updateField] + 1 })
                    .eq('id', photo.id);
                
                if (error) throw error;
                
                showNotification(`Hai votato: ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}`, false, 'info');
                
                setTimeout(() => {
                    currentPhotoIndex++;
                    showCurrentPhoto();
                }, 800);
                
            } catch (error) {
                console.error('Errore durante il voto:', error);
                showNotification('Errore durante il voto. Riprova.', true);
            }
        }
        
        async function loadVoteHistory() { 
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="loading">Caricamento cronologia...</div>';

            try {
                const historyEntries = Object.entries(voteHistory);
                
                if (historyEntries.length === 0) {
                    historyList.innerHTML = '<div class="empty-state"><p>Non hai ancora votato nessuna foto.</p></div>';
                    return;
                }

                const photoIds = historyEntries.map(([photoId]) => photoId);
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .in('id', photoIds);

                if (error) throw error;

                const photosMap = {};
                const existingPhotoIds = new Set();
                
                if (photos) {
                    photos.forEach(photo => {
                        photosMap[photo.id] = photo;
                        existingPhotoIds.add(photo.id);
                    });
                }

                let updatedVoteHistory = { ...voteHistory };
                let removedCount = 0;
                
                Object.keys(voteHistory).forEach(photoId => {
                    if (!existingPhotoIds.has(photoId)) {
                        delete updatedVoteHistory[photoId];
                        removedCount++;
                    }
                });

                if (removedCount > 0) {
                    voteHistory = updatedVoteHistory;
                    localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
                    console.log(`Rimosse ${removedCount} foto non pi√π esistenti dalla cronologia`);
                }

                const filteredHistoryEntries = Object.entries(voteHistory);

                const finalFilteredEntries = filteredHistoryEntries.filter(([photoId, vote]) => {
                    if (currentHistoryFilter === 'all') return true;
                    return vote === currentHistoryFilter;
                });

                if (finalFilteredEntries.length === 0) {
                    historyList.innerHTML = '<div class="empty-state"><p>Nessun voto corrisponde al filtro selezionato.</p></div>';
                    return;
                }

                historyList.innerHTML = finalFilteredEntries.map(([photoId, vote]) => {
                    const photo = photosMap[photoId];
                    
                    if (!photo) {
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <p><strong>Foto ID:</strong> ${photoId.substring(0, 8)}...</p>
                                    <p><strong>Voto:</strong> ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</p>
                                    <p><em>Foto rimossa - aggiorna la pagina</em></p>
                                </div>
                                <div class="history-vote ${vote}">
                                    ${vote === 'smash' ? 'SMASH' : 'PASS'}
                                </div>
                            </div>
                        `;
                    }

                    const oppositeVote = vote === 'smash' ? 'pass' : 'smash';
                    const oppositeText = vote === 'smash' ? 'PASS' : 'SMASH';
                    const oppositeEmoji = vote === 'smash' ? 'üòê' : 'üòç';

                    return `
                        <div class="history-item">
                            <img src="${photo.image_url}" class="history-photo" alt="Foto votata" onerror="this.style.display='none'">
                            <div class="history-info">
                                <p><strong>Genere:</strong> ${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</p>
                                <p><strong>Statistiche:</strong> ${photo.smash_count} üòç | ${photo.pass_count} üòê</p>
                                <p><strong>Il tuo voto:</strong> ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</p>
                            </div>
                            <div class="history-vote ${vote}">
                                ${vote === 'smash' ? 'SMASH' : 'PASS'}
                            </div>
                            <button class="change-vote-btn" onclick="changeVote('${photo.id}', '${oppositeVote}')">
                                Cambia in ${oppositeEmoji} ${oppositeText}
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Errore nel caricamento della cronologia:', error);
                historyList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento della cronologia.</p></div>';
            }
        }
        
        function filterHistory(filter) {
            currentHistoryFilter = filter;
            document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadVoteHistory();
        }
        
        async function loadLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '<div class="loading">Caricamento classifica...</div>';
            
            try {
                let query = supabase
                    .from('photos')
                    .select('*')
                    .eq('status', 'active')
                    .order('smash_count', { ascending: false })
                    .limit(20);
                
                if (currentLeaderboardFilter !== 'all') {
                    query = query.eq('gender', currentLeaderboardFilter);
                }
                
                const { data: photos, error } = await query;
                
                if (error) throw error;
                
                if (!photos || photos.length === 0) {
                    leaderboardList.innerHTML = '<div class="empty-state"><p>Nessuna foto in classifica.</p></div>';
                    return;
                }
                
                leaderboardList.innerHTML = photos.map((photo, index) => {
                    return `
                        <div class="leaderboard-item">
                            <div class="leaderboard-rank">${index + 1}</div>
                            <img src="${photo.image_url}" class="leaderboard-photo" alt="Foto" onerror="this.style.display='none'">
                            <div class="leaderboard-info">
                                <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</h4>
                            </div>
                            <div class="leaderboard-score">
                                ${photo.smash_count} üòç
                            </div>
                            <button class="report-btn" onclick="openReportModal('${photo.id}')">
                                ‚ö†Ô∏è
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Errore nel caricamento della classifica:', error);
                leaderboardList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento della classifica.</p></div>';
            }
        }
        
        function filterLeaderboard(filter) {
            currentLeaderboardFilter = filter;
            document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadLeaderboard();
        }
        
        async function loadStats() {
            try {
                const { data: photos, error: photosError } = await supabase
                    .from('photos')
                    .select('id', { count: 'exact' });
                
                const { data: allPhotos, error: votesError } = await supabase
                    .from('photos')
                    .select('smash_count, pass_count');
                
                if (photosError || votesError) throw new Error('Errore nel caricamento delle statistiche');
                
                let totalVotes = 0;
                if (allPhotos) {
                    allPhotos.forEach(photo => {
                        totalVotes += photo.smash_count + photo.pass_count;
                    });
                }
                
                document.getElementById('totalPhotos').textContent = photos ? photos.length : 0;
                document.getElementById('totalVotes').textContent = totalVotes;
                
            } catch (error) {
                console.error('Errore nel caricamento delle statistiche:', error);
            }
        }
        
        async function uploadPhoto() {
            if (!selectedFile || !selectedGender) {
                showNotification('Seleziona prima una foto e un genere!', true);
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Caricamento...';
            
            try {
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('photo-uploads')
                    .upload(fileName, selectedFile);
                
                if (uploadError) throw uploadError;
                
                const { data: urlData } = supabase.storage
                    .from('photo-uploads')
                    .getPublicUrl(fileName);
                
                const { error: dbError } = await supabase
                    .from('photos')
                    .insert([{
                        image_url: urlData.publicUrl,
                        gender: selectedGender,
                        smash_count: 0,
                        pass_count: 0,
                        report_count: 0,
                        status: 'active',
                        moderation_approved: false
                    }]);
                
                if (dbError) throw dbError;
                
                updateUploadStats();
                updateAchievements();
                
                showNotification('Foto caricata con successo!');
                
                setTimeout(() => {
                    selectedFile = null;
                    selectedGender = null;
                    document.getElementById('previewImage').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    goToStep(1);
                    
                    document.querySelectorAll('#step1-content .gender-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.getElementById('nextToStep2').disabled = true;
                    
                }, 1000);
                
            } catch (error) {
                console.error('Errore durante il caricamento:', error);
                showNotification('Errore durante il caricamento. Riprova.', true);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Carica Foto';
            }
        }
        
        function openReportModal(photoId) {
            currentPhotoForReport = photoId;
            document.getElementById('reportModal').style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'reportModal') {
                document.getElementById('reportReason').value = 'inappropriate';
                document.getElementById('reportDetails').value = '';
            }
        }
        
        function showNotification(message, isError = false, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
            } else if (type === 'info') {
                notification.classList.add('info');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            } else if (type === 'success') {
                notification.classList.add('success');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        async function verifyPasswordWithSupabase(password) {
            try {
                const { data, error } = await supabase
                    .rpc('verify_moderation_access', { input_key: password });
                
                if (error) return false;
                return data.valid;
                
            } catch (error) {
                return false;
            }
        }

        async function checkModerationPassword(inputPassword) {
            if (moderationAttempts <= 0) {
                showNotification('Accesso bloccato! Tentativi esauriti.', true);
                return false;
            }
            
            const isValid = await verifyPasswordWithSupabase(inputPassword);
            
            if (!isValid) {
                moderationAttempts--;
                
                if (moderationAttempts <= 0) {
                    showNotification('Accesso bloccato! Tentativi esauriti.', true);
                } else {
                    showNotification(`Password errata! Tentativi rimanenti: ${moderationAttempts}`, true);
                }
                
                const attemptsInfo = document.getElementById('attemptsInfo');
                if (attemptsInfo) {
                    attemptsInfo.textContent = `Tentativi rimanenti: ${moderationAttempts}`;
                }
            } else {
                moderationAttempts = 3;
                isModerationAuthenticated = true;
                showNotification('Accesso moderazione consentito!', false, 'success');
            }
            
            return isValid;
        }

        function showPasswordModal() {
            resetModerationAttempts();
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('attemptsInfo').textContent = `Tentativi rimanenti: ${moderationAttempts}`;
            document.getElementById('moderationPasswordInput').value = '';
        }

        async function handlePasswordSubmit() {
            const passwordInput = document.getElementById('moderationPasswordInput');
            const password = passwordInput.value;
            
            if (!password) {
                showNotification('Inserisci una password!', true);
                return;
            }
            
            const isValid = await checkModerationPassword(password);
            
            if (isValid) {
                closeModal('passwordModal');
                switchTab('moderation');
            } else {
                const attemptsInfo = document.getElementById('attemptsInfo');
                if (attemptsInfo) {
                    attemptsInfo.textContent = `Tentativi rimanenti: ${moderationAttempts}`;
                }
                passwordInput.value = '';
            }
        }

        function logoutModeration() {
            isModerationAuthenticated = false;
            showNotification('Disconnesso dalla moderazione', false, 'info');
            
            if (document.getElementById('moderation-tab').classList.contains('active')) {
                switchTab('upload');
            }
        }

        function initEventListeners() {
            document.getElementById('maleBtn').addEventListener('click', function() {
                selectGender('male');
            });
            
            document.getElementById('femaleBtn').addEventListener('click', function() {
                selectGender('female');
            });
            
            document.getElementById('voteMaleBtn').addEventListener('click', function() {
                selectVoteGender('male');
            });
            
            document.getElementById('voteFemaleBtn').addEventListener('click', function() {
                selectVoteGender('female');
            });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleFileSelection(e.target.files[0]);
                }
            });
            
            document.getElementById('importFile').addEventListener('change', function(e) {
                if (e.target.files.length) {
                    importData(e.target.files[0]);
                }
            });
            
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f4ff';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('vote-tab').classList.contains('active')) {
                    switch(e.key) {
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            voteCurrentPhoto('pass');
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            voteCurrentPhoto('smash');
                            break;
                        case ' ':
                            e.preventDefault();
                            currentPhotoIndex++;
                            showCurrentPhoto();
                            break;
                    }
                }
            });
        }

   function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
}
        
        function switchTab(tabName) {
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'moderation') {
                if (!isModerationAuthenticated) {
                    if (moderationAttempts > 0) {
                        showPasswordModal();
                        return;
                    } else {
                        showNotification('Hai esaurito i tentativi di accesso!', true);
                        return;
                    }
                }
            }
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-tab') === tabName) {
                    link.classList.add('active');
                }
            });
            
            if (tabName === 'vote') {
                loadPhotosForVoting();
            } else if (tabName === 'history') {
                loadVoteHistory();
            } else if (tabName === 'leaderboard') {
                loadLeaderboard();
            } else if (tabName === 'achievements') {
                loadAchievementsDisplay();
            } else if (tabName === 'moderation' && isModerationAuthenticated) {
                loadReportedPhotos();
            } else if (tabName === 'settings') {
                loadStats();
            } else if (tabName === 'battle') {
                loadCurrentBattle();
            }
        }
		// ============================================
        // GESTIONE TERMINI E CONDIZIONI
        // ============================================
        
        function checkTermsAcceptance() {
            const termsAccepted = localStorage.getItem('termsAccepted');
            if (!termsAccepted || termsAccepted !== 'true') {
                document.getElementById('termsOverlay').style.display = 'flex';
                return false;
            }
            return true;
        }

 function acceptTerms() {
    try {
        localStorage.setItem('termsAccepted', 'true');
        localStorage.setItem('termsAcceptedDate', new Date().toISOString());
        document.getElementById('termsOverlay').style.display = 'none';
        showNotification('‚úÖ Termini accettati! Benvenuto!', false, 'success');
        
        // Avvia l'applicazione principale dopo l'accettazione
        setupMainApp();
    } catch (error) {
        console.error('Errore durante l\'accettazione dei termini:', error);
        showNotification('Errore durante l\'accettazione dei termini. Riprova.', true);
    }
}



        function declineTerms() {
            alert('Per utilizzare la piattaforma √® necessario accettare i Termini e Condizioni.');
            window.location.href = 'about:blank';
        }
		function setupTermsEventListeners() {
    const termsCheckbox = document.getElementById('termsCheckbox');
    const termsAcceptBtn = document.getElementById('termsAcceptBtn');
    
    if (termsCheckbox && termsAcceptBtn) {
        // Rimuovi event listener esistenti per evitare duplicati
        const newCheckbox = termsCheckbox.cloneNode(true);
        const newButton = termsAcceptBtn.cloneNode(true);
        
        termsCheckbox.parentNode.replaceChild(newCheckbox, termsCheckbox);
        termsAcceptBtn.parentNode.replaceChild(newButton, termsAcceptBtn);
        
        // Aggiungi nuovo event listener
        newCheckbox.addEventListener('change', function() {
            document.getElementById('termsAcceptBtn').disabled = !this.checked;
            console.log('Checkbox termini cambiato:', this.checked);
        });
        
        // Forza un controllo iniziale
        document.getElementById('termsAcceptBtn').disabled = !newCheckbox.checked;
    }
}

        function showTerms() {
            document.getElementById('termsOverlay').style.display = 'flex';
        }

        // ============================================
        // SISTEMA BATTAGLIE
        // ============================================
        
	async function loadCurrentBattle() {
    const battleView = document.getElementById('battleView');
    if (!battleView) {
        console.error('battleView non trovato');
        return;
    }
    
    battleView.innerHTML = '<div class="loading">Caricamento battaglia...</div>';
    
    try {
        // Carica battaglie attive o in setup
        const { data: battleData, error: battleError } = await supabase
            .from('battles')
            .select('*')
            .in('status', ['setting_up', 'active'])
            .order('created_at', { ascending: false })
            .limit(1);
        
        // Se c'√® un errore diverso da "nessun risultato", lancialo
        if (battleError && battleError.code !== 'PGRST116') {
            console.error('Errore query battles:', battleError);
            throw battleError;
        }
        
        // Se non ci sono battaglie, mostra il setup
        if (!battleData || battleData.length === 0) {
            console.log('Nessuna battaglia trovata, mostro setup');
            await showBattleSetup();
            return;
        }
        
        // Prendi la prima battaglia
        const battle = battleData[0];
        console.log('Battaglia trovata:', battle);
        
        // Carica foto1 se esiste
        if (battle.photo1_id) {
            const { data: photo1, error: photo1Error } = await supabase
                .from('photos')
                .select('*')
                .eq('id', battle.photo1_id)
                .single();
            
            if (!photo1Error && photo1) {
                battle.photo1 = photo1;
            }
        }
        
        // Carica foto2 se esiste
        if (battle.photo2_id) {
            const { data: photo2, error: photo2Error } = await supabase
                .from('photos')
                .select('*')
                .eq('id', battle.photo2_id)
                .single();
            
            if (!photo2Error && photo2) {
                battle.photo2 = photo2;
            }
        }
        
        // Salva la battaglia corrente
        currentBattle = battle;
        
        // Mostra la battaglia
        await displayBattle(battle);
        
    } catch (error) {
        console.error('Errore caricamento battaglia:', error);
        battleView.innerHTML = `
            <div class="empty-state">
                <p>‚ùå Errore nel caricamento della battaglia</p>
                <p style="color: #666; font-size: 14px;">${error.message}</p>
                <button class="btn btn-primary" onclick="loadCurrentBattle()" style="margin-top: 15px;">
                    üîÑ Riprova
                </button>
            </div>
        `;
    }
}
        
async function showBattleSetup() {
    const battleView = document.getElementById('battleView');
    
    try {
        // Controlla se c'√® una battaglia in setup
        const { data: existingBattle } = await supabase
            .from('battles')
            .select('*')
            .eq('status', 'setting_up')
            .single();
        
        // Controlla quante foto ha caricato l'utente
        const userBattlePhotos = JSON.parse(localStorage.getItem('userBattlePhotos') || '[]');
        const hasUploadedPhoto = userBattlePhotos.length > 0;
        
        if (existingBattle) {
            // C'√® una battaglia in attesa
            let photoToShow = null;
            let waitingSlot = null;
            
            if (existingBattle.photo1_id && !existingBattle.photo2_id) {
                // Foto 1 in attesa
                const { data: photo } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('id', existingBattle.photo1_id)
                    .single();
                photoToShow = photo;
                waitingSlot = 1;
            } else if (!existingBattle.photo1_id && existingBattle.photo2_id) {
                // Foto 2 in attesa
                const { data: photo } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('id', existingBattle.photo2_id)
                    .single();
                photoToShow = photo;
                waitingSlot = 2;
            }
            
            if (photoToShow) {
                battleView.innerHTML = `
                    <div class="battle-arena">
                        <div class="battle-slot filled">
                            <img src="${photoToShow.image_url}" class="battle-photo" onerror="this.src='https://via.placeholder.com/300'">
                            <h4>${photoToShow.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</h4>
                            <p>‚è≥ In attesa di avversario...</p>
                        </div>
                        
                        <div class="battle-vs">VS</div>
                        
                        <div class="battle-slot ${hasUploadedPhoto ? '' : ''}" ${hasUploadedPhoto ? '' : 'onclick="openBattlePhotoSelector(' + (waitingSlot === 1 ? 2 : 1) + ')"'}>
                            <div class="battle-slot-empty">
                                <h3>${hasUploadedPhoto ? '‚è≥' : '+'}</h3>
                                <p>${hasUploadedPhoto ? 'Hai gi√† caricato una foto per questa battaglia' : 'Clicca per sfidare questa foto!'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="battle-stats">
                        <p style="text-align: center; color: #666;">
                            ${hasUploadedPhoto ? '‚è≥ In attesa che un altro utente aggiunga una foto...' : 'üí° Clicca sul secondo slot per sfidare!'}
                        </p>
                    </div>
                `;
                return;
            }
        }
        
        // Nessuna battaglia in attesa - mostra setup normale
        battleView.innerHTML = `
            <div class="battle-arena">
                <div class="battle-slot ${hasUploadedPhoto ? '' : ''}" ${hasUploadedPhoto ? '' : 'onclick="openBattlePhotoSelector(1)"'}>
                    <div class="battle-slot-empty">
                        <h3>${hasUploadedPhoto ? '‚è≥' : '+'}</h3>
                        <p>${hasUploadedPhoto ? 'Hai gi√† una foto in attesa' : 'Clicca per aggiungere una foto'}</p>
                    </div>
                </div>
                
                <div class="battle-vs">VS</div>
                
                <div class="battle-slot">
                    <div class="battle-slot-empty">
                        <h3>?</h3>
                        <p>In attesa...</p>
                    </div>
                </div>
            </div>
            
            <div class="battle-stats">
                <p style="text-align: center; color: #666;">
                    ${hasUploadedPhoto ? '‚è≥ In attesa di altri partecipanti...' : 'üí° Aggiungi una foto per iniziare una battaglia!'}
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="loadBattleHistory()">üìú Storico Battaglie</button>
            </div>
        `;
        
    } catch (error) {
        console.error('Errore setup battaglia:', error);
        battleView.innerHTML = '<div class="empty-state"><p>Errore nel caricamento</p></div>';
    }
}
async function displayBattle(battle) {
    const battleView = document.getElementById('battleView');
    
    if (!battle.photo1 || !battle.photo2) {
        console.log('Foto mancanti, mostro setup');
        await showBattleSetup();
        return;
    }
    
    const totalVotes = battle.votes1 + battle.votes2;
    const perc1 = totalVotes > 0 ? (battle.votes1 / totalVotes) * 100 : 50;
    const perc2 = totalVotes > 0 ? (battle.votes2 / totalVotes) * 100 : 50;
    
    const endTime = new Date(battle.end_time).getTime();
    const now = Date.now();
    const remaining = Math.max(0, endTime - now);
    
    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
    
    const userVote = localStorage.getItem('battle_vote_' + battle.id);
    
    battleView.innerHTML = `
        <div class="battle-timer">
            <h3>‚è±Ô∏è Battaglia in Corso</h3>
            <div class="time">${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</div>
        </div>
        
        <div class="battle-arena">
            <div class="battle-slot filled ${battle.votes1 > battle.votes2 ? 'winning' : ''}">
                <img src="${battle.photo1.image_url}" class="battle-photo" onerror="this.src='https://via.placeholder.com/300'">
                <h4>${battle.photo1.gender === 'male' ? 'üë¶' : 'üëß'}</h4>
                <div class="battle-stat-item">
                    <div class="value">${battle.votes1}</div>
                    <div class="label">Voti</div>
                </div>
                ${!userVote ? '<button class="battle-vote-btn left" onclick="voteBattle(\'' + battle.id + '\', 1)">üî• Vota Questa</button>' : ''}
            </div>
            
            <div class="battle-vs">VS</div>
            
            <div class="battle-slot filled ${battle.votes2 > battle.votes1 ? 'winning' : ''}">
                <img src="${battle.photo2.image_url}" class="battle-photo" onerror="this.src='https://via.placeholder.com/300'">
                <h4>${battle.photo2.gender === 'male' ? 'üë¶' : 'üëß'}</h4>
                <div class="battle-stat-item">
                    <div class="value">${battle.votes2}</div>
                    <div class="label">Voti</div>
                </div>
                ${!userVote ? '<button class="battle-vote-btn right" onclick="voteBattle(\'' + battle.id + '\', 2)">üî• Vota Questa</button>' : ''}
            </div>
        </div>
        
        <div class="battle-progress">
            <div class="battle-progress-bar">
                <div class="battle-progress-fill left" style="width: ${perc1}%">${Math.round(perc1)}%</div>
                <div class="battle-progress-fill right" style="width: ${perc2}%">${Math.round(perc2)}%</div>
            </div>
        </div>
        
        ${userVote ? `
            <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f0f4ff; border-radius: 10px;">
                <p><strong>‚úÖ Hai gi√† votato!</strong></p>
                <p style="color: #666;">Attendi la fine della battaglia per vedere il vincitore</p>
            </div>
        ` : ''}
        
        <div class="battle-stats">
            <div class="battle-stat-item">
                <div class="label">Condizione 1</div>
                <div class="value" style="font-size: 16px;">üéØ Primo a 50 voti</div>
            </div>
            <div class="battle-stat-item">
                <div class="label">Condizione 2</div>
                <div class="value" style="font-size: 16px;">‚è±Ô∏è Fine tempo (min 5 voti)</div>
            </div>
            <div class="battle-stat-item">
                <div class="label">Condizione 3</div>
                <div class="value" style="font-size: 16px;">üí• +20 voti di diff (min 20 tot)</div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="loadBattleHistory()">üìú Storico Battaglie</button>
        </div>
    `;
    
    if (battle.status === 'active') {
        startBattleTimer(battle.id);
    }
}

function openBattlePhotoSelector(slot) {
    currentBattleSlot = slot;
    document.getElementById('battlePhotoModal').style.display = 'flex';
    showUserPhotosForBattle();
}

async function showUserPhotosForBattle() {
    const selector = document.getElementById('battlePhotoSelector');
    selector.innerHTML = '<div class="loading">Caricamento foto...</div>';
    
    try {
        const { data: photos, error } = await supabase
            .from('photos')
            .select('*')
            .eq('status', 'active')
            .order('created_at', { ascending: false })
            .limit(20);
        
        if (error) throw error;
        
        if (!photos || photos.length === 0) {
            selector.innerHTML = `
                <div class="empty-state">
                    <p>Nessuna foto disponibile</p>
                    <button class="btn btn-primary" onclick="showUploadForBattle()">üì∏ Carica una Nuova Foto</button>
                </div>
            `;
            return;
        }
        
        selector.innerHTML = `
            <div class="photo-selector-grid">
                ${photos.map(photo => `
                    <div class="photo-selector-item" onclick="selectPhotoForBattle('${photo.id}')">
                        <img src="${photo.image_url}" onerror="this.src='https://via.placeholder.com/150'">
                    </div>
                `).join('')}
            </div>
        `;
        
    } catch (error) {
        console.error('Errore:', error);
        selector.innerHTML = '<div class="empty-state"><p>Errore nel caricamento</p></div>';
    }
}

async function selectPhotoForBattle(photoId) {
    try {
        // Controlla quante foto ha gi√† caricato l'utente
        const userBattlePhotos = JSON.parse(localStorage.getItem('userBattlePhotos') || '[]');
        
        if (userBattlePhotos.length > 0) {
            showNotification('‚ö†Ô∏è Puoi caricare solo 1 foto per battaglia!', false, 'warning');
            closeModal('battlePhotoModal');
            return;
        }
        
        // Verifica battaglia esistente
        const { data: existingBattle, error: fetchError } = await supabase
            .from('battles')
            .select('*')
            .in('status', ['setting_up', 'active'])
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
        
        if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;
        
        if (!existingBattle) {
            // Crea nuova battaglia
            const endTime = new Date(Date.now() + 60 * 60 * 1000);
            
            const newBattle = currentBattleSlot === 1 ? {
                photo1_id: photoId,
                photo2_id: null,
                status: 'setting_up',
                votes1: 0,
                votes2: 0,
                start_time: new Date().toISOString(),
                end_time: endTime.toISOString()
            } : {
                photo1_id: null,
                photo2_id: photoId,
                status: 'setting_up',
                votes1: 0,
                votes2: 0,
                start_time: new Date().toISOString(),
                end_time: endTime.toISOString()
            };
            
            const { error: insertError } = await supabase
                .from('battles')
                .insert([newBattle]);
            
            if (insertError) throw insertError;
            
            // Salva localmente
            userBattlePhotos.push({ battleId: 'new', photoId: photoId, timestamp: Date.now() });
            localStorage.setItem('userBattlePhotos', JSON.stringify(userBattlePhotos));
            
            showNotification('‚úÖ Foto aggiunta! In attesa di avversario...', false, 'success');
            
        } else {
            // Aggiungi alla battaglia esistente
            const updateField = currentBattleSlot === 1 ? 'photo1_id' : 'photo2_id';
            const otherField = currentBattleSlot === 1 ? 'photo2_id' : 'photo1_id';
            
            const shouldActivate = existingBattle[otherField] !== null;
            
            const { error: updateError } = await supabase
                .from('battles')
                .update({
                    [updateField]: photoId,
                    status: shouldActivate ? 'active' : 'setting_up'
                })
                .eq('id', existingBattle.id);
            
            if (updateError) throw updateError;
            
            // Salva localmente
            userBattlePhotos.push({ battleId: existingBattle.id, photoId: photoId, timestamp: Date.now() });
            localStorage.setItem('userBattlePhotos', JSON.stringify(userBattlePhotos));
            
            if (shouldActivate) {
                showNotification('üéâ Battaglia iniziata! Durata: 1 ora', false, 'success');
            } else {
                showNotification('‚úÖ Foto aggiunta!', false, 'success');
            }
        }
        
        closeModal('battlePhotoModal');
        loadCurrentBattle();
        
    } catch (error) {
        console.error('Errore selezione foto:', error);
        showNotification('‚ùå Errore: ' + error.message, true);
    }
}

async function voteBattle(battleId, side) {
    try {
        const voteKey = 'battle_vote_' + battleId;
        
        if (localStorage.getItem(voteKey)) {
            showNotification('‚ö†Ô∏è Hai gi√† votato in questa battaglia!', false, 'warning');
            return;
        }
        
        const { data: battle, error: fetchError } = await supabase
            .from('battles')
            .select('*')
            .eq('id', battleId)
            .single();
        
        if (fetchError) throw fetchError;
        
        const voteField = side === 1 ? 'votes1' : 'votes2';
        const newVotes = (battle[voteField] || 0) + 1;
        
        const updateData = {};
        updateData[voteField] = newVotes;
        
        const { error: updateError } = await supabase
            .from('battles')
            .update(updateData)
            .eq('id', battleId);
        
        if (updateError) throw updateError;
        
        localStorage.setItem(voteKey, side.toString());
        
        showNotification('‚úÖ Voto registrato!', false, 'success');
        
        await checkBattleEnd(battleId);
        loadCurrentBattle();
        
    } catch (error) {
        console.error('Errore voto:', error);
        showNotification('‚ùå Errore: ' + error.message, true);
    }
}

async function checkBattleEnd(battleId) {
    try {
        // Carica battaglia
        const { data: battle, error } = await supabase
            .from('battles')
            .select('*')
            .eq('id', battleId)
            .single();
        
        if (error || !battle || battle.status !== 'active') {
            return;
        }
        
        const totalVotes = battle.votes1 + battle.votes2;
        const voteDiff = Math.abs(battle.votes1 - battle.votes2);
        const timeRemaining = new Date(battle.end_time).getTime() - Date.now();
        
        let winner = null;
        let reason = null;
        
        // Condizione 1: Primo a 50 voti
        if (battle.votes1 >= 50) {
            winner = 1;
            reason = 'first_to_50';
        } else if (battle.votes2 >= 50) {
            winner = 2;
            reason = 'first_to_50';
        }
        // Condizione 2: Differenza 20 con minimo 20 totali
        else if (totalVotes >= 20 && voteDiff >= 20) {
            winner = battle.votes1 > battle.votes2 ? 1 : 2;
            reason = 'vote_difference';
        }
        // Condizione 3: Tempo scaduto con minimo 5 voti
        else if (timeRemaining <= 0 && totalVotes >= 5) {
            winner = battle.votes1 > battle.votes2 ? 1 : 2;
            reason = 'time_expired';
        }
        
        // Se c'√® un vincitore, termina la battaglia
        if (winner) {
            await endBattle(battleId, winner, reason);
        }
        
    } catch (error) {
        console.error('Errore controllo fine battaglia:', error);
    }
}

async function endBattle(battleId, winner, reason) {
    try {
        const { data: battle, error: fetchError } = await supabase
            .from('battles')
            .select('*')
            .eq('id', battleId)
            .single();
        
        if (fetchError) throw fetchError;
        
        const winnerPhotoId = winner === 1 ? battle.photo1_id : battle.photo2_id;
        const loserPhotoId = winner === 1 ? battle.photo2_id : battle.photo1_id;
        
        // Aggiorna battaglia
        await supabase
            .from('battles')
            .update({
                status: 'completed',
                winner: winner,
                end_reason: reason,
                completed_at: new Date().toISOString()
            })
            .eq('id', battleId);
        
        // Aggiorna foto vincitrice (+5 smash, +1 battle_wins)
        const { data: winnerPhoto } = await supabase
            .from('photos')
            .select('smash_count, battle_wins')
            .eq('id', winnerPhotoId)
            .single();
        
        await supabase
            .from('photos')
            .update({
                smash_count: (winnerPhoto.smash_count || 0) + 5,
                battle_wins: (winnerPhoto.battle_wins || 0) + 1
            })
            .eq('id', winnerPhotoId);
        
        // Aggiorna foto perdente (+2 smash)
        const { data: loserPhoto } = await supabase
            .from('photos')
            .select('smash_count')
            .eq('id', loserPhotoId)
            .single();
        
        await supabase
            .from('photos')
            .update({
                smash_count: (loserPhoto.smash_count || 0) + 2
            })
            .eq('id', loserPhotoId);
        
        const reasonText = {
            'first_to_50': 'üèÜ Primo a 50 voti',
            'vote_difference': 'üí• Differenza di 20 voti',
            'time_expired': '‚è±Ô∏è Tempo scaduto'
        };
        
        showNotification(`üéâ Battaglia terminata! Vincitore: Foto ${winner}. ${reasonText[reason]}`, false, 'success');
        // Pulisci storage utente se la battaglia √® finita
const userBattlePhotos = JSON.parse(localStorage.getItem('userBattlePhotos') || '[]');
const filtered = userBattlePhotos.filter(item => item.battleId !== battleId);
localStorage.setItem('userBattlePhotos', JSON.stringify(filtered));
        setTimeout(() => {
            loadCurrentBattle();
        }, 3000);
        
    } catch (error) {
        console.error('Errore fine battaglia:', error);
    }
}
async function forceEndBattleFromMod(battleId) {
    if (!confirm('Sei sicuro di voler terminare questa battaglia immediatamente?')) {
        return;
    }
    
    try {
        const { data: battle, error } = await supabase
            .from('battles')
            .select('*')
            .eq('id', battleId)
            .single();
        
        if (error) throw error;
        
        // Determina vincitore
        const winner = battle.votes1 >= battle.votes2 ? 1 : 2;
        
        await endBattle(battleId, winner, 'moderator_ended');
        
        showNotification('‚úÖ Battaglia terminata dai moderatori!', false, 'success');
        loadReportedPhotos();
        
    } catch (error) {
        console.error('Errore termine battaglia:', error);
        showNotification('‚ùå Errore: ' + error.message, true);
    }
}

function startBattleTimer(battleId) {
    if (battleTimer) clearInterval(battleTimer);
    
    battleTimer = setInterval(async () => {
        await checkBattleEnd(battleId);
        
        const { data: battle } = await supabase
            .from('battles')
            .select('*')
            .eq('id', battleId)
            .single();
        
        if (!battle || battle.status !== 'active') {
            clearInterval(battleTimer);
            return;
        }
        
        const endTime = new Date(battle.end_time).getTime();
        const now = Date.now();
        const remaining = Math.max(0, endTime - now);
        
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
        
        const timerEl = document.querySelector('.battle-timer .time');
        if (timerEl) {
            timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
    }, 1000);
}

async function loadBattleHistory() {
    const battleView = document.getElementById('battleView');
    battleView.innerHTML = '<div class="loading">Caricamento storico...</div>';
    
    try {
        const { data: battlesList, error } = await supabase
            .from('battles')
            .select('*')
            .eq('status', 'completed')
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) {
            console.error('Errore caricamento storico:', error);
            throw error;
        }
        
        if (!battlesList || battlesList.length === 0) {
            battleView.innerHTML = `
                <div class="empty-state">
                    <h3>üìú Storico Battaglie</h3>
                    <p>Nessuna battaglia completata</p>
                    <button class="btn btn-primary" onclick="loadCurrentBattle()">üîô Torna</button>
                </div>
            `;
            return;
        }
        
        // Carica le foto per ogni battaglia
        for (let battle of battlesList) {
            if (battle.photo1_id) {
                const { data: photo1 } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('id', battle.photo1_id)
                    .single();
                battle.photo1 = photo1;
            }
            
            if (battle.photo2_id) {
                const { data: photo2 } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('id', battle.photo2_id)
                    .single();
                battle.photo2 = photo2;
            }
        }
        
        const reasonText = {
            'first_to_50': 'üèÜ Primo a 50 voti',
            'vote_difference': 'üí• Differenza di 20 voti',
            'time_expired': '‚è±Ô∏è Tempo scaduto',
			'moderator_ended': 'üõ°Ô∏è Terminata dai moderatori'
        };
        
        battleView.innerHTML = `
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadCurrentBattle()">üîô Torna alla Battaglia</button>
            </div>
            
            <h3 style="margin-bottom: 20px;">üìú Storico Battaglie</h3>
            
            ${battlesList.map(battle => `
                <div class="battle-history-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <h4>Battaglia ${new Date(battle.created_at).toLocaleDateString('it-IT')}</h4>
                        <span>${reasonText[battle.end_reason] || 'Completata'}</span>
                    </div>
                    
                    <div class="battle-history-photos">
                        <div class="battle-history-photo-container ${battle.winner === 1 ? 'winner' : ''}">
                            <img src="${battle.photo1?.image_url || 'https://via.placeholder.com/200'}" onerror="this.src='https://via.placeholder.com/200'">
                            <div>${battle.votes1} voti</div>
                        </div>
                        
                        <div style="display: flex; align-items: center; font-size: 24px;">VS</div>
                        
                        <div class="battle-history-photo-container ${battle.winner === 2 ? 'winner' : ''}">
                            <img src="${battle.photo2?.image_url || 'https://via.placeholder.com/200'}" onerror="this.src='https://via.placeholder.com/200'">
                            <div>${battle.votes2} voti</div>
                        </div>
                    </div>
                </div>
            `).join('')}
        `;
        
    } catch (error) {
        console.error('Errore storico battaglie:', error);
        battleView.innerHTML = `
            <div class="empty-state">
                <p>‚ùå Errore nel caricamento dello storico</p>
                <p style="color: #666; font-size: 14px;">${error.message}</p>
                <button class="btn btn-primary" onclick="loadCurrentBattle()">üîô Torna</button>
            </div>
        `;
    }
}

function showUploadForBattle() {
    closeModal('battlePhotoModal');
    switchTab('upload');
    showNotification('üì∏ Carica una foto e poi torna alla sezione Battaglia!', false, 'info');
}

        function exportData() {
            const data = {
                voteHistory: voteHistory,
                achievements: achievements,
                userStats: userStats,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `smash-or-pass-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Dati esportati con successo!');
        }
        
        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.voteHistory) {
                        voteHistory = { ...voteHistory, ...data.voteHistory };
                        localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
                    }
                    
                    if (data.achievements) {
                        achievements = { ...achievements, ...data.achievements };
                        localStorage.setItem('achievements', JSON.stringify(achievements));
                    }
                    
                    if (data.userStats) {
                        userStats = { ...userStats, ...data.userStats };
                        localStorage.setItem('userStats', JSON.stringify(userStats));
                    }
                    
                    showNotification('Dati importati con successo!');
                    
                    if (document.getElementById('history-tab').classList.contains('active')) {
                        loadVoteHistory();
                    }
                    if (document.getElementById('achievements-tab').classList.contains('active')) {
                        loadAchievementsDisplay();
                    }
                    
                } catch (error) {
                    console.error('Errore nell\'importazione:', error);
                    showNotification('Errore nell\'importazione. File non valido.', true);
                }
            };
            reader.readAsText(file);
        }
    </script>

</body>
</html>
