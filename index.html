<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash or Pass - Cesaris Edition</title>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        /* DARK MODE STYLES */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .tab-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .sidebar {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .sidebar-nav a {
            color: #e0e0e0;
        }

        body.dark-mode .sidebar-nav a:hover,
        body.dark-mode .sidebar-nav a.active {
            background: #2a5298;
            color: white;
        }

        body.dark-mode .btn-secondary {
            background: #404040;
            color: #e0e0e0;
        }

        body.dark-mode .btn-secondary:hover {
            background: #505050;
        }

        body.dark-mode .history-item,
        body.dark-mode .leaderboard-item,
        body.dark-mode .achievement-item {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .settings-section {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .password-input {
            background: #404040;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        body.dark-mode .file-restrictions {
            background: #2a3d5c;
            color: #e0e0e0;
        }

        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .reported-photo {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .empty-state {
            color: #aaa;
        }

        /* Toggle Switch per Dark Mode */
        .theme-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2a5298;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .sidebar-nav {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 10px;
        }
        
        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: #2a5298;
            color: white;
        }
        
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a5298;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .cesaris {
            color: #FFD700;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }

        .upload-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .step.active .step-number {
            background: #2a5298;
        }
        
        .step.completed .step-number {
            background: #4CAF50;
        }
        
        .step-content {
            display: none;
            text-align: center;
        }
        
        .step-content.active {
            display: block;
        }
        
        .gender-selection {
            margin: 20px 0;
        }
        
        .gender-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .gender-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .gender-btn.male.active {
            background: #1e3c72;
            border-color: #1e3c72;
        }
        
        .gender-btn.female.active {
            background: #FFD700;
            color: #333;
            border-color: #FFD700;
        }
        
        .upload-area {
            border: 2px dashed #2a5298;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #f8f9ff;
        }
        
        .preview-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: #2a5298;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1e3c72;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ddd;
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        #fileInput {
            display: none;
        }
        
        .voting-interface {
            text-align: center;
        }
        
        .gender-selection-vote {
            margin: 20px 0;
        }
        
        .photo-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .current-photo {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
        }
        
        .vote-buttons-single {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .smash-btn-single, .pass-btn-single {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .smash-btn-single {
            background: #4CAF50;
            color: white;
        }
        
        .smash-btn-single:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .pass-btn-single {
            background: #f44336;
            color: white;
        }
        
        .pass-btn-single:hover {
            background: #da190b;
            transform: scale(1.05);
        }
        
        .progress-container-single {
            margin: 20px auto;
            max-width: 400px;
        }
        
        .progress-bar-single {
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.5s ease;
        }
        
        .progress-fill.smash {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            z-index: 2;
        }
        
        .progress-fill.pass {
            background: linear-gradient(90deg, #f44336, #ff9800);
            z-index: 1;
        }
        
        .stats-single {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .smash-stat {
            color: #4CAF50;
        }
        
        .pass-stat {
            color: #f44336;
        }
        
        .vote-history {
            margin-top: 30px;
            text-align: left;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .history-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .history-info {
            flex-grow: 1;
        }
        
        .history-vote {
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
        }
        
        .history-vote.smash {
            background: #4CAF50;
            color: white;
        }
        
        .history-vote.pass {
            background: #f44336;
            color: white;
        }
        
        .change-vote-btn {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .change-vote-btn:hover {
            background: #FFC400;
            transform: scale(1.05);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #2a5298;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        
        .history-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .history-filter {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
            color: #2a5298;
            min-width: 30px;
            text-align: center;
        }
        
        .leaderboard-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .leaderboard-info {
            flex-grow: 1;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #4CAF50;
            margin-right: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .achievement-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .achievement-info {
            flex-grow: 1;
        }
        
        .achievement-locked {
            opacity: 0.7;
        }
        
        .achievement-locked .achievement-info h4,
        .achievement-locked .achievement-info p {
            color: #999;
        }
        
        .achievement-progress {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .achievement-item small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .admin-panel {
            margin-top: 30px;
        }
        
        .reported-photo {
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fff9e6;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .admin-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .approve-btn {
            background: #4CAF50;
            color: white;
        }
        
        .reject-btn {
            background: #f44336;
            color: white;
        }
        
        .suspended-badge {
            background: #ff9800;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .report-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .report-details {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            border-left: 4px solid #ff9800;
        }
        
        .report-item {
            background: white;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #e9ecef;
        }

        /* ============================================= */
        /* STILI BATTAGLIA SMASH */
        /* ============================================= */

        .new-badge {
            background: #ff4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Statistiche Battaglia */
        .battle-stats-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            color: white;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Container Battaglia */
        .battle-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .battle-timer {
            background: #2a5298;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Slot Battaglia */
        .battle-slots {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin: 30px 0;
        }

        .battle-slot {
            flex: 1;
            min-height: 400px;
            border: 3px dashed #ddd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .battle-slot:hover {
            border-color: #2a5298;
            transform: translateY(-5px);
        }

        .slot-empty {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .slot-placeholder {
            text-align: center;
            color: #666;
        }

        .slot-placeholder span {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }

        .slot-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .battle-photo {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px 10px 0 0;
        }

        .slot-info {
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            flex-grow: 1;
        }

        .slot-info h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .slot-stats span {
            margin: 0 10px;
            font-weight: bold;
        }

        /* VS e Progress Bar */
        .battle-vs {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            min-width: 100px;
        }

        .vs-circle {
            width: 60px;
            height: 60px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        .battle-progress {
            width: 100%;
            text-align: center;
        }

        .battle-progress-bar {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            margin-bottom: 5px;
        }

        .battle-progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .battle-progress-fill:first-child {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }

        .battle-progress-fill:last-child {
            background: linear-gradient(90deg, #f44336, #ff9800);
        }

        .battle-progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: bold;
        }

        /* Pulsanti Battaglia */
        .battle-actions {
            text-align: center;
            margin: 20px 0;
        }

        .battle-vote-btn {
            padding: 15px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .left-vote {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }

        .right-vote {
            background: linear-gradient(135deg, #f44336, #ff9800);
            color: white;
        }

        .battle-vote-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Info Battaglia */
        .battle-info {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .battle-info-item {
            text-align: center;
        }

        /* Storico Battaglie */
        .battle-history {
            margin-top: 30px;
        }

        .battle-history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #2a5298;
        }

        .battle-history-winner {
            border-left-color: #4CAF50;
            background: #f0fff0;
        }

        .battle-history-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }

        .battle-history-info {
            flex-grow: 1;
        }

        .battle-history-vs {
            margin: 0 10px;
            font-weight: bold;
            color: #666;
        }

        /* Modal Selezione Foto Battaglia */
        .battle-photo-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .battle-photo-option {
            cursor: pointer;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .battle-photo-option:hover {
            border-color: #2a5298;
            transform: scale(1.05);
        }

        .battle-photo-option.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .battle-photo-option img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* Animazione per evidenziare le foto segnalate */
        @keyframes highlightFlash {
            0% { background-color: transparent; box-shadow: 0 0 0 rgba(255, 235, 59, 0); }
            50% { background-color: #fff3cd; box-shadow: 0 0 20px #ffeb3b; border-color: #ffc107; }
            100% { background-color: transparent; box-shadow: 0 0 0 rgba(255, 235, 59, 0); }
        }

        /* Stili per le notifiche browser */
        .notification-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
        }

        /* Dark Mode per Battaglia */
        body.dark-mode .battle-container,
        body.dark-mode .slot-info,
        body.dark-mode .battle-info,
        body.dark-mode .battle-history-item {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .battle-slot {
            border-color: #555;
        }

        body.dark-mode .slot-placeholder {
            color: #aaa;
        }

        body.dark-mode .battle-stats-container {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
        }

        /* Stili per la moderazione avanzata */
        .moderation-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .moderation-tab-btn {
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .moderation-tab-btn.active {
            border-bottom-color: #2a5298;
            color: #2a5298;
            font-weight: bold;
        }

        .moderation-tab-content {
            display: none;
        }

        .moderation-tab-content.active {
            display: block;
        }

        .moderation-log-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #2a5298;
        }

        .moderation-log-item.suspend {
            border-left-color: #f44336;
        }

        .moderation-log-item.approve {
            border-left-color: #4CAF50;
        }

        .moderation-note-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
            border-left: 2px solid #FFD700;
        }

        .severity-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .severity-low {
            background: #4CAF50;
            color: white;
        }

        .severity-medium {
            background: #FF9800;
            color: white;
        }

        .severity-high {
            background: #f44336;
            color: white;
        }

        .severity-critical {
            background: #9C27B0;
            color: white;
        }

        .reputation-display {
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .gender-btn {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 130px;
                margin: 5px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .preview-image {
                max-width: 100%;
                max-height: 300px;
            }
            
            .photo-container {
                max-width: 100%;
            }
            
            .current-photo {
                height: 400px;
            }
            
            .vote-buttons-single {
                gap: 10px;
            }
            
            .smash-btn-single, .pass-btn-single {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
                margin: 5px 0;
            }
            
            .history-item {
                flex-direction: column;
                text-align: center;
            }
            
            .history-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .change-vote-btn {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                max-width: 200px;
            }
            
            .leaderboard-item {
                flex-direction: column;
                text-align: center;
            }
            
            .leaderboard-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .sidebar {
                width: 280px;
                left: -280px;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            /* Battaglia Responsive */
            .battle-slots {
                flex-direction: column;
                gap: 15px;
            }
            
            .battle-slot {
                min-height: 300px;
                width: 100%;
            }
            
            .battle-vs {
                flex-direction: row;
                min-width: auto;
                gap: 10px;
            }
            
            .battle-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .battle-vote-btn {
                margin: 5px 0;
            }
            
            .battle-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .battle-stats-container {
                flex-direction: column;
                gap: 15px;
            }

            /* Moderazione Responsive */
            .moderation-tabs {
                flex-direction: column;
            }

            .admin-actions {
                flex-direction: column;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        .notification.info {
            background: #2196F3;
        }

        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .no-context-menu {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .settings-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .logout-btn {
            margin-top: 20px;
        }
        
        .file-restrictions {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #2a5298;
        }
        
        .file-restrictions ul {
            text-align: left;
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .file-restrictions li {
            margin-bottom: 5px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="no-select no-context-menu" oncontextmenu="return false;">
    <!-- Menu Laterale -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigazione</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
        </div>
        <ul class="sidebar-nav">
            <li><a href="#" onclick="switchTab('upload')" class="nav-link active" data-tab="upload">üì§ Carica Foto</a></li>
            <li><a href="#" onclick="switchTab('vote')" class="nav-link" data-tab="vote">üó≥Ô∏è Vota Foto</a></li>
            <li><a href="#" onclick="switchTab('history')" class="nav-link" data-tab="history">üìä Cronologia</a></li>
            <li><a href="#" onclick="switchTab('leaderboard')" class="nav-link" data-tab="leaderboard">üèÜ Classifica</a></li>
            <li><a href="#" onclick="switchTab('battle')" class="nav-link" data-tab="battle">‚öîÔ∏è Battaglia Smash <span class="new-badge">NEW</span></a></li>
            <li><a href="#" onclick="switchTab('achievements')" class="nav-link" data-tab="achievements">üéØ Achievement</a></li>
            <li><a href="#" onclick="switchTab('moderation')" class="nav-link" data-tab="moderation">üõ°Ô∏è Moderazione</a></li>
            <li><a href="#" onclick="switchTab('settings')" class="nav-link" data-tab="settings">‚öôÔ∏è Impostazioni</a></li>
        </ul>
    </div>
    
    <!-- Overlay per chiudere il menu -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Bottone per aprire il menu -->
    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    
    <div class="container">
        <header>
            <h1>Smash or Pass <span class="cesaris">Cesaris Edition</span></h1>
            <p>Carica la tua foto anonimamente e vota le foto degli altri!</p>
        </header>
        
        <!-- Contenuto delle tabs -->
        <div class="tab-content active" id="upload-tab">
            <!-- Indicatore dei passaggi -->
            <div class="upload-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div>Scegli Genere</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div>Carica Foto</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div>Conferma</div>
                </div>
            </div>
            
            <!-- Passaggio 1: Scelta genere -->
            <div class="step-content active" id="step1-content">
                <h3>Step 1: Seleziona il genere</h3>
                <p>Scegli se stai caricando una foto di un ragazzo o una ragazza</p>
                
                <div class="gender-selection">
                    <button class="gender-btn male" data-gender="male" id="maleBtn">
                        üë¶ Ragazzo
                    </button>
                    <button class="gender-btn female" data-gender="female" id="femaleBtn">
                        üëß Ragazza
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="goToStep(2)" id="nextToStep2" disabled>
                        Avanti
                    </button>
                </div>
            </div>
            
            <!-- Passaggio 2: Caricamento foto -->
            <div class="step-content" id="step2-content">
                <h3>Step 2: Carica la tua foto</h3>
                <p id="selected-gender-text">Stai caricando una foto di: <strong id="current-gender"></strong></p>
                
                <div class="file-restrictions">
                    <h4>‚ö†Ô∏è Restrizioni File</h4>
                    <ul>
                        <li>‚úÖ <strong>Accettati:</strong> JPEG, PNG, WebP (immagini statiche)</li>
                        <li>‚ùå <strong>Non accettati:</strong> GIF animate, video, file eseguibili</li>
                        <li>üìè <strong>Dimensione massima:</strong> 5MB</li>
                    </ul>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i>üì∑</i>
                    <h3>Clicca qui per selezionare una foto</h3>
                    <p>Oppure trascina il file qui</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">Solo immagini statiche (JPEG, PNG, WebP)</p>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp">
                </div>
                
                <div class="preview-container">
                    <img id="previewImage" class="preview-image" alt="Anteprima" style="display: none;">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        Indietro
                    </button>
                    <button class="btn btn-primary" onclick="goToStep(3)" id="nextToStep3" disabled>
                        Avanti
                    </button>
                </div>
            </div>
            
            <!-- Passaggio 3: Conferma -->
            <div class="step-content" id="step3-content">
                <h3>Step 3: Conferma il caricamento</h3>
                
                <div class="preview-container">
                    <img id="confirmPreviewImage" class="preview-image" alt="Anteprima conferma">
                </div>
                
                <p><strong>Genere:</strong> <span id="confirm-gender"></span></p>
                <p style="color: #666; margin: 15px 0;">Controlla che tutto sia corretto prima di procedere</p>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">
                        Modifica
                    </button>
                    <button class="btn btn-primary" onclick="uploadPhoto()" id="uploadBtn">
                        üöÄ Carica Foto
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="vote-tab">
            <div class="voting-interface">
                <div class="gender-selection-vote">
                    <h3>Su chi vuoi votare?</h3>
                    <button class="gender-btn male active" data-gender="male" id="voteMaleBtn">
                        üë¶ Ragazzi
                    </button>
                    <button class="gender-btn female" data-gender="female" id="voteFemaleBtn">
                        üëß Ragazze
                    </button>
                </div>
                
                <div id="singlePhotoView">
                    <div class="loading" id="loadingIndicator">
                        Caricamento foto in corso...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="history-tab">
            <div class="vote-history">
                <div class="history-controls">
                    <h3>La tua cronologia voti</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" onclick="filterHistory('all')">Tutti</button>
                        <button class="filter-btn" onclick="filterHistory('smash')">Smash</button>
                        <button class="filter-btn" onclick="filterHistory('pass')">Pass</button>
                    </div>
                </div>
                
                <div id="historyList">
                    <div class="loading">Caricamento cronologia...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="leaderboard-tab">
            <div class="vote-history">
                <div class="history-controls">
                    <h3>Classifica Foto pi√π Popolari</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" onclick="filterLeaderboard('all')">Tutti</button>
                        <button class="filter-btn" onclick="filterLeaderboard('male')">Ragazzi</button>
                        <button class="filter-btn" onclick="filterLeaderboard('female')">Ragazze</button>
                    </div>
                </div>
                
                <div id="leaderboardList">
                    <div class="loading">Caricamento classifica...</div>
                </div>
            </div>
        </div>
        
        <!-- NUOVO TAB BATTAGLIA SMASH -->
        <div class="tab-content" id="battle-tab">
            <div class="battle-interface">
                <h2>‚öîÔ∏è Battaglia Smash</h2>
                <p>Sfida altri utenti in una battaglia di popolarit√†! Carica la tua foto e sfida gli altri.</p>
                
                <!-- Statistiche Battaglia -->
                <div class="battle-stats-container">
                    <div class="stat-item">
                        <span class="stat-number" id="totalBattles">0</span>
                        <span class="stat-label">Battaglie Totali</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="activeBattles">0</span>
                        <span class="stat-label">Battaglie Attive</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="userWins">0</span>
                        <span class="stat-label">Le Tue Vittorie</span>
                    </div>
                </div>

                <!-- Sistema Battaglia -->
                <div class="battle-container">
                    <div class="battle-header">
                        <h3>Battaglia Corrente</h3>
                        <div class="battle-timer" id="battleTimer">
                            <span id="timerText">Caricamento...</span>
                        </div>
                    </div>

                    <div class="battle-slots">
                        <!-- Slot 1 -->
                        <div class="battle-slot" id="slot1">
                            <div class="slot-empty" onclick="openBattlePhotoSelector(1)">
                                <div class="slot-placeholder">
                                    <span>+</span>
                                    <p>Clicca per aggiungere foto</p>
                                </div>
                            </div>
                            <div class="slot-content" style="display: none;">
                                <img id="slot1Image" class="battle-photo" alt="Foto sfidante 1">
                                <div class="slot-info">
                                    <h4 id="slot1Name">Nome Foto</h4>
                                    <div class="slot-stats">
                                        <span>üòç <span id="slot1Smash">0</span></span>
                                        <span>‚öîÔ∏è <span id="slot1Wins">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="battle-vs">
                            <div class="vs-circle">VS</div>
                            <div class="battle-progress">
                                <div class="battle-progress-bar">
                                    <div class="battle-progress-fill" id="progressLeft" style="width: 50%"></div>
                                    <div class="battle-progress-fill" id="progressRight" style="width: 50%"></div>
                                </div>
                                <div class="battle-progress-stats">
                                    <span id="leftPercent">50%</span>
                                    <span id="rightPercent">50%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Slot 2 -->
                        <div class="battle-slot" id="slot2">
                            <div class="slot-empty" onclick="openBattlePhotoSelector(2)">
                                <div class="slot-placeholder">
                                    <span>+</span>
                                    <p>Clicca per aggiungere foto</p>
                                </div>
                            </div>
                            <div class="slot-content" style="display: none;">
                                <img id="slot2Image" class="battle-photo" alt="Foto sfidante 2">
                                <div class="slot-info">
                                    <h4 id="slot2Name">Nome Foto</h4>
                                    <div class="slot-stats">
                                        <span>üòç <span id="slot2Smash">0</span></span>
                                        <span>‚öîÔ∏è <span id="slot2Wins">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pulsanti Azione -->
                    <div class="battle-actions" id="battleActions">
                        <button class="btn btn-primary" onclick="joinBattle()" id="joinBattleBtn" style="display: none;">
                            üéØ Unisciti alla Battaglia
                        </button>
                        <button class="btn btn-secondary" onclick="startNewBattle()" id="startBattleBtn" style="display: none;">
                            üöÄ Crea Nuova Battaglia
                        </button>
                        <div class="vote-buttons" id="voteButtons" style="display: none;">
                            <button class="btn battle-vote-btn left-vote" onclick="voteBattle(1)">
                                üòç Vota SX
                            </button>
                            <button class="btn battle-vote-btn right-vote" onclick="voteBattle(2)">
                                üòç Vota DX
                            </button>
                        </div>
                    </div>

                    <!-- Info Battaglia -->
                    <div class="battle-info">
                        <div class="battle-info-item">
                            <strong>Voti Totali:</strong> <span id="totalVotesBattle">0</span>
                        </div>
                        <div class="battle-info-item">
                            <strong>Stato:</strong> <span id="battleStatus">In attesa di sfidanti...</span>
                        </div>
                        <div class="battle-info-item">
                            <strong>Condizione Vittoria:</strong> <span id="winCondition">50 voti o 1 ora</span>
                        </div>
                    </div>
                </div>

                <!-- Storico Battaglie -->
                <div class="battle-history">
                    <h4>Ultime Battaglie</h4>
                    <div id="battleHistoryList">
                        <div class="loading">Caricamento battaglie...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="achievements-tab">
            <div class="vote-history">
                <h3>I Tuoi Achievement</h3>
                <p>Sblocca achievement completando diverse azioni nell'app!</p>
                
                <div id="achievementsList">
                    <div class="loading">Caricamento achievement...</div>
                </div>
            </div>
        </div>
        
        <!-- Tab per moderazione -->
        <div class="tab-content" id="moderation-tab">
            <div class="admin-panel">
                <h2>üõ°Ô∏è Pannello di Moderazione</h2>
                <p>Qui puoi gestire le foto segnalate dagli utenti.</p>
                
                <!-- Display Reputazione -->
                <div class="reputation-display" id="reputationDisplay" style="display: none;">
                    <h4>üèÖ Sistema Reputazione</h4>
                    <p>Punti correnti: <strong id="currentRepPoints">100</strong></p>
                    <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; margin: 10px 0;">
                        <div id="reputationBar" style="background: #4CAF50; height: 100%; width: 100%; border-radius: 5px;"></div>
                    </div>
                    <small>Status: <span id="reputationStatus">Ottimo</span></small>
                </div>
                
                <div class="settings-section">
                    <h3>Foto Segnalate</h3>
                    <div id="reportedPhotosList">
                        <div class="loading">Caricamento foto segnalate...</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary logout-btn" onclick="logoutModeration()">
                        üö™ Esci dalla Moderazione
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <!-- Sezione Admin (solo per admin) -->
            <div class="settings-section" id="adminSection" style="display: none;">
                <h3>üëë Pannello Admin</h3>
                <p>Gestisci le notifiche e gli accessi admin</p>
                
                <div style="margin: 15px 0;">
                    <label for="adminTokenInput">Token Admin:</label>
                    <input type="password" id="adminTokenInput" class="password-input" placeholder="Inserisci token admin">
                    <button class="btn btn-primary" onclick="handleAdminLogin()" style="margin-top: 10px; width: 100%;">
                        üîë Diventa Admin
                    </button>
                </div>
                
                <div id="adminControls" style="display: none;">
                    <div style="background: #4CAF50; color: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        ‚úÖ Sei admin - Notifiche attive
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label for="newAdminToken">Aggiungi nuovo admin:</label>
                        <input type="password" id="newAdminToken" class="password-input" placeholder="Nuovo token admin">
                        <button class="btn btn-secondary" onclick="addNewAdminToken()" style="margin-top: 10px; width: 100%;">
                            ‚ûï Aggiungi Admin
                        </button>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="testNotification()" style="margin: 5px; width: 100%;">
                        üîî Test Notifica
                    </button>
                    
                    <button class="btn btn-secondary" onclick="revokeAdminAccess()" style="margin: 5px; width: 100%; background: #f44336;">
                        üö™ Esci da Admin
                    </button>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>üí° Tema</h3>
                <p>Passa dalla modalit√† chiara a scura e viceversa</p>
                <div class="theme-switch">
                    <span>üåô Modalit√† Scura</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Importa/Esporta Dati</h3>
                <p>Salva i tuoi dati locali o importa dati precedenti</p>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="exportData()">
                        üì• Esporta Dati
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        üì§ Importa Dati
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Informazioni</h3>
                <p>Versione: 2.0</p>
                <p>Foto totali caricate: <span id="totalPhotos">0</span></p>
                <p>Voti totali: <span id="totalVotes">0</span></p>
            </div>
        </div>
    </div>

    <!-- Modal per password moderazione -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Accesso Moderazione</h3>
                <button class="close-modal" onclick="closeModal('passwordModal')">√ó</button>
            </div>
            <div>
                <p>Inserisci la password di moderazione:</p>
                <input type="password" id="moderationPasswordInput" class="password-input" placeholder="Password">
                <p id="attemptsInfo" style="color: #666; font-size: 14px; margin: 10px 0;">
                    Tentativi rimanenti: 3
                </p>
                <button class="btn btn-primary" onclick="handlePasswordSubmit()" style="width: 100%;">
                    Accedi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal per segnalazione -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Segnala Foto</h3>
                <button class="close-modal" onclick="closeModal('reportModal')">√ó</button>
            </div>
            <div id="reportContent">
                <p>Seleziona il motivo della segnalazione:</p>
                <select id="reportReason" class="password-input" style="width: 100%; margin-bottom: 15px;">
                    <option value="inappropriate">Contenuto inappropriato</option>
                    <option value="sexual">Contenuto sessuale</option>
                    <option value="fake">Foto non reale/falsa</option>
                    <option value="other">Altro</option>
                </select>
                <textarea id="reportDetails" class="password-input" placeholder="Dettagli aggiuntivi (opzionale)" style="width: 100%; height: 100px; margin-bottom: 15px;"></textarea>
                <button class="btn btn-primary" onclick="submitReport()" style="width: 100%;">Invia Segnalazione</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per selezione foto battaglia -->
    <div class="modal" id="battlePhotoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Seleziona Foto per la Battaglia</h3>
                <button class="close-modal" onclick="closeBattlePhotoModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="selection-options">
                    <button class="btn btn-primary" onclick="showExistingPhotos()" style="margin: 10px;">
                        üìÅ Usa Foto Esistente
                    </button>
                    <button class="btn btn-secondary" onclick="uploadNewBattlePhoto()" style="margin: 10px;">
                        üì∏ Carica Nuova Foto
                    </button>
                </div>
                
                <div id="battlePhotoSelection" style="display: none;">
                    <h4>Le tue foto</h4>
                    <div class="battle-photo-selection" id="existingPhotosList">
                        <div class="loading">Caricamento foto...</div>
                    </div>
                </div>
                
                <div id="battleUploadSection" style="display: none;">
                    <h4>Carica Nuova Foto</h4>
                    <div class="upload-area" onclick="document.getElementById('battleFileInput').click()">
                        <i>üì∑</i>
                        <h3>Clicca qui per selezionare una foto</h3>
                        <p>Oppure trascina il file qui</p>
                    </div>
                    <input type="file" id="battleFileInput" accept=".jpg,.jpeg,.png,.webp" style="display: none;">
                    <div class="preview-container">
                        <img id="battlePreviewImage" class="preview-image" alt="Anteprima" style="display: none;">
                    </div>
                    <button class="btn btn-primary" onclick="confirmBattlePhotoUpload()" id="confirmBattleUpload" disabled style="margin-top: 15px; width: 100%;">
                        ‚úÖ Conferma Foto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per termini di servizio -->
    <div class="modal" id="termsModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h3>üìã Termini di Servizio - Smash or Pass Cesaris Edition</h3>
            </div>
            <div style="max-height: 60vh; overflow-y: auto; padding: 20px; text-align: left;">
                <div id="termsContent"></div>
                
                <div class="file-restrictions" style="margin: 20px 0;">
                    <h4>‚ö†Ô∏è Attenzione - Dichiarazione di Responsabilit√†</h4>
                    <p>Prima di procedere, leggi attentamente i nostri termini di servizio.</p>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid #eee;">
                <label style="display: flex; align-items: center; margin-bottom: 15px;">
                    <input type="checkbox" id="acceptTermsCheckbox" style="margin-right: 10px;">
                    <span>Dichiaro di aver letto e accettato i Termini di Servizio</span>
                </label>
                <button class="btn btn-primary" onclick="acceptTerms()" id="acceptTermsBtn" disabled style="width: 100%;">
                    Accetta e Procedi
                </button>
            </div>
        </div>
    </div>

    <!-- Modal per moderazione avanzata -->
    <div class="modal" id="advancedModerationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üõ°Ô∏è Moderazione Avanzata</h3>
                <button class="close-modal" onclick="closeModal('advancedModerationModal')">√ó</button>
            </div>
            <div>
                <div class="moderation-tabs">
                    <button class="moderation-tab-btn active" onclick="openModerationTab('suspend', this)">‚è∏Ô∏è Sospendi</button>
                    <button class="moderation-tab-btn" onclick="openModerationTab('templates', this)">üìã Template</button>
                    <button class="moderation-tab-btn" onclick="openModerationTab('history', this)">üìä Cronologia</button>
                </div>
                
                <!-- Tab Sospensione -->
                <div id="suspendTab" class="moderation-tab-content active">
                    <h4>Sospensione Foto</h4>
                    <p><strong>Foto ID:</strong> <span id="currentModPhotoId">-</span></p>
                    
                    <div style="margin: 15px 0;">
                        <label><strong>Gravit√†:</strong></label>
                        <select id="suspendSeverity" class="password-input" style="width: 100%; margin: 10px 0;">
                            <option value="low">Bassa - Avviso</option>
                            <option value="medium">Media - Sospensione 24h</option>
                            <option value="high">Alta - Sospensione 7gg</option>
                            <option value="critical">Critica - Rimozione</option>
                        </select>
                        
                        <label><strong>Motivo Sospensione:</strong></label>
                        <select id="suspendReason" class="password-input" style="width: 100%; margin: 10px 0;">
                            <option value="content_inappropriate">Contenuto Inappropriato</option>
                            <option value="content_sexual">Contenuto Sessuale</option>
                            <option value="fake_photo">Foto Falsa/Non Reale</option>
                            <option value="copyright">Violazione Copyright</option>
                            <option value="harassment">Molestie/Bullismo</option>
                            <option value="other">Altro</option>
                        </select>
                        
                        <textarea id="suspendDetails" class="password-input" 
                                  placeholder="Dettagli aggiuntivi (opzionale)" 
                                  style="width: 100%; height: 100px; margin: 10px 0;"></textarea>
                        
                        <label style="display: flex; align-items: center; margin: 10px 0;">
                            <input type="checkbox" id="notifyUser" style="margin-right: 10px;">
                            <span>Applica penalit√† reputazione</span>
                        </label>
                    </div>
                    
                    <button class="btn btn-primary" onclick="performAdvancedSuspend()" style="width: 100%;">
                        ‚è∏Ô∏è Conferma Sospensione
                    </button>
                </div>
                
                <!-- Tab Template -->
                <div id="templatesTab" class="moderation-tab-content">
                    <h4>Template di Decisione</h4>
                    <div id="moderationTemplatesList" style="max-height: 300px; overflow-y: auto; margin: 10px 0;">
                        <!-- Template verranno caricati qui -->
                    </div>
                    <button class="btn btn-secondary" onclick="applyTemplate('standard_suspend')" style="width: 100%; margin: 5px 0;">
                        üö´ Sospensione Standard
                    </button>
                    <button class="btn btn-secondary" onclick="applyTemplate('content_removal')" style="width: 100%; margin: 5px 0;">
                        üóëÔ∏è Rimozione Contenuto
                    </button>
                    <button class="btn btn-secondary" onclick="applyTemplate('warning_only')" style="width: 100%; margin: 5px 0;">
                        ‚ö†Ô∏è Solo Avviso
                    </button>
                </div>
                
                <!-- Tab Cronologia -->
                <div id="historyTab" class="moderation-tab-content">
                    <h4>Cronologia Moderazione</h4>
                    <div id="moderationHistory" style="max-height: 300px; overflow-y: auto;">
                        <!-- Cronologia verr√† caricata qui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://rreyuxxnyhhahwkjxfiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZXl1eHhueWhoYWh3a2p4Zml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjIyNDgsImV4cCI6MjA3ODU5ODI0OH0.F_ZnqK10o8h-IY23_g9RzkPHqQVbpAvjQmw0awlApBE';

        // ‚öîÔ∏è CONFIGURAZIONE BATTAGLIA
        const BATTLE_CONFIG = {
            WIN_CONDITION: {
                VOTE_COUNT: 50,
                TIME_LIMIT: 60 * 60 * 1000,
                MIN_VOTES: 10
            },
            REWARDS: {
                WINNER_SMASH_BOOST: 5,
                PARTICIPATION_SMASH: 2
            }
        };

        // üî® CONFIGURAZIONE MODERAZIONE
        const MODERATION_CONFIG = {
            REPUTATION: {
                INITIAL_POINTS: 100,
                THRESHOLDS: {
                    LIMITED: 50,
                    SUSPENDED: 25,
                    BANNED: 0
                },
                DEDUCTIONS: {
                    LOW: 10,
                    MEDIUM: 25,
                    HIGH: 50,
                    CRITICAL: 100
                }
            },
            SEVERITY: {
                LOW: 'low',
                MEDIUM: 'medium',
                HIGH: 'high',
                CRITICAL: 'critical'
            },
            AUTOMATED_ACTIONS: {
                REPORT_THRESHOLD: 3,
                TIME_FRAME: 24 * 60 * 60 * 1000
            }
        };

        // üîî CONFIGURAZIONE NOTIFICHE
        const NOTIFICATION_CONFIG = {
            ONESIGNAL_APP_ID: "c3eb0b23-e24a-4d78-99a1-57fe523dbb7d",
            ADMIN_PLAYER_ID: "IL_TUO_PLAYER_ID_QUI",
            BATTLE_EVENTS: {
                ENABLED: true
            },
            MODERATION: {
                ENABLED: true
            }
        };

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =============================================
        // VARIABILI GLOBALI
        // =============================================
        let selectedGender = null;
        let selectedFile = null;
        let currentVoteGender = 'male';
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let voteHistory = JSON.parse(localStorage.getItem('voteHistory') || '{}');
        let currentHistoryFilter = 'all';
        let currentLeaderboardFilter = 'all';
        let achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
        let currentPhotoForReport = null;
        let userStats = JSON.parse(localStorage.getItem('userStats') || '{}');
        let userUploadedPhotos = JSON.parse(localStorage.getItem('userUploadedPhotos') || '[]');
        let userBattlePhotos = JSON.parse(localStorage.getItem('userBattlePhotos') || '[]');
        let userUniqueId = localStorage.getItem('userUniqueId') || generateUserId();
        let hasAcceptedTerms = localStorage.getItem('hasAcceptedTerms') === 'true';

        // SISTEMA MODERAZIONE
        let moderationAttempts = 3;
        let isModerationAuthenticated = false;
        const REPORT_THRESHOLD = 3;

        // SISTEMA BATTAGLIA
        let currentBattle = null;
        let currentBattleSlot = null;
        let selectedBattlePhoto = null;
        let battleTimer = null;
        let userBattleStats = JSON.parse(localStorage.getItem('userBattleStats') || '{}');

        // SISTEMA REPUTAZIONE
        let userReputation = JSON.parse(localStorage.getItem('userReputation') || '{}');
        let currentModerationPhoto = null;

        // =============================================
        // FUNZIONI DI INIZIALIZZAZIONE
        // =============================================

        function generateUserId() {
            const userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('userUniqueId', userId);
            return userId;
        }

        function initUserStats() {
            if (!userStats.votes) {
                userStats = {
                    votes: {
                        total: 0,
                        male: 0,
                        female: 0,
                        smash: 0,
                        pass: 0,
                        currentStreak: 0,
                        maxStreak: 0,
                        lastVoteDate: null
                    },
                    views: 0,
                    reports: 0,
                    uploads: 0,
                    achievementsUnlocked: 0,
                    sessions: 0,
                    lastLogin: null,
                    photos: {
                        uploaded: [],
                        totalSmashReceived: 0,
                        totalPassReceived: 0
                    }
                };
            }
            
            userStats.sessions++;
            userStats.lastLogin = new Date().toISOString();
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }

        async function initUserReputation() {
            if (!userReputation.points) {
                try {
                    const { data, error } = await supabase
                        .from('user_reputation')
                        .select('*')
                        .eq('user_id', userUniqueId)
                        .single();
                        
                    if (error || !data) {
                        userReputation = {
                            user_id: userUniqueId,
                            points: MODERATION_CONFIG.REPUTATION.INITIAL_POINTS,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        await supabase
                            .from('user_reputation')
                            .insert([userReputation]);
                    } else {
                        userReputation = data;
                    }
                    localStorage.setItem('userReputation', JSON.stringify(userReputation));
                } catch (error) {
                    console.error('Errore inizializzazione reputazione:', error);
                    userReputation = {
                        user_id: userUniqueId,
                        points: MODERATION_CONFIG.REPUTATION.INITIAL_POINTS
                    };
                    localStorage.setItem('userReputation', JSON.stringify(userReputation));
                }
            }
            updateReputationDisplay();
        }
function initDarkMode() {
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.getElementById('darkModeToggle').checked = isDarkMode;
}

function updateDarkMode(isDark) {
    document.body.classList.toggle('dark-mode', isDark);
    localStorage.setItem('darkMode', isDark);
}
        function updateReputationDisplay() {
            const reputationDisplay = document.getElementById('reputationDisplay');
            const currentRepPoints = document.getElementById('currentRepPoints');
            const reputationBar = document.getElementById('reputationBar');
            const reputationStatus = document.getElementById('reputationStatus');
            
            if (reputationDisplay && userReputation.points) {
                reputationDisplay.style.display = 'block';
                currentRepPoints.textContent = userReputation.points;
                
                const percentage = (userReputation.points / MODERATION_CONFIG.REPUTATION.INITIAL_POINTS) * 100;
                reputationBar.style.width = `${percentage}%`;
                
                // Cambia colore in base ai punti
                if (userReputation.points >= 75) {
                    reputationBar.style.background = '#4CAF50';
                    reputationStatus.textContent = 'Ottimo';
                } else if (userReputation.points >= 50) {
                    reputationBar.style.background = '#FF9800';
                    reputationStatus.textContent = 'Buono';
                } else if (userReputation.points >= 25) {
                    reputationBar.style.background = '#f44336';
                    reputationStatus.textContent = 'Attenzione';
                } else {
                    reputationBar.style.background = '#9C27B0';
                    reputationStatus.textContent = 'Limitato';
                }
            }
        }

        // =============================================
        // INIZIALIZZAZIONE APPLICAZIONE
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            initUserStats();
            initUserReputation();
            initEventListeners();
            loadPhotosForVoting();
            loadAchievements();
            loadStats();
            initDarkMode();
            
            if (!hasAcceptedTerms) {
                setTimeout(() => {
                    showTermsModal();
                }, 1000);
            }
            
            initializeOneSignal();
            updateAdminUI();
            requestNotificationPermission();
            initBattleSystem();
            
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                updateDarkMode(this.checked);
            });
        });

        // =============================================
        // GESTIONE TERMINI DI SERVIZIO
        // =============================================

        function showTermsModal() {
            document.getElementById('termsModal').style.display = 'flex';
            loadTermsContent();
            
            document.getElementById('acceptTermsCheckbox').addEventListener('change', function() {
                document.getElementById('acceptTermsBtn').disabled = !this.checked;
            });
        }

        function loadTermsContent() {
            const termsContent = document.getElementById('termsContent');
            termsContent.innerHTML = `
                <h4>1. ACCETTAZIONE DEI TERMINI</h4>
                <p>Accedendo e utilizzando il servizio "Smash or Pass - Cesaris Edition" (di seguito "il Servizio"), 
                l'Utente dichiara di aver letto, compreso e accettato integralmente i presenti Termini di Servizio.</p>

                <h4>2. RESPONSABILIT√Ä DELL'UTENTE</h4>
                <p>2.1 L'Utente √® l'unico responsabile del contenuto delle foto caricate e garantisce di:</p>
                <ul>
                    <li>Essere il legittimo titolare o avere ottenuto le necessarie autorizzazioni</li>
                    <li>Non violare diritti di terzi, inclusi diritti d'autore, marchi o diritti alla privacy</li>
                    <li>Non caricare contenuti illegali, diffamatori, osceni o inappropriate</li>
                    <li>Avere almeno 18 anni di et√† o l'et√† legale nel proprio paese di residenza</li>
                </ul>

                <h4>3. LIMITAZIONE DI RESPONSABILIT√Ä</h4>
                <p>3.1 Il Gestore del Servizio declina ogni responsabilit√† riguardo a:</p>
                <ul>
                    <li>Contenuti caricati dagli Utenti e loro eventuale illecita diffusione</li>
                    <li>Danni diretti o indiretti derivanti dall'uso del Servizio</li>
                    <li>Violazioni della privacy o utilizzo improprio delle foto</li>
                    <li>Risultati delle votazioni e loro interpretazione</li>
                    <li>Conseguenze giudiziarie o legali derivanti dall'use del Servizio</li>
                </ul>

                <h4>4. GARANZIE E DISCLAIMER</h4>
                <p>4.1 Il Servizio √® fornito "cos√¨ com'√®" senza garanzie di alcun tipo, esplicite o implicite.</p>
                <p>4.2 Il Gestore non garantisce la continuit√†, sicurezza o assenza di errori del Servizio.</p>
                <p>4.3 L'Utente accetta che le votazioni "Smash or Pass" sono a scopo puramente ricreativo 
                e non costituiscono giudizi con valore legale o sociale.</p>

                <h4>5. PROPRIET√Ä INTELLETTUALE</h4>
                <p>5.1 L'Utente conserva la propriet√† delle foto caricate ma concede al Gestore la licenza 
                necessaria per l'operativit√† del Servizio.</p>

                <h4>6. MODIFICHE AI TERMINI</h4>
                <p>Il Gestore si riserva il diritto di modificare i presenti Termini in qualsiasi momento. 
                L'uso continuato del Servizio costituisce accettazione delle modifiche.</p>

                <h4>7. LEGGE APPLICABILE</h4>
                <p>I presenti Termini sono regolati dalla legge italiana. Per qualsiasi controversia 
                √® competente il Foro di Milano.</p>

                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h4>‚ö†Ô∏è AVVISO IMPORTANTE</h4>
                    <p>Il Servizio √® fornito a scopo puramente ricreativo. Il Gestore non √® responsabile 
                    per l'uso che terzi potrebbero fare delle foto caricate o dei risultati delle votazioni. 
                    Si raccomanda discrezione e rispetto delle leggi vigenti.</p>
                </div>
            `;
        }

        function acceptTerms() {
            localStorage.setItem('hasAcceptedTerms', 'true');
            hasAcceptedTerms = true;
            document.getElementById('termsModal').style.display = 'none';
            showNotification('Termini accettati. Benvenuto!', false, 'success');
        }

        // =============================================
        // SISTEMA UPLOAD FOTO
        // =============================================

        async function uploadPhoto() {
            if (userUploadedPhotos.length >= 1) {
                showNotification('Hai gi√† caricato una foto per la votazione! Puoi caricare solo una foto per categoria.', true);
                return;
            }

            if (!selectedFile || !selectedGender) {
                showNotification('Seleziona prima una foto e un genere!', true);
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Caricamento...';
            
            try {
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('photo-uploads')
                    .upload(fileName, selectedFile);
                
                if (uploadError) throw uploadError;
                
                const { data: urlData } = supabase.storage
                    .from('photo-uploads')
                    .getPublicUrl(fileName);
                
                const { data: photoData, error: dbError } = await supabase
                    .from('photos')
                    .insert([{
                        image_url: urlData.publicUrl,
                        gender: selectedGender,
                        smash_count: 0,
                        pass_count: 0,
                        report_count: 0,
                        status: 'active',
                    
                        photo_type: 'votation'
                    }])
                    .select()
                    .single();
                
                if (dbError) throw dbError;

                userUploadedPhotos.push(photoData.id);
                localStorage.setItem('userUploadedPhotos', JSON.stringify(userUploadedPhotos));
                
                updateUploadStats();
                updateAchievements();
                
                showNotification('Foto caricata con successo per la votazione!');
                
                setTimeout(() => {
                    selectedFile = null;
                    selectedGender = null;
                    document.getElementById('previewImage').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    goToStep(1);
                    
                    document.querySelectorAll('#step1-content .gender-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.getElementById('nextToStep2').disabled = true;
                    
                }, 1000);
                
            } catch (error) {
                console.error('Errore durante il caricamento:', error);
                showNotification('Errore durante il caricamento. Riprova.', true);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Carica Foto';
            }
        }

        // =============================================
        // SISTEMA BATTAGLIA
        // =============================================

        async function confirmBattlePhotoUpload() {
            if (!selectedBattlePhoto || !currentBattleSlot) return;
            
            if (selectedBattlePhoto instanceof File) {
                if (userBattlePhotos.length >= 1) {
                    showNotification('Hai gi√† caricato una foto per le battaglie!', true);
                    return;
                }
            }
            
            try {
                let photo;
                
                if (selectedBattlePhoto instanceof File) {
                    const fileExt = selectedBattlePhoto.name.split('.').pop();
                    const fileName = `battle_${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('photo-uploads')
                        .upload(fileName, selectedBattlePhoto);
                    
                    if (uploadError) throw uploadError;
                    
                    const { data: urlData } = supabase.storage
                        .from('photo-uploads')
                        .getPublicUrl(fileName);
                    
                    const { data: photoData, error: dbError } = await supabase
                        .from('photos')
                        .insert([{
                            image_url: urlData.publicUrl,
                            gender: 'battle',
                            smash_count: 0,
                            pass_count: 0,
                            battle_wins: 0,
                            report_count: 0,
                            status: 'active',
                        
                            photo_type: 'battle'
                        }])
                        .select()
                        .single();
                    
                    if (dbError) throw dbError;
                    
                    photo = photoData;
                    
                    userBattlePhotos.push(photo.id);
                    localStorage.setItem('userBattlePhotos', JSON.stringify(userBattlePhotos));
                    
                } else {
                    const { data: photoData, error } = await supabase
                        .from('photos')
                        .select('*')
                        .eq('id', selectedBattlePhoto)
                        .single();
                        
                    if (error) throw error;
                    photo = photoData;
                }
                
                updateBattleSlot(currentBattleSlot, photo);
                closeBattlePhotoModal();
                checkBattleReady();
                
                showNotification('Foto aggiunta alla battaglia!');
                
            } catch (error) {
                console.error('Errore durante il caricamento battaglia:', error);
                showNotification('Errore durante il caricamento. Riprova.', true);
            }
        }

        // =============================================
        // SISTEMA MODERAZIONE AVANZATA
        // =============================================

        function openModerationTab(tabName, element) {
            document.querySelectorAll('.moderation-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.moderation-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            element.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function openAdvancedModeration(photoId) {
            currentModerationPhoto = photoId;
            document.getElementById('currentModPhotoId').textContent = photoId;
            document.getElementById('advancedModerationModal').style.display = 'flex';
            
            loadModerationHistory(photoId);
        }

        async function performAdvancedSuspend() {
            if (!currentModerationPhoto) return;
            
            const severity = document.getElementById('suspendSeverity').value;
            const reason = document.getElementById('suspendReason').value;
            const details = document.getElementById('suspendDetails').value;
            const applyPenalty = document.getElementById('notifyUser').checked;
            
            try {
                // Determina l'azione in base alla gravit√†
                let action, duration, pointsDeducted;
                
                switch (severity) {
                    case 'low':
                        action = 'warning';
                        duration = 0;
                        pointsDeducted = applyPenalty ? MODERATION_CONFIG.REPUTATION.DEDUCTIONS.LOW : 0;
                        break;
                    case 'medium':
                        action = 'suspend';
                        duration = 24 * 60 * 60 * 1000; // 24 ore
                        pointsDeducted = applyPenalty ? MODERATION_CONFIG.REPUTATION.DEDUCTIONS.MEDIUM : 0;
                        break;
                    case 'high':
                        action = 'suspend';
                        duration = 7 * 24 * 60 * 60 * 1000; // 7 giorni
                        pointsDeducted = applyPenalty ? MODERATION_CONFIG.REPUTATION.DEDUCTIONS.HIGH : 0;
                        break;
                    case 'critical':
                        action = 'remove';
                        duration = 0;
                        pointsDeducted = applyPenalty ? MODERATION_CONFIG.REPUTATION.DEDUCTIONS.CRITICAL : 0;
                        break;
                }
                
                // Esegui l'azione
                if (action === 'suspend') {
                    await suspendPhoto(currentModerationPhoto, `${reason}${details ? ': ' + details : ''}`);
                } else if (action === 'remove') {
                    await rejectPhoto(currentModerationPhoto);
                }
                
                // Applica penalit√† reputazione
                if (applyPenalty && pointsDeducted > 0) {
                    const { data: photo } = await supabase
                        .from('photos')
                        .select('uploaded_by')
                        .eq('id', currentModerationPhoto)
                        .single();
                        
                    if (photo && photo.uploaded_by) {
                        await updateUserReputation(photo.uploaded_by, -pointsDeducted, `Moderazione: ${reason}`);
                    }
                }
                
                // Registra l'azione
                await logModerationAction({
                    photo_id: currentModerationPhoto,
                    action: action,
                    reason: reason,
                    details: details,
                    severity: severity,
                    points_deducted: pointsDeducted,
                    moderator_id: userUniqueId
                });
                
                showNotification(`Azione di moderazione applicata! Gravit√†: ${severity}`, false, 'success');
                closeModal('advancedModerationModal');
                loadReportedPhotos();
                
            } catch (error) {
                console.error('Errore nella moderazione avanzata:', error);
                showNotification('Errore durante la moderazione.', true);
            }
        }

        async function updateUserReputation(userId, pointsChange, reason) {
            try {
                const { data: reputation, error } = await supabase
                    .from('user_reputation')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                    
                let newPoints = MODERATION_CONFIG.REPUTATION.INITIAL_POINTS;
                if (!error && reputation) {
                    newPoints = Math.max(0, reputation.points + pointsChange);
                    
                    await supabase
                        .from('user_reputation')
                        .update({ 
                            points: newPoints,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userId);
                } else {
                    newPoints = Math.max(0, MODERATION_CONFIG.REPUTATION.INITIAL_POINTS + pointsChange);
                    
                    await supabase
                        .from('user_reputation')
                        .insert([{
                            user_id: userId,
                            points: newPoints,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }]);
                }
                
                // Applica conseguenze
                await applyReputationConsequences(userId, newPoints);
                
                await logModerationAction({
                    user_id: userId,
                    action: 'reputation_update',
                    reason: reason,
                    points_change: pointsChange,
                    new_points: newPoints,
                    moderator_id: userUniqueId
                });
                
            } catch (error) {
                console.error('Errore nell\'aggiornamento reputazione:', error);
            }
        }

        async function applyReputationConsequences(userId, points) {
            if (points <= MODERATION_CONFIG.REPUTATION.THRESHOLDS.BANNED) {
                await banUser(userId);
            } else if (points <= MODERATION_CONFIG.REPUTATION.THRESHOLDS.SUSPENDED) {
                await suspendUser(userId, 7 * 24 * 60 * 60 * 1000);
            } else if (points <= MODERATION_CONFIG.REPUTATION.THRESHOLDS.LIMITED) {
                await limitUser(userId);
            }
        }

        async function suspendUser(userId, duration) {
            try {
                const suspendUntil = new Date(Date.now() + duration).toISOString();
                
                await supabase
                    .from('user_suspensions')
                    .insert([{
                        user_id: userId,
                        suspend_until: suspendUntil,
                        reason: 'Reputazione bassa'
                    }]);
                    
                await sendAdminNotification('‚è∏Ô∏è Utente Sospeso', 
                    `L'utente ${userId} √® stato sospeso fino a ${new Date(suspendUntil).toLocaleDateString()} per reputazione bassa.`, 
                    null, { user_id: userId });
                
            } catch (error) {
                console.error('Errore nella sospensione utente:', error);
            }
        }

        async function limitUser(userId) {
            // Implementa limitazioni per l'utente
            console.log(`Limitazioni applicate per l'utente: ${userId}`);
        }

        async function banUser(userId) {
            try {
                // Sospendi tutte le foto dell'utente
                await supabase
                    .from('photos')
                    .update({ status: 'suspended' })
                    .eq('uploaded_by', userId);
                    
                await sendAdminNotification('üö´ Utente Bannato', 
                    `L'utente ${userId} √® stato bannato permanentemente per reputazione zero.`, 
                    null, { user_id: userId });
                
            } catch (error) {
                console.error('Errore nel ban utente:', error);
            }
        }

        async function loadModerationHistory(photoId) {
            try {
                const { data: history, error } = await supabase
                    .from('moderation_logs')
                    .select('*')
                    .eq('photo_id', photoId)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                const historyContainer = document.getElementById('moderationHistory');
                
                if (!history || history.length === 0) {
                    historyContainer.innerHTML = '<div class="empty-state"><p>Nessuna cronologia</p></div>';
                    return;
                }
                
                historyContainer.innerHTML = history.map(log => `
                    <div class="moderation-log-item ${log.action}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${getActionText(log.action)}</strong>
                            <span class="severity-badge severity-${log.severity || 'low'}">
                                ${log.severity || 'N/A'}
                            </span>
                        </div>
                        <div>Motivo: ${log.reason}</div>
                        ${log.details ? `<div>Dettagli: ${log.details}</div>` : ''}
                        ${log.points_deducted ? `<div>Penalit√†: ${log.points_deducted} punti</div>` : ''}
                        <div style="font-size: 12px; color: #666;">
                            ${new Date(log.created_at).toLocaleString('it-IT')} ‚Ä¢ Moderatore: ${log.moderator_id}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Errore nel caricamento cronologia:', error);
            }
        }

        function getActionText(action) {
            const actions = {
                'suspend': '‚è∏Ô∏è Sospeso',
                'approve': '‚úÖ Approvato',
                'reject': '‚ùå Rimosso',
                'warning': '‚ö†Ô∏è Avviso',
                'remove': 'üóëÔ∏è Rimosso',
                'reputation_update': 'üèÖ Reputazione'
            };
            return actions[action] || action;
        }

        function applyTemplate(templateType) {
            const severityMap = {
                'standard_suspend': 'medium',
                'content_removal': 'high',
                'warning_only': 'low'
            };
            
            const reasonMap = {
                'standard_suspend': 'Violazione termini di servizio',
                'content_removal': 'Contenuto inappropriato grave',
                'warning_only': 'Avviso per comportamento'
            };
            
            document.getElementById('suspendSeverity').value = severityMap[templateType];
            document.getElementById('suspendReason').value = 'content_inappropriate';
            document.getElementById('suspendDetails').value = reasonMap[templateType];
            document.getElementById('notifyUser').checked = true;
            
            showNotification(`Template ${templateType} applicato!`, false, 'info');
        }

        // =============================================
        // FUNZIONI AUSILIARIE ESISTENTI
        // =============================================

        // Funzione per mostrare notifiche
        function showNotification(message, isError = false, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
            } else if (type === 'info') {
                notification.classList.add('info');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            } else if (type === 'success') {
                notification.classList.add('success');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
// =============================================
// FUNZIONI BATTAGLIA SMASH
// =============================================

function initBattleSystem() {
    loadCurrentBattle();
    updateBattleStats();
    loadBattleHistory();
    
    // Avvia il timer per aggiornamenti in tempo reale
    setInterval(updateBattleStatus, 5000);
}

async function loadCurrentBattle() {
    try {
        const { data: battles, error } = await supabase
            .from('battles')
            .select('*')
            .eq('status', 'active')
            .order('created_at', { ascending: false })
            .limit(1);

        if (error) throw error;

        if (battles && battles.length > 0) {
            currentBattle = battles[0];
            await loadBattlePhotos(currentBattle);
            updateBattleUI();
            startBattleTimer();
        } else {
            currentBattle = null;
            showEmptyBattleState();
        }
    } catch (error) {
        console.error('Errore nel caricamento della battaglia:', error);
        showEmptyBattleState();
    }
}

function showEmptyBattleState() {
    document.getElementById('battleStatus').textContent = 'Nessuna battaglia attiva';
    document.getElementById('joinBattleBtn').style.display = 'none';
    document.getElementById('startBattleBtn').style.display = 'block';
    document.getElementById('voteButtons').style.display = 'none';
    
    // Resetta gli slot
    resetBattleSlots();
}

function updateBattleStats() {
    document.getElementById('totalBattles').textContent = userBattleStats.totalBattles || 0;
    document.getElementById('activeBattles').textContent = currentBattle ? 1 : 0;
    document.getElementById('userWins').textContent = userBattleStats.wins || 0;
}

function openBattlePhotoSelector(slotNumber) {
    currentBattleSlot = slotNumber;
    document.getElementById('battlePhotoModal').style.display = 'flex';
    
    // Reset delle sezioni
    document.getElementById('battlePhotoSelection').style.display = 'none';
    document.getElementById('battleUploadSection').style.display = 'none';
}

function closeBattlePhotoModal() {
    document.getElementById('battlePhotoModal').style.display = 'none';
    currentBattleSlot = null;
    selectedBattlePhoto = null;
}

async function showExistingPhotos() {
    document.getElementById('battlePhotoSelection').style.display = 'block';
    document.getElementById('battleUploadSection').style.display = 'none';
    
    try {
        // Carica le foto dell'utente
        const userPhotoIds = JSON.parse(localStorage.getItem('userUploadedPhotos') || '[]');
        
        if (userPhotoIds.length === 0) {
            document.getElementById('existingPhotosList').innerHTML = 
                '<div class="empty-state"><p>Non hai ancora caricato foto</p></div>';
            return;
        }
        
        // Carica i dettagli delle foto
        const { data: photos, error } = await supabase
            .from('photos')
            .select('*')
            .in('id', userPhotoIds)
            .eq('status', 'active');
            
        if (error) throw error;
        
        if (!photos || photos.length === 0) {
            document.getElementById('existingPhotosList').innerHTML = 
                '<div class="empty-state"><p>Nessuna foto disponibile</p></div>';
            return;
        }
        
        // Mostra le foto
        document.getElementById('existingPhotosList').innerHTML = photos.map(photo => `
            <div class="battle-photo-option" onclick="selectExistingPhoto('${photo.id}')">
                <img src="${photo.image_url}" alt="Foto" onerror="this.style.display='none'">
                <div style="padding: 5px; text-align: center; font-size: 12px;">
                    <div>üòç ${photo.smash_count}</div>
                    <div>‚öîÔ∏è ${photo.battle_wins || 0}</div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Errore nel caricamento foto esistenti:', error);
        document.getElementById('existingPhotosList').innerHTML = 
            '<div class="empty-state"><p>Errore nel caricamento</p></div>';
    }
}

function selectExistingPhoto(photoId) {
    selectedBattlePhoto = photoId;
    
    // Rimuovi selezione precedente
    document.querySelectorAll('.battle-photo-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Aggiungi selezione corrente
    event.target.closest('.battle-photo-option').classList.add('selected');
}

function uploadNewBattlePhoto() {
    document.getElementById('battlePhotoSelection').style.display = 'none';
    document.getElementById('battleUploadSection').style.display = 'block';
    
    // Reset dell'anteprima
    document.getElementById('battlePreviewImage').style.display = 'none';
    document.getElementById('confirmBattleUpload').disabled = true;
    
    // Aggiungi listener per il file input
    document.getElementById('battleFileInput').addEventListener('change', function(e) {
        if (e.target.files.length) {
            handleBattleFileSelection(e.target.files[0]);
        }
    });
}

function handleBattleFileSelection(file) {
    if (!file) return;
    
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    
    if (!allowedTypes.includes(file.type)) {
        showNotification('Tipo di file non supportato! Usa solo JPEG, PNG o WebP.', true);
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('L\'immagine √® troppo grande! Massimo 5MB.', true);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById('battlePreviewImage');
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        document.getElementById('confirmBattleUpload').disabled = false;
        
        selectedBattlePhoto = file;
    };
    reader.readAsDataURL(file);
}

function updateBattleSlot(slotNumber, photo) {
    const slot = document.getElementById(`slot${slotNumber}`);
    const emptyDiv = slot.querySelector('.slot-empty');
    const contentDiv = slot.querySelector('.slot-content');
    
    emptyDiv.style.display = 'none';
    contentDiv.style.display = 'flex';
    
    // Aggiorna l'immagine e le info
    document.getElementById(`slot${slotNumber}Image`).src = photo.image_url;
    document.getElementById(`slot${slotNumber}Name`).textContent = `Foto #${photo.id.substring(0, 8)}`;
    document.getElementById(`slot${slotNumber}Smash`).textContent = photo.smash_count;
    document.getElementById(`slot${slotNumber}Wins`).textContent = photo.battle_wins || 0;
    
    // Salva la foto nello stato della battaglia
    if (!currentBattle) {
        currentBattle = {
            slot1: slotNumber === 1 ? photo : null,
            slot2: slotNumber === 2 ? photo : null,
            status: 'setting_up'
        };
    } else {
        currentBattle[`slot${slotNumber}`] = photo;
    }
}

function checkBattleReady() {
    if (currentBattle && currentBattle.slot1 && currentBattle.slot2) {
        document.getElementById('joinBattleBtn').style.display = 'block';
        document.getElementById('startBattleBtn').style.display = 'none';
    }
}

async function joinBattle() {
    if (!currentBattle || !currentBattle.slot1 || !currentBattle.slot2) {
        showNotification('La battaglia non √® pronta!', true);
        return;
    }
    
    try {
        // Calcola il tempo di fine (ora corrente + 1 ora)
        const startTime = new Date();
        const endTime = new Date(startTime.getTime() + BATTLE_CONFIG.WIN_CONDITION.TIME_LIMIT);
        
        // Crea la battaglia nel database
        const { data: battle, error } = await supabase
            .from('battles')
            .insert([{
                photo1_id: currentBattle.slot1.id,
                photo2_id: currentBattle.slot2.id,
                status: 'active',
                votes1: 0,
                votes2: 0,
                start_time: startTime.toISOString(),
                end_time: endTime.toISOString()
            }])
            .select()
            .single();
            
        if (error) throw error;
        
        currentBattle = battle;
        await loadBattlePhotos(currentBattle);
        
        // Aggiorna l'UI
        updateBattleUI();
        startBattleTimer();
        
        showNotification('Battaglia iniziata! Gli utenti possono ora votare. La battaglia durer√† 1 ora.');
        
    } catch (error) {
        console.error('Errore nell\'avviare la battaglia:', error);
        showNotification('Errore nell\'avviare la battaglia', true);
    }
}

function startNewBattle() {
    resetBattleSlots();
    currentBattle = {
        status: 'setting_up',
        slot1: null,
        slot2: null
    };
    
    document.getElementById('joinBattleBtn').style.display = 'none';
    document.getElementById('startBattleBtn').style.display = 'none';
    document.getElementById('voteButtons').style.display = 'none';
    document.getElementById('battleStatus').textContent = 'Seleziona le foto per la battaglia';
}

function resetBattleSlots() {
    for (let i = 1; i <= 2; i++) {
        const slot = document.getElementById(`slot${i}`);
        const emptyDiv = slot.querySelector('.slot-empty');
        const contentDiv = slot.querySelector('.slot-content');
        
        emptyDiv.style.display = 'flex';
        contentDiv.style.display = 'none';
    }
}

async function voteBattle(slotNumber) {
    if (!currentBattle || currentBattle.status !== 'active') {
        showNotification('Nessuna battaglia attiva!', true);
        return;
    }
    
    // Controlla se l'utente ha gi√† votato
    const battleVotes = JSON.parse(localStorage.getItem('battleVotes') || '{}');
    if (battleVotes[currentBattle.id]) {
        showNotification('Hai gi√† votato in questa battaglia!', true);
        return;
    }
    
    try {
        // Aggiorna il conteggio voti
        const voteField = `votes${slotNumber}`;
        const newVotes = currentBattle[voteField] + 1;
        
        const { error } = await supabase
            .from('battles')
            .update({ [voteField]: newVotes })
            .eq('id', currentBattle.id);
            
        if (error) throw error;
        
        // Aggiorna lo stato locale
        currentBattle[voteField] = newVotes;
        
        // Salva il voto dell'utente
        battleVotes[currentBattle.id] = true;
        localStorage.setItem('battleVotes', JSON.stringify(battleVotes));
        
        // Aggiorna l'UI
        updateBattleProgress();
        
        // Controlla se la battaglia √® finita
        await checkBattleEnd();
        
        showNotification(`Hai votato per la foto ${slotNumber === 1 ? 'sinistra' : 'destra'}!`);
        
    } catch (error) {
        console.error('Errore nel voto:', error);
        showNotification('Errore nel voto. Riprova.', true);
    }
}

function startBattleTimer() {
    if (!currentBattle || !currentBattle.end_time) return;
    
    clearInterval(battleTimer);
    
    battleTimer = setInterval(() => {
        updateBattleTimer();
        checkBattleEnd();
    }, 1000);
    
    updateBattleTimer();
}

function updateBattleTimer() {
    if (!currentBattle || !currentBattle.end_time) return;
    
    const now = new Date();
    const end = new Date(currentBattle.end_time);
    const diff = end - now;
    
    if (diff <= 0) {
        document.getElementById('timerText').textContent = 'Tempo scaduto';
        clearInterval(battleTimer);
        return;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('timerText').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

async function checkBattleEnd() {
    if (!currentBattle || currentBattle.status !== 'active') return;
    
    const totalVotes = currentBattle.votes1 + currentBattle.votes2;
    const now = new Date();
    const endTime = new Date(currentBattle.end_time);
    
    let winner = null;
    let reason = '';
    
    // Condizione 1: Vince chi raggiunge 50 voti
    if (currentBattle.votes1 >= BATTLE_CONFIG.WIN_CONDITION.VOTE_COUNT) {
        winner = 1;
        reason = 'Voti massimi raggiunti';
    } else if (currentBattle.votes2 >= BATTLE_CONFIG.WIN_CONDITION.VOTE_COUNT) {
        winner = 2;
        reason = 'Voti massimi raggiunti';
    }
    // Condizione 2: Tempo scaduto con almeno 10 voti totali
    else if (now >= endTime && totalVotes >= BATTLE_CONFIG.WIN_CONDITION.MIN_VOTES) {
        winner = currentBattle.votes1 > currentBattle.votes2 ? 1 : 
                currentBattle.votes2 > currentBattle.votes1 ? 2 : 0;
        reason = 'Tempo scaduto';
    }
    // Condizione 3: Differenza di 20 voti
    else if (Math.abs(currentBattle.votes1 - currentBattle.votes2) >= 20 && totalVotes >= 20) {
        winner = currentBattle.votes1 > currentBattle.votes2 ? 1 : 2;
        reason = 'Differenza significativa';
    }
    
    if (winner !== null) {
        await endBattle(winner, reason);
    }
}

async function endBattle(winner, reason) {
    try {
        clearInterval(battleTimer);
        
        // Aggiorna lo stato della battaglia
        const { error } = await supabase
            .from('battles')
            .update({
                status: 'completed',
                winner: winner,
                end_reason: reason
            })
            .eq('id', currentBattle.id);
            
        if (error) throw error;
        
        // Aggiorna le statistiche delle foto
        if (winner > 0) {
            await updateBattleWinner(winner);
        }
        
        // Mostra il risultato
        showBattleResult(winner, reason);
        
        // Aggiorna le statistiche utente
        updateUserBattleStats(winner);
        
        // Ricarica la classifica
        loadLeaderboard();
        
        // Prepara per una nuova battaglia dopo 10 secondi
        setTimeout(() => {
            loadCurrentBattle();
        }, 10000);
        
    } catch (error) {
        console.error('Errore nel terminare la battaglia:', error);
    }
}

async function updateBattleWinner(winner) {
    const winnerPhotoId = winner === 1 ? currentBattle.photo1_id : currentBattle.photo2_id;
    const loserPhotoId = winner === 1 ? currentBattle.photo2_id : currentBattle.photo1_id;
    
    try {
        // Incrementa le vittorie della foto vincitrice
        const { data: winnerPhoto, error: winnerError } = await supabase
            .from('photos')
            .select('battle_wins, smash_count')
            .eq('id', winnerPhotoId)
            .single();
            
        if (!winnerError) {
            await supabase
                .from('photos')
                .update({
                    battle_wins: (winnerPhoto.battle_wins || 0) + 1,
                    smash_count: winnerPhoto.smash_count + BATTLE_CONFIG.REWARDS.WINNER_SMASH_BOOST
                })
                .eq('id', winnerPhotoId);
        }
        
        // Bonus partecipazione per entrambe le foto
        const { data: loserPhoto, error: loserError } = await supabase
            .from('photos')
            .select('smash_count')
            .eq('id', loserPhotoId)
            .single();
            
        if (!loserError) {
            await supabase
                .from('photos')
                .update({
                    smash_count: loserPhoto.smash_count + BATTLE_CONFIG.REWARDS.PARTICIPATION_SMASH
                })
                .eq('id', loserPhotoId);
        }
        
    } catch (error) {
        console.error('Errore nell\'aggiornamento del vincitore:', error);
    }
}

function updateBattleUI() {
    if (!currentBattle) return;
    
    document.getElementById('battleStatus').textContent = 
        currentBattle.status === 'active' ? 'Battaglia in corso!' : 'In preparazione';
    
    document.getElementById('totalVotesBattle').textContent = 
        (currentBattle.votes1 || 0) + (currentBattle.votes2 || 0);
    
    document.getElementById('winCondition').textContent = 
        `${BATTLE_CONFIG.WIN_CONDITION.VOTE_COUNT} voti o 1 ora`;
    
    // Mostra/nascondi pulsanti in base allo stato
    if (currentBattle.status === 'active') {
        document.getElementById('joinBattleBtn').style.display = 'none';
        document.getElementById('startBattleBtn').style.display = 'none';
        document.getElementById('voteButtons').style.display = 'flex';
    }
    
    updateBattleProgress();
}

function updateBattleProgress() {
    if (!currentBattle) return;
    
    const votes1 = currentBattle.votes1 || 0;
    const votes2 = currentBattle.votes2 || 0;
    const totalVotes = votes1 + votes2;
    
    if (totalVotes > 0) {
        const percent1 = (votes1 / totalVotes) * 100;
        const percent2 = (votes2 / totalVotes) * 100;
        
        document.getElementById('progressLeft').style.width = `${percent1}%`;
        document.getElementById('progressRight').style.width = `${percent2}%`;
        document.getElementById('leftPercent').textContent = `${Math.round(percent1)}%`;
        document.getElementById('rightPercent').textContent = `${Math.round(percent2)}%`;
    }
}

function showBattleResult(winner, reason) {
    let message = '';
    
    if (winner === 0) {
        message = '‚öîÔ∏è Battaglia terminata in PAREGGIO!';
    } else {
        message = `üéâ Foto ${winner === 1 ? 'SINISTRA' : 'DESTRA'} VINCE! (${reason})`;
        
        // Evidenzia il vincitore
        const winnerSlot = document.getElementById(`slot${winner}`);
        winnerSlot.style.borderColor = '#4CAF50';
        winnerSlot.style.animation = 'pulse 2s infinite';
    }
    
    document.getElementById('battleStatus').textContent = message;
    document.getElementById('voteButtons').style.display = 'none';
    
    showNotification(message, false, 'success');
}

function updateUserBattleStats(winner) {
    if (!userBattleStats.totalBattles) userBattleStats.totalBattles = 0;
    if (!userBattleStats.wins) userBattleStats.wins = 0;
    
    userBattleStats.totalBattles++;
    
    // Controlla se l'utente ha vinto (semplificato)
    if (winner > 0) {
        userBattleStats.wins++;
    }
    
    localStorage.setItem('userBattleStats', JSON.stringify(userBattleStats));
    updateBattleStats();
}

async function loadBattlePhotos(battle) {
    try {
        const photoIds = [battle.photo1_id, battle.photo2_id].filter(id => id);
        
        if (photoIds.length === 0) return;
        
        const { data: photos, error } = await supabase
            .from('photos')
            .select('*')
            .in('id', photoIds);
            
        if (error) throw error;
        
        if (photos && photos.length > 0) {
            photos.forEach(photo => {
                if (photo.id === battle.photo1_id) {
                    updateBattleSlot(1, photo);
                } else if (photo.id === battle.photo2_id) {
                    updateBattleSlot(2, photo);
                }
            });
        }
        
    } catch (error) {
        console.error('Errore nel caricamento foto battaglia:', error);
    }
}

async function loadBattleHistory() {
    try {
        const { data: battles, error } = await supabase
            .from('battles')
            .select(`
                *,
                photo1:photos!battles_photo1_id_fkey (image_url, smash_count, battle_wins),
                photo2:photos!battles_photo2_id_fkey (image_url, smash_count, battle_wins)
            `)
            .eq('status', 'completed')
            .order('created_at', { ascending: false })
            .limit(10);
            
        if (error) throw error;
        
        const historyList = document.getElementById('battleHistoryList');
        
        if (!battles || battles.length === 0) {
            historyList.innerHTML = '<div class="empty-state"><p>Nessuna battaglia completata</p></div>';
            return;
        }
        
        historyList.innerHTML = battles.map(battle => {
            const isWinner1 = battle.winner === 1;
            const isWinner2 = battle.winner === 2;
            
            return `
                <div class="battle-history-item ${isWinner1 || isWinner2 ? 'battle-history-winner' : ''}">
                    <img src="${battle.photo1?.image_url}" class="battle-history-photo" alt="Foto 1">
                    <div class="battle-history-info">
                        <div>üòç ${battle.photo1?.smash_count} | ‚öîÔ∏è ${battle.photo1?.battle_wins || 0}</div>
                        ${isWinner1 ? '<div style="color: #4CAF50; font-weight: bold;">üëë VINCITORE</div>' : ''}
                    </div>
                    <span class="battle-history-vs">VS</span>
                    <img src="${battle.photo2?.image_url}" class="battle-history-photo" alt="Foto 2">
                    <div class="battle-history-info">
                        <div>üòç ${battle.photo2?.smash_count} | ‚öîÔ∏è ${battle.photo2?.battle_wins || 0}</div>
                        ${isWinner2 ? '<div style="color: #4CAF50; font-weight: bold;">üëë VINCITORE</div>' : ''}
                    </div>
                    <div style="margin-left: auto; text-align: right;">
                        <small>${new Date(battle.created_at).toLocaleDateString('it-IT')}</small>
                        <br>
                        <small>Voti: ${battle.votes1 + battle.votes2}</small>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Errore nel caricamento storico battaglie:', error);
        document.getElementById('battleHistoryList').innerHTML = 
            '<div class="empty-state"><p>Errore nel caricamento</p></div>';
    }
}

async function updateBattleStatus() {
    if (!currentBattle || currentBattle.status !== 'active') return;
    
    try {
        const { data: battle, error } = await supabase
            .from('battles')
            .select('*')
            .eq('id', currentBattle.id)
            .single();
            
        if (error) throw error;
        
        if (battle && battle.status === 'active') {
            currentBattle = battle;
            updateBattleUI();
        }
        
    } catch (error) {
        console.error('Errore nell\'aggiornamento stato battaglia:', error);
    }
}

// =============================================
// SISTEMA ONESIGNAL E NOTIFICHE PUSH
// =============================================

// CONFIGURAZIONE ADMIN - MODIFICA QUESTI TOKEN!
const ADMIN_CONFIG = {
    tokens: ['ADMIN_MASTER_KEY_12345', 'BACKUP_ADMIN_KEY_67890'], // CAMBIA QUESTI TOKEN!
    notificationSettings: {
        enabled: true,
        reportThreshold: 3,
        notifyOnSuspension: true,
        notifyOnNewReport: false
    }
};

// Inizializzazione OneSignal
window.OneSignal = window.OneSignal || [];

function initializeOneSignal() {
    OneSignal.push(function() {
        OneSignal.init({
            appId: ONESIGNAL_APP_ID,
            notifyButton: {
                enable: false,
            },
            allowLocalhostAsSecureOrigin: true,
        });

        // Quando l'utente si registra, ottieni il suo ID
        OneSignal.getUserId(function(userId) {
            if (userId) {
                console.log("OneSignal User ID:", userId);
                localStorage.setItem('onesignal_user_id', userId);
                
                // Se √® admin, registralo
                if (isUserAdmin()) {
                    registerAdminUser(userId);
                }
            }
        });

        // Gestisci il click sulle notifiche
        OneSignal.on('notificationClick', function(event) {
            console.log('Notification clicked:', event);
            
            // Se la notifica ha dati specifici, gestiscili
            if (event.data && event.data.photoId) {
                switchToModerationTab(event.data.photoId);
            } else {
                switchToModerationTab();
            }
            
            // Chiudi la notifica
            event.notification.close();
        });
    });
}

function registerAdminUser(userId) {
    // Salva l'ID admin nel localStorage
    const adminUsers = JSON.parse(localStorage.getItem('admin_users') || '[]');
    if (!adminUsers.includes(userId)) {
        adminUsers.push(userId);
        localStorage.setItem('admin_users', JSON.stringify(adminUsers));
    }
    
    // Imposta il tag "admin" su OneSignal
    OneSignal.sendTag("admin", "true");
    console.log("Utente registrato come admin:", userId);
}

function isUserAdmin() {
    const adminToken = localStorage.getItem('adminToken');
    return adminToken && ADMIN_CONFIG.tokens.includes(adminToken);
}

function grantAdminAccess(token) {
    if (ADMIN_CONFIG.tokens.includes(token)) {
        localStorage.setItem('adminToken', token);
        
        // Registra come admin in OneSignal
        const userId = localStorage.getItem('onesignal_user_id');
        if (userId) {
            registerAdminUser(userId);
        }
        
        showNotification('‚úÖ Accesso admin autorizzato! Le notifiche push sono ora attive.', false, 'success');
        updateAdminUI();
        return true;
    } else {
        showNotification('‚ùå Token admin non valido!', true);
        return false;
    }
}

function revokeAdminAccess() {
    localStorage.removeItem('adminToken');
    
    // Rimuovi tag admin da OneSignal
    OneSignal.deleteTag("admin");
    
    showNotification('üîê Accesso admin revocato!', false, 'info');
    updateAdminUI();
}

function addNewAdminToken() {
    const currentToken = localStorage.getItem('adminToken');
    const newTokenInput = document.getElementById('newAdminToken');
    const newToken = newTokenInput.value.trim();
    
    if (!newToken) {
        showNotification('Inserisci un nuovo token!', true);
        return;
    }
    
    if (!ADMIN_CONFIG.tokens.includes(currentToken)) {
        showNotification('‚ùå Non autorizzato! Token corrente non valido.', true);
        return false;
    }
    
    if (ADMIN_CONFIG.tokens.includes(newToken)) {
        showNotification('‚ö†Ô∏è Token gi√† esistente!', false, 'warning');
        return true;
    }
    
    ADMIN_CONFIG.tokens.push(newToken);
    newTokenInput.value = '';
    showNotification('‚úÖ Nuovo admin aggiunto con successo!', false, 'success');
    
    // In un'app reale, qui salveresti i token in un database
    console.log("Nuovi token admin:", ADMIN_CONFIG.tokens);
    
    return true;
}

async function sendAdminNotification(title, message, photoId = null, data = {}) {
    try {
        if (!ADMIN_CONFIG.notificationSettings.enabled) {
            console.log("Notifiche disabilitate nelle impostazioni");
            return;
        }

        // Prepara i dati della notifica
        const notificationData = {
            app_id: ONESIGNAL_APP_ID,
            headings: { en: title },
            contents: { en: message },
            data: {
                action: "open_moderation",
                photoId: photoId,
                timestamp: new Date().toISOString(),
                ...data
            },
            url: window.location.href,
            chrome_web_icon: "https://via.placeholder.com/192x192/2a5298/ffffff?text=SOP",
            priority: 10
        };

        // Invia solo agli admin
        notificationData.filters = [
            { field: "tag", key: "admin", relation: "=", value: "true" }
        ];

        console.log("Invio notifica agli admin:", notificationData);

        // Usa l'API OneSignal per inviare la notifica
        await sendOneSignalNotification(notificationData);

        // Fallback: notifica del browser
        if ("Notification" in window && Notification.permission === "granted") {
            showBrowserNotification(title, message, photoId);
        }

    } catch (error) {
        console.error("Errore nell'invio della notifica:", error);
        // Fallback alle notifiche del browser
        if ("Notification" in window && Notification.permission === "granted") {
            showBrowserNotification(title, message, photoId);
        }
    }
}

async function sendOneSignalNotification(notificationData) {
    try {
        // NOTA: In produzione, questa chiamata dovrebbe essere fatta dal tuo backend
        // per non esporre la REST API Key nel client
        
        // Per testing, mostriamo solo in console
        console.log("üö® NOTIFICA PUSH (Simulata):", notificationData);
        
        // Se hai un backend, scommenta questo codice:
        /*
        const response = await fetch('/api/send-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(notificationData)
        });
        
        if (!response.ok) throw new Error('Errore API');
        */
        
    } catch (error) {
        console.error("Errore OneSignal API:", error);
        throw error;
    }
}

function showBrowserNotification(title, message, photoId = null) {
    const notification = new Notification(title, {
        body: message,
        icon: 'https://via.placeholder.com/192x192/2a5298/ffffff?text=SOP',
        badge: 'https://via.placeholder.com/72x72/2a5298/ffffff?text=SOP',
        tag: `sop-report-${photoId}`,
        data: { photoId: photoId },
        requireInteraction: true
    });

    notification.onclick = function() {
        window.focus();
        switchToModerationTab(photoId);
        notification.close();
    };

    notification.onclose = function() {
        console.log("Notifica chiusa");
    };
}

async function checkAndSendReportNotification(photoId, reportCount) {
    if (reportCount === REPORT_THRESHOLD) {
        try {
            // Ottieni i dettagli della foto
            const { data: photo, error } = await supabase
                .from('photos')
                .select('*')
                .eq('id', photoId)
                .single();
                
            if (error) throw error;
            
            const title = "üö® Foto Segnalata 3 Volte!";
            const message = `Una foto ${photo.gender === 'male' ? 'üë¶' : 'üëß'} ha raggiunto 3 segnalazioni ed √® stata sospesa automaticamente.`;
            
            await sendAdminNotification(title, message, photoId, {
                type: "auto_suspended",
                gender: photo.gender,
                reportCount: reportCount
            });
            
            console.log("Notifica di sospensione automatica inviata");
            
        } catch (error) {
            console.error("Errore nell'invio della notifica di segnalazione:", error);
        }
    }
}

// =============================================
// FUNZIONI PRINCIPALI ESISTENTI
// =============================================

function goToStep(step) {
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) stepEl.classList.add('completed');
        else if (index + 1 === step) stepEl.classList.add('active');
    });
    
    document.getElementById(`step${step}-content`).classList.add('active');
    
    if (step === 3) {
        document.getElementById('confirmPreviewImage').src = document.getElementById('previewImage').src;
        document.getElementById('confirm-gender').textContent = selectedGender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza';
    }
}

function selectGender(gender) {
    selectedGender = gender;
    document.querySelectorAll('#step1-content .gender-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (gender === 'male') {
        document.getElementById('maleBtn').classList.add('active');
    } else {
        document.getElementById('femaleBtn').classList.add('active');
    }
    
    document.getElementById('nextToStep2').disabled = false;
    document.getElementById('current-gender').textContent = gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza';
}

function selectVoteGender(gender) {
    currentVoteGender = gender;
    document.querySelectorAll('.gender-selection-vote .gender-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (gender === 'male') {
        document.getElementById('voteMaleBtn').classList.add('active');
    } else {
        document.getElementById('voteFemaleBtn').classList.add('active');
    }
    
    loadPhotosForVoting();
}

async function loadPhotosForVoting() {
    const singlePhotoView = document.getElementById('singlePhotoView');
    singlePhotoView.innerHTML = '<div class="loading">Caricamento foto in corso...</div>';

    try {
        const { data: photos, error } = await supabase
            .from('photos')
            .select('*')
            .eq('gender', currentVoteGender)
            .eq('status', 'active')
            .limit(10);

        if (error) throw error;

        if (!photos || photos.length === 0) {
            singlePhotoView.innerHTML = `
                <div class="empty-state">
                    <p>Nessuna foto disponibile per i ${currentVoteGender === 'male' ? 'ragazzi' : 'ragazze'}.</p>
                </div>
            `;
            return;
        }

        const unvotedPhotos = photos.filter(photo => !voteHistory[photo.id]);
        
        if (unvotedPhotos.length === 0) {
            singlePhotoView.innerHTML = `
                <div class="empty-state">
                    <p>Hai gi√† votato tutte le foto disponibili!</p>
                </div>
            `;
            return;
        }

        currentPhotos = unvotedPhotos;
        currentPhotoIndex = 0;
        showCurrentPhoto();

    } catch (error) {
        console.error('Errore nel caricamento delle foto:', error);
        singlePhotoView.innerHTML = `
            <div class="empty-state">
                <p>Errore nel caricamento delle foto.</p>
            </div>
        `;
    }
}

function showCurrentPhoto() {
    const singlePhotoView = document.getElementById('singlePhotoView');
    
    if (currentPhotoIndex >= currentPhotos.length) {
        singlePhotoView.innerHTML = `
            <div class="empty-state">
                <p>Hai visto tutte le foto disponibili!</p>
                <p>Torna pi√π tardi per nuove foto o cambia genere.</p>
            </div>
        `;
        return;
    }
    
    const photo = currentPhotos[currentPhotoIndex];
    const totalVotes = photo.smash_count + photo.pass_count;
    const smashPercentage = totalVotes > 0 ? (photo.smash_count / totalVotes) * 100 : 0;
    const passPercentage = totalVotes > 0 ? (photo.pass_count / totalVotes) * 100 : 0;
    
    const userVote = voteHistory[photo.id];
    
    singlePhotoView.innerHTML = `
        <div class="photo-container">
            <img src="${photo.image_url}" class="current-photo" alt="Foto da votare" onerror="this.src='https://via.placeholder.com/400x500/2a5298/ffffff?text=Errore+Caricamento'">
        </div>
        
        <div class="progress-container-single">
            <div class="progress-bar-single">
                <div class="progress-fill smash" style="width: ${smashPercentage}%"></div>
                <div class="progress-fill pass" style="width: ${passPercentage}%"></div>
            </div>
            <div class="stats-single">
                <span class="smash-stat">${photo.smash_count} SMASH</span>
                <span class="pass-stat">${photo.pass_count} PASS</span>
            </div>
        </div>
        
        ${userVote ? `
            <div style="text-align: center; margin: 20px 0;">
                <p><strong>Hai gi√† votato: ${userVote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</strong></p>
                <button class="btn btn-secondary" onclick="currentPhotoIndex++; showCurrentPhoto();">
                    Vota Prossima Foto
                </button>
                <button class="report-btn" onclick="openReportModal('${photo.id}')">
                    ‚ö†Ô∏è Segnala
                </button>
            </div>
        ` : `
            <div class="vote-buttons-single">
                <button class="pass-btn-single" onclick="voteCurrentPhoto('pass')">
                    üòê PASS
                </button>
                <button class="smash-btn-single" onclick="voteCurrentPhoto('smash')">
                    üòç SMASH
                </button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="report-btn" onclick="openReportModal('${photo.id}')">
                    ‚ö†Ô∏è Segnala questa foto
                </button>
            </div>
        `}
    `;
}

async function voteCurrentPhoto(vote) {
    if (currentPhotoIndex >= currentPhotos.length) return;
    
    const photo = currentPhotos[currentPhotoIndex];
    const photoContainer = document.querySelector('.photo-container');
    
    if (vote === 'smash') {
        photoContainer.classList.add('smash-effect');
    } else {
        photoContainer.classList.add('pass-effect');
    }
    
    voteHistory[photo.id] = vote;
    localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
    
    // Aggiorna statistiche e achievements
    updateVoteStats(vote, photo.gender);
    updateAchievements();
    
    try {
        const updateField = vote === 'smash' ? 'smash_count' : 'pass_count';
        const { error } = await supabase
            .from('photos')
            .update({ [updateField]: photo[updateField] + 1 })
            .eq('id', photo.id);
        
        if (error) throw error;
        
        showNotification(`Hai votato: ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}`, false, 'info');
        
        setTimeout(() => {
            currentPhotoIndex++;
            showCurrentPhoto();
        }, 800);
        
    } catch (error) {
        console.error('Errore durante il voto:', error);
        showNotification('Errore durante il voto. Riprova.', true);
    }
}

function updateVoteStats(vote, gender) {
    userStats.votes.total++;
    userStats.votes[vote]++;
    userStats.votes[gender]++;
    userStats.views++;
    
    // Gestione streak
    const today = new Date().toDateString();
    if (userStats.votes.lastVoteDate === today) {
        // Gi√† votato oggi, mantieni lo streak
    } else if (userStats.votes.lastVoteDate === new Date(Date.now() - 86400000).toDateString()) {
        // Ha votato ieri, incrementa lo streak
        userStats.votes.currentStreak++;
    } else {
        // Streak rotto
        userStats.votes.currentStreak = 1;
    }
    
    userStats.votes.lastVoteDate = today;
    userStats.votes.maxStreak = Math.max(userStats.votes.maxStreak, userStats.votes.currentStreak);
    
    localStorage.setItem('userStats', JSON.stringify(userStats));
}

function updateUploadStats() {
    userStats.uploads++;
    localStorage.setItem('userStats', JSON.stringify(userStats));
}

function updateReportStats() {
    userStats.reports++;
    localStorage.setItem('userStats', JSON.stringify(userStats));
}

// =============================================
// SISTEMA ACHIEVEMENTS
// =============================================

function updateAchievements() {
    const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
    let updated = false;

    // Achievement basati sui voti
    const voteCount = userStats.votes.total;
    const smashCount = userStats.votes.smash;
    const passCount = userStats.votes.pass;
    const maleVotes = userStats.votes.male;
    const femaleVotes = userStats.votes.female;

    // üî¥ VOTI BASE
    if (voteCount >= 1 && !achievements.first_vote?.unlocked) {
        achievements.first_vote = { name: 'Primo Voto', description: 'Effettua il tuo primo voto', unlocked: true, icon: 'üéØ' };
        updated = true; showNotification('üéØ Achievement sbloccato: Primo Voto!');
    }
    if (voteCount >= 5 && !achievements.five_votes?.unlocked) {
        achievements.five_votes = { name: 'Votante Attivo', description: 'Effettua 5 voti', unlocked: true, icon: 'üèÜ' };
        updated = true; showNotification('üèÜ Achievement sbloccato: Votante Attivo!');
    }
    if (voteCount >= 10 && !achievements.ten_votes?.unlocked) {
        achievements.ten_votes = { name: 'Esperto di Bellezza', description: 'Effettua 10 voti', unlocked: true, icon: 'üëë' };
        updated = true; showNotification('üëë Achievement sbloccato: Esperto di Bellezza!');
    }
    if (voteCount >= 25 && !achievements.twenty_five_votes?.unlocked) {
        achievements.twenty_five_votes = { name: 'Giudice Instancabile', description: 'Effettua 25 voti', unlocked: true, icon: '‚ö°' };
        updated = true; showNotification('‚ö° Achievement sbloccato: Giudice Instancabile!');
    }
    if (voteCount >= 50 && !achievements.fifty_votes?.unlocked) {
        achievements.fifty_votes = { name: 'Maestro del Voto', description: 'Effettua 50 voti', unlocked: true, icon: 'üéñÔ∏è' };
        updated = true; showNotification('üéñÔ∏è Achievement sbloccato: Maestro del Voto!');
    }

    // üî¥ SMASH SPECIALIST
    if (smashCount >= 10 && !achievements.ten_smash?.unlocked) {
        achievements.ten_smash = { name: 'Cuore Caldo', description: 'Dai 10 Smash', unlocked: true, icon: 'üòç' };
        updated = true; showNotification('üòç Achievement sbloccato: Cuore Caldo!');
    }
    if (smashCount >= 25 && !achievements.twenty_five_smash?.unlocked) {
        achievements.twenty_five_smash = { name: 'Romantico Incallito', description: 'Dai 25 Smash', unlocked: true, icon: 'üíñ' };
        updated = true; showNotification('üíñ Achievement sbloccato: Romantico Incallito!');
    }

    // üî¥ PASS SPECIALIST
    if (passCount >= 10 && !achievements.ten_pass?.unlocked) {
        achievements.ten_pass = { name: 'Severo ma Giusto', description: 'Dai 10 Pass', unlocked: true, icon: 'üòê' };
        updated = true; showNotification('üòê Achievement sbloccato: Severo ma Giusto!');
    }
    if (passCount >= 25 && !achievements.twenty_five_pass?.unlocked) {
        achievements.twenty_five_pass = { name: 'Critico Esperto', description: 'Dai 25 Pass', unlocked: true, icon: 'üéØ' };
        updated = true; showNotification('üéØ Achievement sbloccato: Critico Esperto!');
    }

    // üî¥ EQUILIBRIO
    if (smashCount >= 10 && passCount >= 10 && !achievements.balanced_voter?.unlocked) {
        achievements.balanced_voter = { name: 'Equilibrato', description: '10 Smash e 10 Pass', unlocked: true, icon: '‚öñÔ∏è' };
        updated = true; showNotification('‚öñÔ∏è Achievement sbloccato: Equilibrato!');
    }

    // üî¥ PREFERENZE DI GENERE
    if (maleVotes >= 10 && !achievements.male_lover?.unlocked) {
        achievements.male_lover = { name: 'Amante dei Ragazzi', description: 'Vota 10 foto di ragazzi', unlocked: true, icon: 'üë¶' };
        updated = true; showNotification('üë¶ Achievement sbloccato: Amante dei Ragazzi!');
    }
    if (femaleVotes >= 10 && !achievements.female_lover?.unlocked) {
        achievements.female_lover = { name: 'Amante delle Ragazze', description: 'Vota 10 foto di ragazze', unlocked: true, icon: 'üëß' };
        updated = true; showNotification('üëß Achievement sbloccato: Amante delle Ragazze!');
    }

    // üî¥ STREAK E FREQUENZA
    if (userStats.votes.currentStreak >= 3 && !achievements.three_day_streak?.unlocked) {
        achievements.three_day_streak = { name: 'Abitudinario', description: 'Vota per 3 giorni consecutivi', unlocked: true, icon: 'üî•' };
        updated = true; showNotification('üî• Achievement sbloccato: Abitudinario!');
    }
    if (userStats.votes.currentStreak >= 7 && !achievements.week_streak?.unlocked) {
        achievements.week_streak = { name: 'Fedele', description: 'Vota per 7 giorni consecutivi', unlocked: true, icon: 'üí´' };
        updated = true; showNotification('üí´ Achievement sbloccato: Fedele!');
    }

    // üî¥ UPLOAD ACHIEVEMENTS
    if (userStats.uploads >= 1 && !achievements.first_upload?.unlocked) {
        achievements.first_upload = { name: 'Modello Emergente', description: 'Carica la tua prima foto', unlocked: true, icon: 'üì∏' };
        updated = true; showNotification('üì∏ Achievement sbloccato: Modello Emergente!');
    }
    if (userStats.uploads >= 3 && !achievements.three_uploads?.unlocked) {
        achievements.three_uploads = { name: 'Fotografo Amatoriale', description: 'Carica 3 foto', unlocked: true, icon: 'üåü' };
        updated = true; showNotification('üåü Achievement sbloccato: Fotografo Amatoriale!');
    }
    if (userStats.uploads >= 10 && !achievements.ten_uploads?.unlocked) {
        achievements.ten_uploads = { name: 'Content Creator', description: 'Carica 10 foto', unlocked: true, icon: 'üé≠' };
        updated = true; showNotification('üé≠ Achievement sbloccato: Content Creator!');
    }

    // üî¥ SPECIALI
    if (userStats.reports >= 5 && !achievements.vigilant?.unlocked) {
        achievements.vigilant = { name: 'Vigilante', description: 'Segnala 5 foto', unlocked: true, icon: 'üõ°Ô∏è' };
        updated = true; showNotification('üõ°Ô∏è Achievement sbloccato: Vigilante!');
    }

    if (updated) {
        // Conta gli achievements sbloccati
        const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
        userStats.achievementsUnlocked = unlockedCount;
        localStorage.setItem('userStats', JSON.stringify(userStats));
        
        // Achievement per numero di achievements sbloccati
        if (unlockedCount >= 5 && !achievements.achievement_hunter?.unlocked) {
            achievements.achievement_hunter = { name: 'Cacciatore di Achievement', description: 'Sblocca 5 achievements', unlocked: true, icon: 'üéñÔ∏è' };
            showNotification('üéñÔ∏è Achievement sbloccato: Cacciatore di Achievement!');
        }
        if (unlockedCount >= 10 && !achievements.achievement_master?.unlocked) {
            achievements.achievement_master = { name: 'Maestro degli Achievement', description: 'Sblocca 10 achievements', unlocked: true, icon: 'üèÖ' };
            showNotification('üèÖ Achievement sbloccato: Maestro degli Achievement!');
        }
        
        localStorage.setItem('achievements', JSON.stringify(achievements));
    }
    
    return achievements;
}

function loadAchievements() {
    const defaultAchievements = {
        // Voti Base
        first_vote: { name: 'Primo Voto', description: 'Effettua il tuo primo voto', unlocked: false, icon: 'üéØ' },
        five_votes: { name: 'Votante Attivo', description: 'Effettua 5 voti', unlocked: false, icon: 'üèÜ' },
        ten_votes: { name: 'Esperto di Bellezza', description: 'Effettua 10 voti', unlocked: false, icon: 'üëë' },
        twenty_five_votes: { name: 'Giudice Instancabile', description: 'Effettua 25 voti', unlocked: false, icon: '‚ö°' },
        fifty_votes: { name: 'Maestro del Voto', description: 'Effettua 50 voti', unlocked: false, icon: 'üéñÔ∏è' },

        // Smash Specialist
        ten_smash: { name: 'Cuore Caldo', description: 'Dai 10 Smash', unlocked: false, icon: 'üòç' },
        twenty_five_smash: { name: 'Romantico Incallito', description: 'Dai 25 Smash', unlocked: false, icon: 'üíñ' },

        // Pass Specialist
        ten_pass: { name: 'Severo ma Giusto', description: 'Dai 10 Pass', unlocked: false, icon: 'üòê' },
        twenty_five_pass: { name: 'Critico Esperto', description: 'Dai 25 Pass', unlocked: false, icon: 'üéØ' },

        // Equilibrio
        balanced_voter: { name: 'Equilibrato', description: '10 Smash e 10 Pass', unlocked: false, icon: '‚öñÔ∏è' },

        // Preferenze di Genere
        male_lover: { name: 'Amante dei Ragazzi', description: 'Vota 10 foto di ragazzi', unlocked: false, icon: 'üë¶' },
        female_lover: { name: 'Amante delle Ragazze', description: 'Vota 10 foto di ragazze', unlocked: false, icon: 'üëß' },

        // Streak e Frequenza
        three_day_streak: { name: 'Abitudinario', description: 'Vota per 3 giorni consecutivi', unlocked: false, icon: 'üî•' },
        week_streak: { name: 'Fedele', description: 'Vota per 7 giorni consecutivi', unlocked: false, icon: 'üí´' },

        // Upload
        first_upload: { name: 'Modello Emergente', description: 'Carica la tua prima foto', unlocked: false, icon: 'üì∏' },
        three_uploads: { name: 'Fotografo Amatoriale', description: 'Carica 3 foto', unlocked: false, icon: 'üåü' },
        ten_uploads: { name: 'Content Creator', description: 'Carica 10 foto', unlocked: false, icon: 'üé≠' },

        // Speciali
        vigilant: { name: 'Vigilante', description: 'Segnala 5 foto', unlocked: false, icon: 'üõ°Ô∏è' },

        // Achievement Hunter
        achievement_hunter: { name: 'Cacciatore di Achievement', description: 'Sblocca 5 achievements', unlocked: false, icon: 'üéñÔ∏è' },
        achievement_master: { name: 'Maestro degli Achievement', description: 'Sblocca 10 achievements', unlocked: false, icon: 'üèÖ' }
    };

    let currentAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
    achievements = { ...defaultAchievements, ...currentAchievements };
    localStorage.setItem('achievements', JSON.stringify(achievements));
    
    return achievements;
}

function loadAchievementsDisplay() {
    const achievementsList = document.getElementById('achievementsList');
    
    // Aggiorna gli achievements prima di mostrarli
    updateAchievements();
    
    const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
    const userStats = JSON.parse(localStorage.getItem('userStats') || '{}');
    
    if (Object.keys(achievements).length === 0) {
        achievementsList.innerHTML = `
            <div class="empty-state">
                <p>Non hai ancora sbloccato nessun achievement.</p>
                <p>Vota alcune foto o carica la tua prima foto per sbloccarli!</p>
            </div>
        `;
        return;
    }

    // Calcola statistiche
    const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
    const totalCount = Object.keys(achievements).length;
    const progress = Math.round((unlockedCount / totalCount) * 100);

    achievementsList.innerHTML = `
        <div class="achievement-progress">
            <h3>Progresso Achievements</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                <span>${unlockedCount}/${totalCount} Sbloccati</span>
                <span>${progress}%</span>
            </div>
            <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; overflow: hidden;">
                <div style="background: #FFD700; height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
            </div>
        </div>
        
        <div class="achievements-grid">
            ${Object.entries(achievements).map(([key, achievement]) => `
                <div class="achievement-item ${achievement.unlocked ? '' : 'achievement-locked'}" 
                     style="padding: 15px; border-radius: 10px; background: ${achievement.unlocked ? '#f8fff8' : '#f5f5f5'}; border: 2px solid ${achievement.unlocked ? '#4CAF50' : '#ddd'};">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2em; filter: ${achievement.unlocked ? 'none' : 'grayscale(100%)'};">${achievement.icon}</div>
                        <div style="flex-grow: 1;">
                            <h4 style="margin: 0 0 5px 0; color: ${achievement.unlocked ? '#333' : '#999'};">${achievement.name}</h4>
                            <p style="margin: 0; font-size: 0.9em; color: ${achievement.unlocked ? '#666' : '#999'};">${achievement.description}</p>
                            <small style="color: ${achievement.unlocked ? '#4CAF50' : '#999'};">${achievement.unlocked ? '‚úÖ Sbloccato' : 'üîí Bloccato'}</small>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}
// =============================================
// FUNZIONI CRONOLOGIA VOTI
// =============================================

async function loadVoteHistory() { 
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '<div class="loading">Caricamento cronologia...</div>';

    try {
        const historyEntries = Object.entries(voteHistory);
        
        if (historyEntries.length === 0) {
            historyList.innerHTML = '<div class="empty-state"><p>Non hai ancora votato nessuna foto.</p></div>';
            return;
        }

        const photoIds = historyEntries.map(([photoId]) => photoId);
        const { data: photos, error } = await supabase
            .from('photos')
            .select('*')
            .in('id', photoIds);

        if (error) throw error;

        // üîÑ FILTRA E RIMUOVI LE FOTO CHE NON ESISTONO PI√ô
        const photosMap = {};
        const existingPhotoIds = new Set();
        
        if (photos) {
            photos.forEach(photo => {
                photosMap[photo.id] = photo;
                existingPhotoIds.add(photo.id);
            });
        }

        // Rimuovi dalla cronologia locale le foto che non esistono pi√π
        let updatedVoteHistory = { ...voteHistory };
        let removedCount = 0;
        
        Object.keys(voteHistory).forEach(photoId => {
            if (!existingPhotoIds.has(photoId)) {
                delete updatedVoteHistory[photoId];
                removedCount++;
            }
        });

        // Aggiorna il localStorage se sono state rimosse delle foto
        if (removedCount > 0) {
            voteHistory = updatedVoteHistory;
            localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
            console.log(`Rimosse ${removedCount} foto non pi√π esistenti dalla cronologia`);
        }

        // Aggiorna historyEntries con i dati filtrati
        const filteredHistoryEntries = Object.entries(voteHistory);

        const finalFilteredEntries = filteredHistoryEntries.filter(([photoId, vote]) => {
            if (currentHistoryFilter === 'all') return true;
            return vote === currentHistoryFilter;
        });

        if (finalFilteredEntries.length === 0) {
            historyList.innerHTML = '<div class="empty-state"><p>Nessun voto corrisponde al filtro selezionato.</p></div>';
            return;
        }

        historyList.innerHTML = finalFilteredEntries.map(([photoId, vote]) => {
            const photo = photosMap[photoId];
            
            // Questa condizione non dovrebbe mai verificarsi ora, ma la lasciamo per sicurezza
            if (!photo) {
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <p><strong>Foto ID:</strong> ${photoId.substring(0, 8)}...</p>
                            <p><strong>Voto:</strong> ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</p>
                            <p><em>Foto rimossa - aggiorna la pagina</em></p>
                        </div>
                        <div class="history-vote ${vote}">
                            ${vote === 'smash' ? 'SMASH' : 'PASS'}
                        </div>
                    </div>
                `;
            }

            const oppositeVote = vote === 'smash' ? 'pass' : 'smash';
            const oppositeText = vote === 'smash' ? 'PASS' : 'SMASH';
            const oppositeEmoji = vote === 'smash' ? 'üòê' : 'üòç';

            return `
                <div class="history-item">
                    <img src="${photo.image_url}" class="history-photo" alt="Foto votata" onerror="this.style.display='none'">
                    <div class="history-info">
                        <p><strong>Genere:</strong> ${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</p>
                        <p><strong>Statistiche:</strong> ${photo.smash_count} üòç | ${photo.pass_count} üòê</p>
                        <p><strong>Il tuo voto:</strong> ${vote === 'smash' ? 'üòç SMASH' : 'üòê PASS'}</p>
                    </div>
                    <div class="history-vote ${vote}">
                        ${vote === 'smash' ? 'SMASH' : 'PASS'}
                    </div>
                    <button class="change-vote-btn" onclick="changeVote('${photo.id}', '${oppositeVote}')">
                        Cambia in ${oppositeEmoji} ${oppositeText}
                    </button>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Errore nel caricamento della cronologia:', error);
        historyList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento della cronologia.</p></div>';
    }
}

function filterHistory(filter) {
    currentHistoryFilter = filter;
    document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    loadVoteHistory();
}

// =============================================
// FUNZIONI CLASSIFICA
// =============================================

async function loadLeaderboard() {
    const leaderboardList = document.getElementById('leaderboardList');
    leaderboardList.innerHTML = '<div class="loading">Caricamento classifica...</div>';
    
    try {
        let query = supabase
            .from('photos')
            .select('*')
            .eq('status', 'active')
            .order('smash_count', { ascending: false })
            .limit(20);
        
        if (currentLeaderboardFilter !== 'all') {
            query = query.eq('gender', currentLeaderboardFilter);
        }
        
        const { data: photos, error } = await query;
        
        if (error) throw error;
        
        if (!photos || photos.length === 0) {
            leaderboardList.innerHTML = '<div class="empty-state"><p>Nessuna foto in classifica.</p></div>';
            return;
        }
        
        leaderboardList.innerHTML = photos.map((photo, index) => {
            return `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">${index + 1}</div>
                    <img src="${photo.image_url}" class="leaderboard-photo" alt="Foto" onerror="this.style.display='none'">
                    <div class="leaderboard-info">
                        <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</h4>
                    </div>
                    <div class="leaderboard-score">
                        ${photo.smash_count} üòç
                    </div>
                    <button class="report-btn" onclick="openReportModal('${photo.id}')">
                        ‚ö†Ô∏è
                    </button>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Errore nel caricamento della classifica:', error);
        leaderboardList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento della classifica.</p></div>';
    }
}

function filterLeaderboard(filter) {
    currentLeaderboardFilter = filter;
    document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    loadLeaderboard();
}

// =============================================
// FUNZIONI STATISTICHE
// =============================================

async function loadStats() {
    try {
        const { data: photos, error: photosError } = await supabase
            .from('photos')
            .select('id', { count: 'exact' });
        
        const { data: allPhotos, error: votesError } = await supabase
            .from('photos')
            .select('smash_count, pass_count');
        
        if (photosError || votesError) throw new Error('Errore nel caricamento delle statistiche');
        
        let totalVotes = 0;
        if (allPhotos) {
            allPhotos.forEach(photo => {
                totalVotes += photo.smash_count + photo.pass_count;
            });
        }
        
        document.getElementById('totalPhotos').textContent = photos ? photos.length : 0;
        document.getElementById('totalVotes').textContent = totalVotes;
        
    } catch (error) {
        console.error('Errore nel caricamento delle statistiche:', error);
    }
}

// =============================================
// FUNZIONI SEGNALAZIONE E MODERAZIONE
// =============================================

function openReportModal(photoId) {
    currentPhotoForReport = photoId;
    document.getElementById('reportModal').style.display = 'flex';
}

async function submitReport() {
    if (!currentPhotoForReport) return;

    const reason = document.getElementById('reportReason').value;
    const details = document.getElementById('reportDetails').value;
    
    try {
        console.log('Iniziando segnalazione per foto:', currentPhotoForReport);
        
        // PRIMA: Inserisci il report
        const reportData = {
            photo_id: currentPhotoForReport,
            reason: reason,
            details: details || null,
            reported_at: new Date().toISOString()
        };
        
        console.log('Inserendo report:', reportData);
        
        const { data: reportResult, error: reportError } = await supabase
            .from('reports')
            .insert([reportData]);
        
        if (reportError) {
            console.error('Errore nell\'inserimento del report:', reportError);
        }
        
        // SECONDO: Aggiorna il conteggio delle segnalazioni e verifica la sospensione automatica
        try {
            // Prima ottieni il conteggio attuale
            const { data: currentPhoto, error: fetchError } = await supabase
                .from('photos')
                .select('report_count, status')
                .eq('id', currentPhotoForReport)
                .single();
            
            if (fetchError) {
                console.warn('Impossibile ottenere dati foto:', fetchError);
            } else {
                const newReportCount = (currentPhoto.report_count || 0) + 1;
                
                // Aggiorna report_count
                const { error: updateError } = await supabase
                    .from('photos')
                    .update({ 
                        report_count: newReportCount
                    })
                    .eq('id', currentPhotoForReport);
                
                if (updateError) {
                    console.error('Errore aggiornamento conteggio:', updateError);
                } else {
                    console.log('Conteggio aggiornato a:', newReportCount);
                    
                    // Sospensione automatica quando raggiunge 3 segnalazioni diverse
                    if (newReportCount >= REPORT_THRESHOLD && currentPhoto.status === 'active') {
                        await suspendPhoto(currentPhotoForReport);
                    }
                }
            }
        } catch (updateError) {
            console.error('Errore nell\'aggiornamento:', updateError);
        }
        
        // Aggiorna statistiche e achievements
        updateReportStats();
        updateAchievements();
        
        showNotification('Segnalazione inviata con successo!', false, 'success');
        closeModal('reportModal');
        
    } catch (error) {
        console.error('Errore durante la segnalazione:', error);
        showNotification('Errore durante la segnalazione. Riprova.', true);
    }
}

async function suspendPhoto(photoId) {
    try {
        console.log(`Sospendendo automaticamente la foto ${photoId} per troppe segnalazioni`);
        
        const { error } = await supabase
            .from('photos')
            .update({ 
                status: 'suspended',
                suspended_at: new Date().toISOString()
            })
            .eq('id', photoId);
        
        if (error) {
            console.error('Errore sospensione automatica:', error);
            // Prova senza updated_at se fallisce
            await supabase
                .from('photos')
                .update({ status: 'suspended' })
                .eq('id', photoId);
        }
        
        // üî• INVIA LA NOTIFICA PUSH AGLI ADMIN
        await checkAndSendReportNotification(photoId, 3);
        
        showNotification('Foto sospesa automaticamente per troppe segnalazioni!', false, 'warning');
        
        // Ricarica le foto segnalate se siamo nella tab moderazione
        if (document.getElementById('moderation-tab').classList.contains('active')) {
            loadReportedPhotos();
        }
        
    } catch (error) {
        console.error('Errore durante la sospensione automatica:', error);
    }
}

// =============================================
// FUNZIONI CAMBIO VOTO
// =============================================

async function changeVote(photoId, newVote) {
    try {
        // Recupera i dati attuali della foto
        const { data: photo, error: fetchError } = await supabase
            .from('photos')
            .select('smash_count, pass_count')
            .eq('id', photoId)
            .single();
        
        if (fetchError) throw new Error('Foto non trovata');
        
        const oldVote = voteHistory[photoId];
        
        // Aggiorna i conteggi nel database
        let updateData = {};
        
        if (oldVote === 'smash' && newVote === 'pass') {
            // Da Smash a Pass: decrementa smash, incrementa pass
            updateData = {
                smash_count: photo.smash_count - 1,
                pass_count: photo.pass_count + 1
            };
        } else if (oldVote === 'pass' && newVote === 'smash') {
            // Da Pass a Smash: decrementa pass, incrementa smash
            updateData = {
                smash_count: photo.smash_count + 1,
                pass_count: photo.pass_count - 1
            };
        }
        
        const { error: updateError } = await supabase
            .from('photos')
            .update(updateData)
            .eq('id', photoId);
        
        if (updateError) throw new Error('Errore nell\'aggiornamento del voto');
        
        // Aggiorna la cronologia locale
        voteHistory[photoId] = newVote;
        localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
        
        showNotification(`Voto cambiato in ${newVote === 'smash' ? 'SMASH' : 'PASS'}!`, false, 'success');
        
        // Ricarica la cronologia
        loadVoteHistory();
        
    } catch (error) {
        console.error('Errore durante il cambio di voto:', error);
        showNotification('Errore durante il cambio di voto. Riprova.', true);
    }
}

// =============================================
// FUNZIONI MODERAZIONE AVANZATA
// =============================================

async function loadReportedPhotos() {
    if (!isModerationAuthenticated) return;
    
    const reportedPhotosList = document.getElementById('reportedPhotosList');
    reportedPhotosList.innerHTML = '<div class="loading">Caricamento foto segnalate...</div>';
    
    try {
        // Carica le foto segnalate
        const { data: photos, error } = await supabase
            .from('photos')
            .select('*')
            .gt('report_count', 0)
            .order('report_count', { ascending: false });
        
        if (error) throw error;
        
        if (!photos || photos.length === 0) {
            reportedPhotosList.innerHTML = '<div class="empty-state"><p>Nessuna foto segnalata</p></div>';
            return;
        }

        // Per ogni foto, carica i report dettagliati
        const photosWithReports = await Promise.all(
            photos.map(async (photo) => {
                const { data: reports, error: reportsError } = await supabase
                    .from('reports')
                    .select('*')
                    .eq('photo_id', photo.id)
                    .order('reported_at', { ascending: false });
                
                return {
                    ...photo,
                    reports: reports || []
                };
            })
        );
        
        reportedPhotosList.innerHTML = photosWithReports.map(photo => {
            return `
                <div class="reported-photo">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <img src="${photo.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; margin-right: 15px;" onerror="this.style.display='none'">
                        <div style="flex-grow: 1;">
                            <h4>${photo.gender === 'male' ? 'üë¶ Ragazzo' : 'üëß Ragazza'}</h4>
                            <p><strong>Segnalazioni:</strong> ${photo.report_count || 0}</p>
                            <p><strong>Smash:</strong> ${photo.smash_count} | <strong>Pass:</strong> ${photo.pass_count}</p>
                            <p><strong>Stato:</strong> ${photo.status || 'active'}</p>
                        </div>
                    </div>
                    
                    <!-- MOSTRA I DETTAGLI DELLE SEGNALAZIONI -->
                    ${photo.reports.length > 0 ? `
                        <div class="report-details">
                            <h4>Dettagli Segnalazioni (${photo.reports.length}):</h4>
                            ${photo.reports.map((report, index) => `
                                <div class="report-item">
                                    <p><strong>Segnalazione #${index + 1}:</strong></p>
                                    <p><strong>Motivo:</strong> ${report.reason}</p>
                                    <p><strong>Dettagli:</strong> ${report.details || 'Nessun dettaglio aggiuntivo'}</p>
                                    <p><strong>Data:</strong> ${new Date(report.reported_at).toLocaleString('it-IT')}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>Nessun dettaglio disponibile per le segnalazioni</p>'}
                    
                    <div class="admin-actions">
                        <button class="admin-btn approve-btn" onclick="approvePhoto('${photo.id}')">‚úÖ Approva</button>
                        <button class="admin-btn reject-btn" onclick="rejectPhoto('${photo.id}')">‚ùå Rimuovi</button>
                        <button class="btn btn-secondary" onclick="openAdvancedModeration('${photo.id}')">üõ°Ô∏è Moderazione Avanzata</button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Errore nel caricamento delle foto segnalate:', error);
        reportedPhotosList.innerHTML = '<div class="empty-state"><p>Errore nel caricamento</p></div>';
    }
}

async function approvePhoto(photoId) {
    try {
        const { error } = await supabase
            .from('photos')
            .update({ report_count: 0, status: 'active' })
            .eq('id', photoId);
        
        if (error) throw error;
        
        showNotification('Foto approvata con successo!');
        loadReportedPhotos();
        
    } catch (error) {
        console.error('Errore durante l\'approvazione:', error);
        showNotification('Errore durante l\'approvazione. Riprova.', true);
    }
}

async function rejectPhoto(photoId) {
    if (!confirm('Sei sicuro di voler eliminare questa foto?')) return;
    
    try {
        const { data: photo, error: fetchError } = await supabase
            .from('photos')
            .select('image_url')
            .eq('id', photoId)
            .single();
        
        if (fetchError) throw fetchError;
        
        const imagePath = photo.image_url.split('/').pop();
        
        if (imagePath && imagePath !== 'undefined') {
            await supabase.storage.from('photo-uploads').remove([imagePath]);
        }
        
        await supabase.from('reports').delete().eq('photo_id', photoId);
        await supabase.from('photos').delete().eq('id', photoId);
        
        showNotification('Foto eliminata definitivamente!');
        loadReportedPhotos();
        
    } catch (error) {
        console.error('Errore durante l\'eliminazione:', error);
        showNotification('Errore durante l\'eliminazione. Riprova.', true);
    }
}

// =============================================
// FUNZIONI SISTEMA REPUTAZIONE
// =============================================

async function logModerationAction(logData) {
    try {
        const { error } = await supabase
            .from('moderation_logs')
            .insert([{
                ...logData,
                created_at: new Date().toISOString()
            }]);
            
        if (error) throw error;
    } catch (error) {
        console.error('Errore nel logging moderazione:', error);
    }
}

// =============================================
// FUNZIONI INTERFACCIA ADMIN
// =============================================

function handleAdminLogin() {
    const tokenInput = document.getElementById('adminTokenInput');
    const token = tokenInput.value.trim();
    
    if (!token) {
        showNotification('Inserisci un token admin!', true);
        return;
    }
    
    const success = grantAdminAccess(token);
    if (success) {
        tokenInput.value = '';
    }
}

function testNotification() {
    const title = "üîî Test Notifica";
    const message = "Questa √® una notifica di test da Smash or Pass!";
    
    sendAdminNotification(title, message, 'test', { type: "test" })
        .then(() => {
            showNotification('Notifica di test inviata!', false, 'success');
        })
        .catch(error => {
            showNotification('Errore nell\'invio della notifica di test', true);
        });
}

function updateAdminUI() {
    const adminSection = document.getElementById('adminSection');
    const adminControls = document.getElementById('adminControls');
    
    if (isUserAdmin()) {
        adminSection.style.display = 'block';
        adminControls.style.display = 'block';
    } else {
        adminSection.style.display = 'block';
        adminControls.style.display = 'none';
    }
}

// =============================================
// FUNZIONI PERMESSI NOTIFICHE
// =============================================

function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Permesso notifiche browser concesso");
                showNotification('Permesso notifiche concesso!', false, 'success');
            }
        });
    }
}

// =============================================
// FUNZIONI NAVIGAZIONE MODERAZIONE
// =============================================

function switchToModerationTab(photoId = null) {
    if (!isModerationAuthenticated) {
        showPasswordModal();
    } else {
        switchTab('moderation');
        // Se √® specificata una foto, evidenziala dopo il caricamento
        if (photoId) {
            setTimeout(() => {
                highlightReportedPhoto(photoId);
            }, 1500);
        }
    }
}
        function showPasswordModal() {
    moderationAttempts = 3;
    document.getElementById('attemptsInfo').textContent = `Tentativi rimanenti: ${moderationAttempts}`;
    document.getElementById('moderationPasswordInput').value = '';
    document.getElementById('passwordModal').style.display = 'flex';
}

function handlePasswordSubmit() {
    const password = document.getElementById('moderationPasswordInput').value;
    // Add your password validation logic here
    if (password === 'your_moderation_password') { // Change this password
        isModerationAuthenticated = true;
        closeModal('passwordModal');
        loadReportedPhotos();
        showNotification('Accesso moderazione autorizzato!', false, 'success');
    } else {
        moderationAttempts--;
        document.getElementById('attemptsInfo').textContent = `Tentativi rimanenti: ${moderationAttempts}`;
        if (moderationAttempts <= 0) {
            closeModal('passwordModal');
            showNotification('Accesso negato! Tentativi esauriti.', true);
        } else {
            showNotification('Password errata! Riprova.', true);
        }
    }
}

function logoutModeration() {
    isModerationAuthenticated = false;
    showNotification('Disconnesso dalla moderazione.', false, 'info');
    switchTab('upload');
}

function highlightReportedPhoto(photoId) {
    const reportedPhotos = document.querySelectorAll('.reported-photo');
    let targetPhoto = null;
    
    reportedPhotos.forEach(photo => {
        const photoElement = photo.querySelector(`[onclick*="${photoId}"]`);
        if (photoElement) {
            targetPhoto = photo;
        }
    });
    
    if (targetPhoto) {
        targetPhoto.scrollIntoView({ behavior: 'smooth', block: 'center' });
        targetPhoto.style.animation = "highlightFlash 2s ease-in-out 3";
        
        // Rimuovi l'animazione dopo che √® finita
        setTimeout(() => {
            targetPhoto.style.animation = "";
        }, 6000);
    }
}

// =============================================
// EVENT LISTENERS
// =============================================

function initEventListeners() {
    document.getElementById('maleBtn').addEventListener('click', function() {
        selectGender('male');
    });
    
    document.getElementById('femaleBtn').addEventListener('click', function() {
        selectGender('female');
    });
    
    document.getElementById('voteMaleBtn').addEventListener('click', function() {
        selectVoteGender('male');
    });
    
    document.getElementById('voteFemaleBtn').addEventListener('click', function() {
        selectVoteGender('female');
    });
    
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (e.target.files.length) {
            handleFileSelection(e.target.files[0]);
        }
    });
    
    document.getElementById('importFile').addEventListener('change', function(e) {
        if (e.target.files.length) {
            importData(e.target.files[0]);
        }
    });
    
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '#f0f4ff';
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.backgroundColor = '';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length) {
            handleFileSelection(e.dataTransfer.files[0]);
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (document.getElementById('vote-tab').classList.contains('active')) {
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    voteCurrentPhoto('pass');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    voteCurrentPhoto('smash');
                    break;
                case ' ':
                    e.preventDefault();
                    currentPhotoIndex++;
                    showCurrentPhoto();
                    break;
            }
        }
    });
}
        function handleFileSelection(file) {
    if (!file) return;
    
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    
    if (!allowedTypes.includes(file.type)) {
        showNotification('Tipo di file non supportato! Usa solo JPEG, PNG o WebP.', true);
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('L\'immagine √® troppo grande! Massimo 5MB.', true);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById('previewImage');
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        document.getElementById('nextToStep3').disabled = false;
        
        selectedFile = file;
    };
    reader.readAsDataURL(file);
}

// =============================================
// FUNZIONI NAVIGAZIONE
// =============================================

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function switchTab(tabName) {
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    if (tabName === 'moderation') {
        if (!isModerationAuthenticated) {
            if (moderationAttempts > 0) {
            showPasswordModal();
                return;
            } else {
                showNotification('Hai esaurito i tentativi di accesso!', true);
                return;
            }
        }
    }
    
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-tab') === tabName) {
            link.classList.add('active');
        }
    });
    
    if (tabName === 'vote') {
        loadPhotosForVoting();
    } else if (tabName === 'history') {
        loadVoteHistory();
    } else if (tabName === 'leaderboard') {
        loadLeaderboard();
    } else if (tabName === 'battle') {
        // Il sistema battaglia √® gi√† inizializzato
    } else if (tabName === 'achievements') {
        loadAchievementsDisplay();
    } else if (tabName === 'moderation' && isModerationAuthenticated) {
        loadReportedPhotos();
    } else if (tabName === 'settings') {
        loadStats();
        updateAdminUI();
    }
}

// =============================================
// FUNZIONI ESPORTA/IMPORTA
// =============================================

function exportData() {
    const data = {
        voteHistory: voteHistory,
        achievements: achievements,
        userStats: userStats,
        userBattleStats: userBattleStats,
        userUploadedPhotos: userUploadedPhotos,
        userBattlePhotos: userBattlePhotos,
        userReputation: userReputation,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `smash-or-pass-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showNotification('Dati esportati con successo!');
}

function importData(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.voteHistory) {
                voteHistory = { ...voteHistory, ...data.voteHistory };
                localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
            }
            
            if (data.achievements) {
                achievements = { ...achievements, ...data.achievements };
                localStorage.setItem('achievements', JSON.stringify(achievements));
            }
            
            if (data.userStats) {
                userStats = { ...userStats, ...data.userStats };
                localStorage.setItem('userStats', JSON.stringify(userStats));
            }
            
            if (data.userBattleStats) {
                userBattleStats = { ...userBattleStats, ...data.userBattleStats };
                localStorage.setItem('userBattleStats', JSON.stringify(userBattleStats));
            }
            
            if (data.userUploadedPhotos) {
                userUploadedPhotos = [...new Set([...userUploadedPhotos, ...data.userUploadedPhotos])];
                localStorage.setItem('userUploadedPhotos', JSON.stringify(userUploadedPhotos));
            }
            
            if (data.userBattlePhotos) {
                userBattlePhotos = [...new Set([...userBattlePhotos, ...data.userBattlePhotos])];
                localStorage.setItem('userBattlePhotos', JSON.stringify(userBattlePhotos));
            }
            
            if (data.userReputation) {
                userReputation = { ...userReputation, ...data.userReputation };
                localStorage.setItem('userReputation', JSON.stringify(userReputation));
            }
            
            showNotification('Dati importati con successo!');
            
            if (document.getElementById('history-tab').classList.contains('active')) {
                loadVoteHistory();
            }
            if (document.getElementById('achievements-tab').classList.contains('active')) {
                loadAchievementsDisplay();
            }
            
        } catch (error) {
            console.error('Errore nell\'importazione:', error);
            showNotification('Errore nell\'importazione. File non valido.', true);
        }
    };
    reader.readAsText(file);
}

// =============================================
// FUNZIONI MODAL
// =============================================

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'reportModal') {
        document.getElementById('reportReason').value = 'inappropriate';
        document.getElementById('reportDetails').value = '';
    }
}

function showNotification(message, isError = false, type = '') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification';
    
    if (isError) {
        notification.classList.add('error');
    } else if (type === 'info') {
        notification.classList.add('info');
    } else if (type === 'warning') {
        notification.classList.add('warning');
    } else if (type === 'success') {
        notification.classList.add('success');
    }
    
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// =============================================
// INIZIALIZZAZIONE FINALE
// =============================================

// Inizializza l'applicazione
document.addEventListener('DOMContentLoaded', function() {
    initUserStats();
    initUserReputation();
    initEventListeners();
    loadPhotosForVoting();
    loadAchievements();
    loadStats();

    
    if (!hasAcceptedTerms) {
        setTimeout(() => {
            showTermsModal();
        }, 1000);
    }
    
    initializeOneSignal();
    updateAdminUI();
    requestNotificationPermission();
    initBattleSystem();
    
    document.getElementById('darkModeToggle').addEventListener('change', function() {
        updateDarkMode(this.checked);
    });
});

    </script>
</body>
</html>

